<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel Borges 3.1</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f0f2f5;
            --text-color: #2c3e50;
            --header-height: 60px;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            padding-top: var(--header-height);
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .navbar-custom {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: var(--header-height);
        }

        /* --- CARDS DE PROJETO (AGRUPADOS) --- */
        .project-grid {
            display: grid;
            /* MOBILE: 2 Colunas lado a lado */
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
            padding: 10px;
        }
        @media(min-width: 768px) { .project-grid { grid-template-columns: repeat(4, 1fr); } }

        .project-card {
            min-height: 140px; /* Menor altura */
            border-radius: 12px;
            padding: 15px;
            color: white;
            position: relative;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            touch-action: none; /* Importante para arrastar no mobile */
        }
        
        .project-actions {
            position: absolute; top: 10px; right: 10px;
            z-index: 10;
        }

        /* Cores / Gradientes */
        .bg-grad-1 { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); }
        .bg-grad-2 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .bg-grad-3 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .bg-grad-4 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .bg-grad-5 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        /* --- KANBAN / TAREFAS --- */
        .task-card {
            background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px;
            border-left: 4px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .priority-urgent { border-left-color: #ff4757; background: #fff5f5; }
        .priority-medium { border-left-color: #ffa502; background: #fffffa; }
        .priority-low { border-left-color: #2ed573; background: #f0fff4; }

        /* --- IFRAME (Financeiro/Life) --- */
        .full-frame {
            position: fixed; top: var(--header-height); left: 0;
            width: 100vw; height: calc(100vh - var(--header-height));
            border: none; background: white; z-index: 50; display: none;
        }

        /* --- FAB --- */
        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px;
            background: #2c3e50; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 100; cursor: pointer;
        }

        /* --- LOGIN --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 5000; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="text-center p-4">
            <h1 class="mb-4">üöÄ</h1>
            <h3 class="mb-3">Painel Borges</h3>
            <button onclick="loginGoogle()" class="btn btn-dark w-100 py-2 rounded-pill shadow">
                Entrar com Google
            </button>
            <p id="loginError" class="text-danger mt-3 small"></p>
        </div>
    </div>

    <nav class="navbar navbar-custom fixed-top px-3 d-flex justify-content-between">
        <div class="d-flex align-items-center">
            <button id="backBtn" class="btn btn-sm btn-light rounded-circle me-2 shadow-sm" onclick="goHome()" style="display:none;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <span class="fw-bold" id="pageTitle">Central</span>
        </div>
        <button class="btn btn-link text-dark p-0" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
            <i class="fas fa-bars fa-lg"></i>
        </button>
    </nav>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="sidebarMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <button class="btn btn-light w-100 text-start mb-2" onclick="goHome()"><i class="fas fa-th-large me-2"></i> Projetos</button>
            <button class="btn btn-light w-100 text-start mb-2" onclick="openFrame('dashboard.html')"><i class="fas fa-chart-line me-2"></i> Financeiro</button>
            <button class="btn btn-light w-100 text-start mb-2" onclick="openFrame('life.html')"><i class="fas fa-dna me-2"></i> Life Co-Creation</button>
            <button class="btn btn-light w-100 text-start text-danger" onclick="openTrash()"><i class="fas fa-trash me-2"></i> Lixeira</button>
            <hr>
            <button class="btn btn-outline-danger w-100" onclick="logout()">Sair</button>
        </div>
    </div>

    <div id="view-projects" class="container mt-2">
        <div id="projectsContainer" class="project-grid">
            </div>
        <p class="text-center text-muted small mt-3">Segure e arraste para organizar</p>
    </div>

    <div id="view-kanban" class="container mt-2" style="display:none;">
        <input type="text" id="taskSearch" class="form-control mb-3 rounded-pill" placeholder="üîç Buscar..." onkeyup="filterTasks()">
        
        <div id="kanbanContainer">
            <div class="mb-3">
                <h6 class="text-danger small fw-bold">üî• URGENTE</h6>
                <div id="col-urgent" class="kanban-col min-vh-20" data-priority="urgent"></div>
            </div>
            <div class="mb-3">
                <h6 class="text-warning small fw-bold text-dark">‚ö†Ô∏è ATEN√á√ÉO</h6>
                <div id="col-medium" class="kanban-col min-vh-20" data-priority="medium"></div>
            </div>
            <div class="mb-3">
                <h6 class="text-success small fw-bold">‚úÖ NORMAL</h6>
                <div id="col-low" class="kanban-col min-vh-20" data-priority="low"></div>
            </div>
            <div class="mb-3">
                <h6 class="text-secondary small fw-bold">üìÅ ARQUIVO</h6>
                <div id="col-none" class="kanban-col min-vh-20" data-priority="none"></div>
            </div>
        </div>
    </div>

    <iframe id="appFrame" class="full-frame"></iframe>

    <div class="fab" onclick="handleFab()">
        <i class="fas fa-plus"></i>
    </div>

    <div class="modal fade" id="projectModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Projeto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="projId">
                    <input type="text" id="projTitle" class="form-control mb-3" placeholder="Nome do Projeto">
                    <select id="projType" class="form-select mb-3">
                        <option value="Pessoal">Pessoal</option>
                        <option value="Profissional">Profissional</option>
                    </select>
                    <p class="mb-1">Cor do Card:</p>
                    <div class="d-flex gap-2">
                        <div class="rounded-circle bg-grad-1 border" style="width:30px;height:30px;" onclick="setColor('bg-grad-1')"></div>
                        <div class="rounded-circle bg-grad-2 border" style="width:30px;height:30px;" onclick="setColor('bg-grad-2')"></div>
                        <div class="rounded-circle bg-grad-3 border" style="width:30px;height:30px;" onclick="setColor('bg-grad-3')"></div>
                        <div class="rounded-circle bg-grad-4 border" style="width:30px;height:30px;" onclick="setColor('bg-grad-4')"></div>
                        <div class="rounded-circle bg-grad-5 border" style="width:30px;height:30px;" onclick="setColor('bg-grad-5')"></div>
                    </div>
                    <input type="hidden" id="selectedColor" value="bg-grad-1">
                </div>
                <div class="modal-footer">
                    <button onclick="deleteProjectBtn()" class="btn btn-outline-danger me-auto" id="btnDelProj" style="display:none;">Excluir</button>
                    <button onclick="saveProject()" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="taskId">
                    <input type="text" id="taskTitle" class="form-control mb-2" placeholder="T√≠tulo">
                    <textarea id="taskDesc" class="form-control mb-3" rows="3" placeholder="Descri√ß√£o..."></textarea>
                    <select id="taskPriority" class="form-select">
                        <option value="urgent">Urgente</option>
                        <option value="medium">M√©dio</option>
                        <option value="low">Baixo</option>
                        <option value="none">Sem Classifica√ß√£o</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button onclick="deleteTaskBtn()" class="btn btn-danger">Excluir</button>
                    <button onclick="saveTask()" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="trashModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">Lixeira</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="trashList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnOexg7KChfV2OsKBCDCuMCRT2xcAwKx8",
            authDomain: "painel-financeiro-borges.firebaseapp.com",
            projectId: "painel-financeiro-borges",
            storageBucket: "painel-financeiro-borges.firebasestorage.app",
            messagingSenderId: "354997627208",
            appId: "1:354997627208:web:90604d0a7dcd45b6e4eb7d",
            measurementId: "G-KH9BDWN2WH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let activeProjectId = null;
        let currentView = 'projects';

        // AUTH
        window.loginGoogle = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { alert(e.message); }
        };
        window.logout = () => signOut(auth);
        
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                initProjects();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
            }
        });

        // NAVEGA√á√ÉO
        window.goHome = () => {
            activeProjectId = null;
            currentView = 'projects';
            document.getElementById('view-projects').style.display = 'block';
            document.getElementById('view-kanban').style.display = 'none';
            document.getElementById('appFrame').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('pageTitle').innerText = 'Central';
            bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu'))?.hide();
        };

        window.openProject = (id, title) => {
            activeProjectId = id;
            currentView = 'kanban';
            document.getElementById('view-projects').style.display = 'none';
            document.getElementById('view-kanban').style.display = 'block';
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('pageTitle').innerText = title;
            loadTasks(id);
        };

        window.openFrame = (url) => {
            currentView = 'iframe';
            const frame = document.getElementById('appFrame');
            // Verifica e carrega
            frame.src = url; 
            frame.style.display = 'block';
            document.getElementById('view-projects').style.display = 'none';
            document.getElementById('view-kanban').style.display = 'none';
            document.getElementById('backBtn').style.display = 'block';
            bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu'))?.hide();
        };

        // CRUD PROJETOS
        function initProjects() {
            const q = query(collection(db, `users/${currentUser.uid}/projects`), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('projectsContainer');
                container.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const el = document.createElement('div');
                    el.className = `project-card ${data.color}`;
                    el.setAttribute('data-id', d.id);
                    el.onclick = (e) => {
                        if(!e.target.closest('.btn-edit')) window.openProject(d.id, data.title);
                    };
                    el.innerHTML = `
                        <div class="project-actions">
                            <button class="btn btn-sm btn-light rounded-circle btn-edit" onclick="editProject('${d.id}', '${data.title}', '${data.type}', '${data.color}')"><i class="fas fa-pencil-alt"></i></button>
                        </div>
                        <span class="badge bg-white text-dark w-auto" style="width:fit-content">${data.type}</span>
                        <h5 class="fw-bold mt-2">${data.title}</h5>
                        <small class="mt-auto"><i class="fas fa-folder-open"></i> Abrir</small>
                    `;
                    container.appendChild(el);
                });
            });

            // Ativa Drag & Drop nos Projetos
            new Sortable(document.getElementById('projectsContainer'), {
                animation: 150, delay: 100, delayOnTouchOnly: true
            });
        }

        window.handleFab = () => {
            if(currentView === 'projects') openProjectModal();
            else if(currentView === 'kanban') openTaskModal();
        };

        // MODAL PROJETO (CRIAR/EDITAR)
        window.openProjectModal = () => {
            document.getElementById('projId').value = '';
            document.getElementById('projTitle').value = '';
            document.getElementById('btnDelProj').style.display = 'none';
            new bootstrap.Modal(document.getElementById('projectModal')).show();
        };

        window.editProject = (id, title, type, color) => {
            document.getElementById('projId').value = id;
            document.getElementById('projTitle').value = title;
            document.getElementById('projType').value = type;
            document.getElementById('selectedColor').value = color;
            document.getElementById('btnDelProj').style.display = 'block';
            new bootstrap.Modal(document.getElementById('projectModal')).show();
        };

        window.setColor = (c) => document.getElementById('selectedColor').value = c;

        window.saveProject = async () => {
            const id = document.getElementById('projId').value;
            const title = document.getElementById('projTitle').value;
            const type = document.getElementById('projType').value;
            const color = document.getElementById('selectedColor').value;
            
            if(!title) return;

            const data = { title, type, color, updatedAt: new Date() };

            if(id) {
                await updateDoc(doc(db, `users/${currentUser.uid}/projects`, id), data);
            } else {
                data.createdAt = new Date();
                await addDoc(collection(db, `users/${currentUser.uid}/projects`), data);
            }
            bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
        };

        window.deleteProjectBtn = async () => {
            const id = document.getElementById('projId').value;
            if(confirm('Excluir projeto e todas as tarefas dele?')) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/projects`, id));
                bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
                // (Opcional: Excluir subtarefas manualmente ou via Cloud Functions)
            }
        };

        // CRUD TAREFAS
        function loadTasks(projId) {
            const q = query(collection(db, `users/${currentUser.uid}/tasks`), where('projectId', '==', projId));
            onSnapshot(q, (snap) => {
                document.querySelectorAll('.kanban-col').forEach(c => c.innerHTML = '');
                snap.forEach(d => {
                    const t = d.data();
                    if(t.deleted) return;
                    
                    const el = document.createElement('div');
                    el.className = `task-card priority-${t.priority}`;
                    el.setAttribute('data-id', d.id);
                    el.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <strong>${t.title}</strong>
                            <i class="fas fa-pen text-muted ms-2" onclick="editTask('${d.id}', '${t.title}', '${t.desc}', '${t.priority}')"></i>
                        </div>
                        ${t.desc ? `<small class="text-muted text-truncate d-block">${t.desc}</small>` : ''}
                    `;
                    document.getElementById(`col-${t.priority}`).appendChild(el);
                });
            });
        }

        window.openTaskModal = () => {
            document.getElementById('taskId').value = '';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDesc').value = '';
            new bootstrap.Modal(document.getElementById('taskModal')).show();
        };

        window.editTask = (id, title, desc, priority) => {
            document.getElementById('taskId').value = id;
            document.getElementById('taskTitle').value = title;
            document.getElementById('taskDesc').value = (desc === 'undefined') ? '' : desc;
            document.getElementById('taskPriority').value = priority;
            new bootstrap.Modal(document.getElementById('taskModal')).show();
        };

        window.saveTask = async () => {
            const id = document.getElementById('taskId').value;
            const title = document.getElementById('taskTitle').value;
            const desc = document.getElementById('taskDesc').value;
            const priority = document.getElementById('taskPriority').value;

            const data = { title, desc, priority, projectId: activeProjectId, deleted: false, updatedAt: new Date() };

            if(id) await updateDoc(doc(db, `users/${currentUser.uid}/tasks`, id), data);
            else {
                data.createdAt = new Date();
                await addDoc(collection(db, `users/${currentUser.uid}/tasks`), data);
            }
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
        };

        window.deleteTaskBtn = async () => {
            const id = document.getElementById('taskId').value;
            await updateDoc(doc(db, `users/${currentUser.uid}/tasks`, id), { deleted: true });
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
        };

        // ARRASTAR TAREFAS
        ['urgent','medium','low','none'].forEach(p => {
            new Sortable(document.getElementById(`col-${p}`), {
                group: 'tasks', animation: 150, delay: 100, delayOnTouchOnly: true,
                onEnd: async (evt) => {
                    await updateDoc(doc(db, `users/${currentUser.uid}/tasks`, evt.item.getAttribute('data-id')), {
                        priority: evt.to.getAttribute('data-priority')
                    });
                }
            });
        });

        // LIXEIRA
        window.openTrash = () => {
            new bootstrap.Modal(document.getElementById('trashModal')).show();
            const q = query(collection(db, `users/${currentUser.uid}/tasks`), where('deleted', '==', true));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('trashList');
                list.innerHTML = '';
                snap.forEach(d => {
                    const t = d.data();
                    list.innerHTML += `<div class="p-2 border-bottom d-flex justify-content-between">
                        <span>${t.title}</span>
                        <button class="btn btn-sm btn-success" onclick="restore('${d.id}')">Restaurar</button>
                    </div>`;
                });
            });
        };
        window.restore = async (id) => await updateDoc(doc(db, `users/${currentUser.uid}/tasks`, id), { deleted: false });
    </script>
</body>
</html>
