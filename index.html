<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel Borges Participa√ß√µes e  Holding ‚Ä¢ Reservas ‚Ä¢ Investimentos</title>
<style>
/* ================= STYLES (mantive sua paleta de cores) ================= */
:root{
  --bg:#041022;
  --panel:#061021;
  --card:#071427;
  --muted:#9aa4b2;
  --accent:#1e88e5;
  --accent-2:#60a5fa;
  --success:#16a34a;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.03);
  --radius:12px;
  --shadow: 0 8px 24px rgba(2,6,23,0.55);
  --font: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --btn-ghost-border: rgba(255,255,255,0.10);
  --btn-ghost-bg: rgba(255,255,255,0.02);
  --btn-text: #e6eef8;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);background:linear-gradient(180deg,#041022 0%, #071827 100%);color:var(--btn-text)}
header{display:flex;gap:12px;align-items:center;padding:12px 18px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid rgba(255,255,255,0.02);position:sticky;top:0;z-index:30}
.brand{font-weight:900;color:var(--accent);font-size:18px}
.subtitle{color:var(--muted);font-size:13px;margin-left:6px}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tab{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;cursor:pointer;color:var(--btn-text)}
.tab.active{background:linear-gradient(90deg, rgba(30,136,229,0.12), rgba(96,165,250,0.04));border-color:rgba(30,136,229,0.2);font-weight:700}
.card{background:var(--panel);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);margin-top:12px;border:1px solid rgba(255,255,255,0.03)}
.row{display:flex;gap:12px;align-items:center}
.spacer{flex:1}
.small{font-size:13px;color:var(--muted)}
.grid{display:grid;gap:12px}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-2{grid-template-columns:repeat(2,1fr)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left;font-size:14px}
.input, textarea, select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--btn-text);width:100%}
.btn{
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  color: white;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  box-shadow: 0 6px 18px rgba(30,136,229,0.12);
}
.btn:hover{filter:brightness(1.03)}
.btn-ghost{
  background: var(--btn-ghost-bg);
  border:1px solid var(--btn-ghost-border);
  color: var(--btn-text);
  padding:7px 10px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.btn-ghost:hover{ background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.18) }
/* Bot√£o profissional para ocultar valores */
.btn-pro{
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--btn-text);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
/* Export btn refined */
.btn-export{
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--btn-text);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
.progress{height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
.bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
.badge{background:rgba(255,255,255,0.03);padding:6px;border-radius:6px;color:var(--muted);font-size:13px}
.kv{display:inline-block;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.02);margin-right:8px}
.checkbox-tri{width:22px;height:22px;border-radius:5px;border:1px solid rgba(255,255,255,0.08);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:var(--btn-ghost-bg);color:var(--btn-text);font-weight:700}
.modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;pointer-events:auto}
.modal-card{background:#061021;padding:16px;border-radius:12px;width:92%;max-width:720px;border:1px solid rgba(255,255,255,0.03);pointer-events:auto}
.note-tab{display:inline-block;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-right:6px;cursor:pointer;color:var(--btn-text)}
.note-tab.active{background:linear-gradient(90deg, rgba(30,136,229,0.12), rgba(96,165,250,0.04));font-weight:700}
.res-card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:grab}
.res-card.dragging{opacity:0.5;transform:scale(0.98)}
.icon{font-weight:900;margin-right:6px}
.alert-banner{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border-left:4px solid rgba(255,255,255,0.06);margin-top:10px;color:var(--muted)}
@media(max-width:900px){ .cols-3{grid-template-columns:1fr} .cols-2{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start} .topbar{gap:6px} }
canvas{width:100%;height:150px;background:transparent;border-radius:8px}
</style>
</head>
<body>

<header>
  <div>
    <div class="brand">Painel Borges Participa√ß√µes</div>
    <div class="subtitle">Holding ‚Ä¢ Reservas ‚Ä¢ Investimentos</div>
  </div>
  <div class="spacer"></div>
  <div class="small">Offline + Drive sync (API configurada)</div>
</header>

<div class="container">
  <div class="card topbar">
    <!-- TABS -->
    <div class="tab active" data-tab="dashboard">Dashboard</div>
    <div class="tab" data-tab="custo">Custo de Vida</div>
    <div class="tab" data-tab="planejamento">Planejamento Mensal</div>
    <div class="tab" data-tab="fluxo">Fluxo Di√°rio</div>
    <div class="tab" data-tab="reservas">Reservas</div>
    <div class="tab" data-tab="investimentos">Investimentos</div>
    <div class="tab" data-tab="caderno">Bloco de Notas</div>
    <div class="tab" data-tab="backup">Backup</div>

    <div class="spacer"></div>

    <button id="btnSeed" class="btn-ghost">Criar Padr√µes</button>
    <button id="btnSyncAll" class="btn">Sincronizar com Drive</button>
    <button id="btnHideValues" class="btn-pro">Ocultar Valores</button>
    <button id="btnExportNotes" class="btn-export">Exportar (Bloco de Notas)</button>
  </div>

  <!-- ============== DASHBOARD ============== -->
  <div id="dashboard" class="page card" style="margin-top:12px">
    <h2>Dashboard</h2>

    <div id="dash_alert" class="alert-banner" style="display:none"></div>

    <!-- TOP STATS -->
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Entradas</div>
        <div id="dash_entradas" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Lan√ßamentos: <span id="count_entradas">0</span></div>
      </div>
      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Sa√≠das</div>
        <div id="dash_saidas" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Lan√ßamentos: <span id="count_saidas">0</span></div>
      </div>
      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Resultado</div>
        <div id="dash_resultado" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Status: <span id="dash_result_status">‚Äî</span></div>
      </div>
    </div>
<!-- RESERVAS ‚Äî PROGRESSO GERAL -->
<div class="card" style="flex:1;min-width:220px;margin-top:12px">
  <div style="font-weight:600;margin-bottom:6px">Reservas ‚Äî total</div>
  <div id="dash_reservas_total" style="font-size:20px;font-weight:700">R$ 0,00</div>
  <div class="small">Quantidade de reservas: <span id="dash_reservas_count">0</span></div>

  <div style="margin-top:10px;font-weight:600">Progresso das reservas</div>
  <div class="progress" style="height:10px;margin-top:6px;background:#eee;border-radius:8px;overflow:hidden">
    <div id="reservas_progress_bar" class="bar" style="width:0%;background:#00c853;transition:width 0.4s ease"></div>
  </div>
  <div id="reservas_progress_text" class="small">0%</div>
</div>

    <!-- 1) CUSTO DE VIDA ATUAL -->
    <div class="card" id="dash_custo_card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small">Custo de Vida (m√™s)</div>
          <div id="dash_custo_total" style="font-weight:800;font-size:22px">R$ 0,00</div>
          <div class="small" id="dash_custo_month_label"></div>
        </div>
        <div style="width:320px">
          <canvas id="chartCustoTop" height="160"></canvas>
        </div>
      </div>
    </div>

    <!-- 2) FLUXO DE CAIXA MENSAL -->
    <div class="card" id="dash_fluxo_card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small">Fluxo de Caixa ‚Äî M√™s</div>
          <div style="display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <div class="kv"><div class="small">Entradas</div><div id="dash_fluxo_entries" style="font-weight:800">R$ 0,00</div></div>
            <div class="kv"><div class="small">Sa√≠das</div><div id="dash_fluxo_exits" style="font-weight:800">R$ 0,00</div></div>
            <div class="kv"><div class="small">Consolida√ß√£o</div><div id="dash_fluxo_net" style="font-weight:800">R$ 0,00</div></div>
          </div>
        </div>
        <div style="flex:1;max-width:680px">
          <canvas id="chartFluxMonthly" height="180"></canvas>
        </div>
      </div>
    </div>

    <!-- 3) PLANEJAMENTO MENSAL -->
    <div class="card" id="dash_plan_card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small">Planejamento Mensal ‚Äî Progresso</div>
          <div id="dash_plan_meta" style="font-weight:800;font-size:18px">Meta: R$ 0,00</div>
          <div id="dash_plan_done" class="small">Conclu√≠do: R$ 0,00</div>
          <div style="margin-top:8px" class="progress"><div id="dash_plan_bar" class="bar" style="width:0%"></div></div>
          <div style="margin-top:6px" class="small">Progresso: <span id="dash_plan_pct">0%</span></div>
        </div>
        <div style="width:240px">
          <canvas id="chartPlan" height="160"></canvas>
        </div>
      </div>
    </div>

    <!-- INVESTIMENTOS (Reservas removidas do resumo) -->
<div style="display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px">
  <div class="card">
    <div class="small">Investimentos ‚Äî total</div>
    <div id="dash_invest_total" style="font-weight:800;font-size:20px">R$ 0,00</div>
    <div class="small">Quantidade de ativos: <span id="dash_inv_count">0</span></div>
    <div style="margin-top:8px"><canvas id="chartInvCompSmall" height="140"></canvas></div>
  </div>
</div>

    <!-- √∫ltimas transa√ß√µes -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3 style="margin:0">√öltimas transa√ß√µes / lan√ßamentos</h3><div class="small">Transa√ß√µes recentes</div></div>
        <div class="small">Atualizado: <span id="dash_updated">-</span></div>
      </div>
      <div style="margin-top:8px;overflow:auto">
        <table class="table" id="dash_recent">
          <thead><tr><th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Valor</th></tr></thead>
          <tbody><tr><td colspan="4" class="small">Sem registros</td></tr></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- ============== CUSTO / PLANEJAMENTO / FLUXO / RESERVAS / INVESTIMENTOS / CADERNO / BACKUP ============== -->
  <!-- (preserve existing markup for these pages) -->
  <!-- CUSTO -->
  <div id="custo" class="page" style="display:none">
    <div class="card">
      <h2>Custo de Vida ‚Äî lan√ßamentos mensais</h2>
      <div class="small">Adicione seus custos mensais, por data e categoria. O gr√°fico mostra as categorias mais gastas.</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="cv_date" class="input" type="date"/>
        <input id="cv_desc" class="input" placeholder="Descri√ß√£o do custo"/>
        <select id="cv_cat" class="input">
          <option>Moradia</option><option>Alimenta√ß√£o</option><option>Transporte</option><option>Educa√ß√£o</option><option>Lazer</option><option>Outros</option>
        </select>
        <input id="cv_valor" class="input" type="number" placeholder="Valor (R$)"/>
        <button class="btn" onclick="addCusto()">Adicionar</button>
        <button class="btn-ghost" onclick="clearCustoMonth()">Limpar m√™s</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <div style="flex:1">
          <table class="table" id="custoTable">
            <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
            <tbody><tr><td colspan="5" class="small">Sem lan√ßamentos</td></tr></tbody>
          </table>
        </div>
        <div style="width:320px">
          <div class="small">Distribui√ß√£o por categoria (m√™s)</div>
          <canvas id="chartCusto" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- PLANEJAMENTO -->
  <div id="planejamento" class="page" style="display:none">
    <div class="card">
      <h2>Planejamento Mensal ‚Äî 3 per√≠odos</h2>
      <div class="small">Crie metas de faturamento por per√≠odo e adicione contas.</div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <select id="plan_mes" class="input"></select>
        <button class="btn" onclick="createPlanForMonth()">Criar/Carregar m√™s</button>
      </div>
      <div id="planPeriods" style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px"></div>
      <div style="margin-top:12px"><div class="small">Resumo do planejamento</div><div id="plan_summary" style="font-weight:700">Nenhum planejamento selecionado</div></div>
    </div>
  </div>

  <!-- FLUXO -->
  <div id="fluxo" class="page" style="display:none">
    <div class="card">
      <h2>Fluxo de Caixa Di√°rio</h2>
      <div class="small">Lance entradas e sa√≠das, escolha tipo de pagamento e veja o gr√°fico consolidado</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="fx_date" class="input" type="date"/>
        <input id="fx_desc" class="input" placeholder="Descri√ß√£o"/>
        <select id="fx_type" class="input"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select>
        <select id="fx_payment" class="input"><option>Dinheiro</option><option>Pix</option><option>Saldo conta</option><option>H√≠brido</option></select>
        <input id="fx_valor" class="input" type="number" placeholder="Valor (R$)"/>
        <button class="btn" onclick="addFluxo()">Registrar</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <table class="table" id="fluxoTable">
            <thead><tr><th>Data</th><th>Desc</th><th>Tipo</th><th>Pagamento</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
            <tbody><tr><td colspan="6" class="small">Sem lan√ßamentos</td></tr></tbody>
          </table>
        </div>
        <div style="width:340px">
          <div class="small">Consolida√ß√£o (√∫ltimos 12 dias)</div>
          <canvas id="chartFluxo" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- RESERVAS -->
  <div id="reservas" class="page" style="display:none">
<!-- Progresso das Reservas (removido visualmente) -->
<!-- <div style="margin-top:20px">
  <h3>Progresso das Reservas</h3>
  <div style="background:#eee;border-radius:10px;height:16px;overflow:hidden;">
    <div id="reservas_progress_bar" style="background:#00c853;width:0%;height:100%;transition:width 0.5s;"></div>
  </div>
  <div style="margin-top:6px;text-align:right;font-weight:bold;color:#333;">
    <span id="reservas_progress_text">0%</span>
  </div>
</div> -->

<div class="card">
      <h2>Reservas ‚Äî arraste para reorganizar</h2>
      <div class="small">Ordem recomendada nas abas Reservas</div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="r_name" class="input" placeholder="Nome da reserva (ex: Seguran√ßa)"/>
        <input id="r_meta" class="input" type="number" placeholder="Meta (R$)"/>
        <input id="r_init" class="input" type="number" placeholder="Valor Inicial (R$)"/>
        <button class="btn" onclick="addReservation()">Criar</button>
        <button class="btn-ghost" onclick="createDefaultReservas()">Criar Reservas Padr√£o</button>
      </div>

      <div id="resCards" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px"></div>

    </div>
  </div>

  <!-- INVESTIMENTOS -->
  <div id="investimentos" class="page" style="display:none">
    <div class="card">
      <h2>Investimentos ‚Äî composi√ß√£o e lan√ßamentos</h2>
      <div class="small">Adicione ativos, categorias e fa√ßa aportes/retiradas.</div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="inv_ativo" class="input" placeholder="Ativo (ex: Tesouro IPCA+ 2035)"/>
        <select id="inv_categoria" class="input">
          <option>Renda Fixa</option><option>A√ß√µes</option><option>FIIs</option><option>D√≥lar</option><option>Renda Fixa USA</option><option>Penny Stocks</option><option>Cripto</option>
        </select>
        <input id="inv_qtd" class="input" type="number" placeholder="Quantidade"/>
        <input id="inv_preco" class="input" type="number" placeholder="Pre√ßo unit√°rio"/>
        <button class="btn" onclick="addInvestment()">Adicionar</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px">
        <div style="flex:1">
          <table class="table" id="invTable">
            <thead><tr><th>Ativo</th><th>Categoria</th><th>Qtd</th><th>Pre√ßo</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
            <tbody><tr><td colspan="6" class="small">Nenhum investimento</td></tr></tbody>
          </table>
        </div>
        <div style="width:320px">
          <div class="small">Composi√ß√£o por categoria</div>
          <canvas id="chartInvComp" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- CADERNO -->
  <div id="caderno" class="page" style="display:none">
    <div class="card">
      <h2>Bloco de Notas ‚Äî abas tem√°ticas, blocos e itens</h2>
      <div class="small">Crie abas (temas), dentro crie blocos (sub-abas).</div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <input id="note_tab_name" class="input" placeholder="Nome da aba (ex: Financeiro)"/>
        <button class="btn" onclick="createNoteTab()">Criar Aba</button>
        <div class="spacer"></div>
        <button class="btn-ghost" onclick="exportCaderno()">Exportar Caderno</button>
      </div>

      <div id="noteTabs" style="margin-top:12px"></div>

      <div style="margin-top:12px" class="card">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="note_block_title" class="input" placeholder="T√≠tulo do bloco (sub-aba)"/>
          <button class="btn" onclick="addBlock()">Adicionar bloco</button>
        </div>
        <div id="noteBlocks" style="margin-top:12px"></div>
      </div>

    </div>
  </div>

  <!-- BACKUP -->
<div id="backup" class="page" style="display:none">
  <div class="card">
    <h2>Backup / Import / Export</h2>
    <div class="small">Exporta todo o painel (JSON) ou importa backup.</div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" onclick="exportAll()">Exportar Tudo (.json)</button>
      <input id="fileImport" type="file" accept=".json" style="background:transparent;color:var(--muted)"/>
      <button class="btn-ghost" onclick="importAll()">Importar Backup</button>
      <div class="spacer"></div>
      <div class="small">Drive API: <span id="apiUrlDisplay"></span></div>
    </div>

    <!-- Bot√£o adicional: Zerar Painel -->
    <div style="margin-top:20px;border-top:1px solid #ccc;padding-top:15px">
      <h3 style="margin-bottom:8px;color:#d50000">Restaura√ß√£o Total</h3>
      <p class="small" style="margin-bottom:8px;color:#555">
        ‚ö†Ô∏è Este bot√£o apaga todos os dados do painel (fluxo, reservas, investimentos, notas, etc.).
        A a√ß√£o √© irrevers√≠vel e exigir√° digitar <strong>ZERAR</strong> para confirmar.
      </p>
      <button class="btn" style="background:#d50000;color:#fff;font-weight:600" onclick="resetPainel()">üßπ Zerar Todos os Dados</button>
    </div>

  </div>
</div>

<!-- MODAL -->
<div id="modalEdit" style="display:none" class="modal">
  <div class="modal-card">
    <h3 id="modalTitle">Editar</h3>
    <div id="modalBody"></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn" onclick="confirmModal()">Salvar</button>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ================= CONFIG ================= */
const API_URL = "REPLACE_WITH_YOUR_APPS_SCRIPT_URL"; // <--- atualize com seu Apps Script ap√≥s deploy

/* ===== Estado Global ===== */
let state = {
  reservas: [],
  transacoes: [],
  investimentos: [],
  fluxo: [],
  custo: [],
  planejamento: {},
  caderno: [],
  settings: { hideValues: false }
};

/* ===== Utils ===== */
function uid(prefix='id'){ return prefix + '_' + Date.now() + '_' + Math.floor(Math.random()*9999); }
function moneyBRRaw(v){ return Number(v||0); }
function moneyBRFormatted(v){ return 'R$ ' + Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function el(q){ return document.querySelector(q); }
function els(q){ return Array.from(document.querySelectorAll(q)); }
function nowISO(){ return new Date().toISOString(); }

/* ===== Persistence ===== */
const STATE_KEY = 'borges_panel_3_v1';
function saveLocal(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); renderAll(); }
function loadLocal(){
  try{
    const raw = localStorage.getItem(STATE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      // merge with default keys
      state = Object.assign(state, parsed);
      if(!state.settings) state.settings = { hideValues:false };
    }
  }catch(e){ console.error('Erro parse local', e); }
}

/* ===== Format depending on hide values ===== */
function formatMoney(v){
  if(state && state.settings && state.settings.hideValues) return 'R$ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  return moneyBRFormatted(v);
}

/* ===== UI: tabs wiring (safe) ===== */
els('.tab').forEach(t=>t.addEventListener('click', (e)=>{
  els('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  els('.page').forEach(p=>p.style.display='none');
  const id = t.dataset.tab;
  const page = document.getElementById(id);
  if(page) page.style.display='block';
  renderAll();
}));

/* ===== Defaults & Helpers for Reservations ===== */
function createDefaultReservas(){
  const defaults = [
    {name:'Reserva de Seguran√ßa',meta:24000},
    {name:'Ve√≠culos',meta:3000},
    {name:'Roupas / Lazer / Levy',meta:1000},
    {name:'Gatona',meta:600},
    {name:'Reserva Levy 18 anos',meta:1000},
    {name:'Oportunidades',meta:5000},
    {name:'Terreno/Lexus Eventos',meta:50000},
    {name:'Apartamento',meta:20000},
    {name:'Dividas',meta:0}
  ];
  defaults.forEach((d,i)=>{
    if(!state.reservas.find(r=>r.name===d.name)){
      state.reservas.push({ id: uid('r'), name: d.name, meta: d.meta || 0, saldo: 0, order: i, obs:'', updated: nowISO() });
    }
  });
  reorderReservationsByDefault();
  saveLocal();
}
function reorderReservationsByDefault(){
  const priority = ['Reserva de Seguran√ßa','Ve√≠culos','Roupas / Lazer / Levy','Gatona','Reserva Levy 18 anos','Oportunidades','Terreno/Lexus Eventos','Apartamento','Dividas'];
  state.reservas.forEach(r=>{ if(r.order===undefined || r.order===null) r.order = priority.indexOf(r.name) !== -1 ? priority.indexOf(r.name) : 999; });
  state.reservas.sort((a,b)=> (a.order||999) - (b.order||999) );
}

/* ======= RESERVAS CRUD (mantive suas fun√ß√µes) ======= */
function addReservation(){
  const name = el('#r_name').value.trim();
  const meta = Number(el('#r_meta').value) || 0;
  const init = Number(el('#r_init').value) || 0;
  if(!name){ alert('Nome da reserva √© obrigat√≥rio'); return; }
  const id = uid('r');
  const maxOrder = state.reservas.reduce((m,x)=>Math.max(m,x.order||0),0);
  const r = { id, name, meta, saldo: init, order: maxOrder+1, obs:'', updated: nowISO() };
  state.reservas.push(r);
  if(init>0){
    state.transacoes.unshift({ id: uid('t'), date: nowISO(), reserva: name, tipo:'aporte', valor:init, nota:'Inicial' });
  }
  el('#r_name').value=''; el('#r_meta').value=''; el('#r_init').value='';
  saveLocal();
  renderReservations(); // Atualiza imediatamente a tela e o progresso
}

function renderReservations(){
  const container = el('#resCards'); if(!container) return;
  container.innerHTML='';
  state.reservas.sort((a,b)=> (a.order||0) - (b.order||0));

  if(!state.reservas.length){
    container.innerHTML = '<div class="small">Nenhuma reserva</div>';
    renderReservasProgress(); // Zera a barra se n√£o houver reservas
    return;
  }

  state.reservas.forEach(r=>{
    const pct = r.meta ? Math.round((r.saldo / r.meta) * 100) : 0;
    const card = document.createElement('div');
    card.className = 'res-card';
    card.setAttribute('draggable','true');
    card.dataset.id = r.id;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${r.name}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn-ghost" onclick="promptAporte(event,'${r.id}')">+ Aportar</button>
          <button class="btn-ghost" onclick="promptRetirar(event,'${r.id}')">- Retirar</button>
          <button class="btn-ghost" onclick="openEditReservation('${r.id}')">‚úé Editar</button>
          <button class="btn-ghost" onclick="removeReserva('${r.id}')">‚úñ Excluir</button>
        </div>
      </div>
      <div style="margin-top:8px" class="small">Meta: ${formatMoney(r.meta)}</div>
      <div style="margin-top:6px;font-weight:800">${formatMoney(r.saldo)}</div>
      <div style="margin-top:8px">
        <div class="progress"><div class="bar" style="width:${Math.min(100,pct)}%;transition:width 0.5s;background:${pct>=100 ? '#00c853' : pct>=50 ? '#ffd600' : '#d50000'};"></div></div>
        <div class="small">${pct}%</div>
      </div>
    `;
    card.addEventListener('dragstart', (ev)=>{ card.classList.add('dragging'); ev.dataTransfer.setData('text/plain', r.id); });
    card.addEventListener('dragend', ()=>{ card.classList.remove('dragging'); });
    card.addEventListener('dragover', (ev)=>{ ev.preventDefault(); });
    card.addEventListener('drop', (ev)=>{ ev.preventDefault(); const draggedId = ev.dataTransfer.getData('text/plain'); handleReservaDrop(draggedId, r.id); });
    container.appendChild(card);
  });

  renderReservasProgress(); // Atualiza a barra geral de progresso
}

function handleReservaDrop(draggedId, targetId){
  const dragged = state.reservas.find(r=>r.id===draggedId);
  const target = state.reservas.find(r=>r.id===targetId);
  if(!dragged || !target) return;
  dragged.order = (target.order || 0) - 0.5;
  state.reservas.sort((a,b)=> (a.order||0) - (b.order||0));
  state.reservas.forEach((r,i)=> r.order = i);
  saveLocal();
  renderReservations();
}

function promptAporte(ev, id){
  ev.stopPropagation();
  const v = Number(prompt('Valor do aporte R$','0')) || 0;
  if(v<=0) return;
  aporteReserva(id, v, 'Aporte manual');
}

function promptRetirar(ev, id){
  ev.stopPropagation();
  const v = Number(prompt('Valor da retirada R$','0')) || 0;
  if(v<=0) return;
  retirarReserva(id, v, 'Retirada manual');
}

function aporteReserva(id, valor, nota){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  r.saldo = Number(r.saldo||0) + Number(valor||0);
  r.updated = nowISO();
  state.transacoes.unshift({ id: uid('t'), date: nowISO(), reserva: r.name, tipo:'aporte', valor: Number(valor), nota: nota||'' });
  saveLocal();
  renderReservations();
}

function retirarReserva(id, valor, nota){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  r.saldo = Number(r.saldo||0) - Number(valor||0);
  r.updated = nowISO();
  state.transacoes.unshift({ id: uid('t'), date: nowISO(), reserva: r.name, tipo:'retirada', valor: Number(valor), nota: nota||'' });
  saveLocal();
  renderReservations();
}

function removeReserva(id){
  if(!confirm('Excluir reserva e hist√≥rico?')) return;
  const r = state.reservas.find(x=>x.id===id);
  state.reservas = state.reservas.filter(x=>x.id!==id);
  state.transacoes = state.transacoes.filter(t=>t.reserva !== (r? r.name : ''));
  saveLocal();
  renderReservations();
}

function openEditReservation(id){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  showModal('Editar Reserva', `
    <label>Nome</label><input id="modal_r_name" class="input" value="${r.name}"/>
    <label>Meta (R$)</label><input id="modal_r_meta" type="number" class="input" value="${r.meta}"/>
    <label>Saldo Atual (R$)</label><input id="modal_r_saldo" type="number" class="input" value="${r.saldo}"/>
    <label>Observa√ß√µes</label><textarea id="modal_r_obs" class="input">${r.obs||''}</textarea>
  `, function(){
    r.name = document.getElementById('modal_r_name').value.trim();
    r.meta = Number(document.getElementById('modal_r_meta').value) || 0;
    r.saldo = Number(document.getElementById('modal_r_saldo').value) || 0;
    r.obs = document.getElementById('modal_r_obs').value || '';
    r.updated = nowISO();
    saveLocal();
    renderReservations();
  });
}

/* ====== Progresso das Reservas ====== */
function renderReservasProgress() {
  const reservas = state.reservas || [];
  const bar = el('#reservas_progress_bar');
  const text = el('#reservas_progress_text');

  if (!reservas.length) {
    if (bar) bar.style.width = '0%';
    if (text) text.innerText = '0%';
    return;
  }

  const totalSaldo = reservas.reduce((s,r)=> s + Number(r.saldo||0), 0);
  const totalMeta  = reservas.reduce((s,r)=> s + Number(r.meta||0), 0);
  const pct = totalMeta > 0 ? Math.min(100, Math.round((totalSaldo / totalMeta) * 100)) : 0;

  if (bar) {
    bar.style.width = pct + '%';
    bar.style.background = pct>=100 ? '#00c853' : pct>=50 ? '#ffd600' : '#d50000';
  }
  if (text) text.innerText = pct + '%';
}

/* ====== INVESTIMENTOS ====== */
function addInvestment(){
  const name = el('#inv_ativo').value.trim();
  const cat = el('#inv_categoria').value;
  const qtd = Number(el('#inv_qtd').value) || 0;
  const preco = Number(el('#inv_preco').value) || 0;
  if(!name) { alert('Nome do ativo √© obrigat√≥rio'); return; }
  const inv = { id: uid('i'), ativo: name, categoria: cat, quantidade: qtd, preco: preco, updated: nowISO() };
  state.investimentos.push(inv);
  el('#inv_ativo').value=''; el('#inv_qtd').value=''; el('#inv_preco').value='';
  saveLocal();
}
function renderInvestments(){
  const tbody = el('#invTable tbody'); if(!tbody) return;
  tbody.innerHTML='';
  if(!state.investimentos.length){ tbody.innerHTML = '<tr><td colspan="6" class="small">Nenhum investimento</td></tr>'; return; }
  state.investimentos.forEach(it=>{
    const valor = (Number(it.quantidade||0) * Number(it.preco||0));
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.ativo}</td><td>${it.categoria}</td><td>${it.quantidade}</td><td>${formatMoney(it.preco)}</td><td>${formatMoney(valor)}</td>
      <td><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn-ghost" onclick="openEditInvestment('${it.id}')">Editar</button><button class="btn-ghost" onclick="removeInvestment('${it.id}')">Remover</button></div></td>`;
    tbody.appendChild(tr);
  });
}
function openEditInvestment(id){ const it = state.investimentos.find(x=>x.id===id); if(!it) return; showModal('Editar Investimento', `
    <label>Ativo</label><input id="modal_i_name" class="input" value="${it.ativo}"/>
    <label>Categoria</label><input id="modal_i_cat" class="input" value="${it.categoria}"/>
    <label>Quantidade</label><input id="modal_i_qtd" type="number" class="input" value="${it.quantidade}"/>
    <label>Pre√ßo Unit√°rio</label><input id="modal_i_preco" type="number" class="input" value="${it.preco}"/>
  `, function(){
    it.ativo = document.getElementById('modal_i_name').value;
    it.categoria = document.getElementById('modal_i_cat').value;
    it.quantidade = Number(document.getElementById('modal_i_qtd').value) || 0;
    it.preco = Number(document.getElementById('modal_i_preco').value) || 0;
    it.updated = nowISO();
    saveLocal();
  });
}
function removeInvestment(id){ if(!confirm('Remover investimento?')) return; state.investimentos = state.investimentos.filter(x=>x.id!==id); saveLocal(); }

/* ====== FLUXO DI√ÅRIO ====== */
function addFluxo(){
  const date = el('#fx_date').value || (new Date()).toISOString().slice(0,10);
  const desc = el('#fx_desc').value || '(sem descri√ß√£o)';
  const type = el('#fx_type').value; if (type !== 'entrada' && type !== 'saida') return alert('Selecione o tipo de lan√ßamento (entrada ou sa√≠da)');
  const payment = el('#fx_payment').value;
  const val = Number(el('#fx_valor').value) || 0;
  if(val <= 0) return alert('Valor deve ser maior que zero');
  const entry = { id: uid('f'), date: date, desc, type, payment, value: val };
  state.fluxo.unshift(entry);
  el('#fx_desc').value=''; el('#fx_valor').value=''; el('#fx_date').value='';
  saveLocal();
}
function renderFluxo(){
  const tbody = el('#fluxoTable tbody'); if(!tbody) return;
  tbody.innerHTML='';
  if(!state.fluxo.length){ tbody.innerHTML = '<tr><td colspan="6" class="small">Sem lan√ßamentos</td></tr>'; return; }
  state.fluxo.slice(0,200).forEach(f=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(f.date + 'T00:00:00').toLocaleDateString()}</td><td>${f.desc}</td><td>${f.type}</td><td>${f.payment}</td><td>${formatMoney(f.value)}</td>
      <td><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn-ghost" onclick="editFlux('${f.id}')">Editar</button><button class="btn-ghost" onclick="removeFlux('${f.id}')">Excluir</button></div></td>`;
    tbody.appendChild(tr);
  });
}
function editFlux(id){
  const f = state.fluxo.find(x=>x.id===id); if(!f) return;
  showModal('Editar Fluxo', `
    <label>Data</label><input id="modal_fx_date" class="input" type="date" value="${f.date}"/>
    <label>Descri√ß√£o</label><input id="modal_fx_desc" class="input" value="${f.desc}"/>
    <label>Tipo</label><select id="modal_fx_type" class="input"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select>
    <label>Pagamento</label><input id="modal_fx_payment" class="input" value="${f.payment}"/>
    <label>Valor</label><input id="modal_fx_valor" class="input" type="number" value="${f.value}"/>
  `, function(){
    f.date = document.getElementById('modal_fx_date').value || f.date;
    f.desc = document.getElementById('modal_fx_desc').value;
    f.type = document.getElementById('modal_fx_type').value;
    f.payment = document.getElementById('modal_fx_payment').value;
    f.value = Number(document.getElementById('modal_fx_valor').value) || 0;
    saveLocal();
  });
}
function removeFlux(id){ if(!confirm('Excluir lan√ßamento?')) return; state.fluxo = state.fluxo.filter(f => f.id !== id); saveLocal(); }

/* ====== CUSTO DE VIDA ====== */
function addCusto(){
  const date = el('#cv_date').value || (new Date()).toISOString().slice(0,10);
  const desc = el('#cv_desc').value || '(sem descri√ß√£o)';
  const cat = el('#cv_cat').value;
  const val = Number(el('#cv_valor').value) || 0;
  if(val <= 0) return alert('Valor deve ser maior que zero');
  state.custo.unshift({ id: uid('c'), date: date, desc, cat, value: val });
  state.transacoes.unshift({ id: uid('t'), date: nowISO(), reserva: 'Custo de Vida', tipo: 'saida', valor: val, nota: desc });
  el('#cv_desc').value=''; el('#cv_valor').value=''; el('#cv_date').value='';
  saveLocal();
}
function renderCusto(){
  const tbody = el('#custoTable tbody'); if(!tbody) return;
  tbody.innerHTML='';
  if(!state.custo.length){ tbody.innerHTML = '<tr><td colspan="5" class="small">Sem lan√ßamentos</td></tr>'; return; }
  const month = getSelectedMonthKey();
  const rows = state.custo.filter(c => { if(!month) return true; const y = c.date.slice(0,7); return y === month; });
  rows.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(c.date + 'T00:00:00').toLocaleDateString()}</td><td>${c.desc}</td><td>${c.cat}</td><td>${formatMoney(c.value)}</td>
      <td><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn-ghost" onclick="editCusto('${c.id}')">Editar</button><button class="btn-ghost" onclick="removeCusto('${c.id}')">Excluir</button></div></td>`;
    tbody.appendChild(tr);
  });
}
function editCusto(id){
  const c = state.custo.find(x=>x.id===id); if(!c) return;
  showModal('Editar Custo', `
    <label>Data</label><input id="modal_c_date" class="input" type="date" value="${c.date}"/>
    <label>Descri√ß√£o</label><input id="modal_c_desc" class="input" value="${c.desc}"/>
    <label>Categoria</label><input id="modal_c_cat" class="input" value="${c.cat}"/>
    <label>Valor</label><input id="modal_c_valor" class="input" type="number" value="${c.value}"/>
  `, function(){
    c.date = document.getElementById('modal_c_date').value || c.date;
    c.desc = document.getElementById('modal_c_desc').value;
    c.cat = document.getElementById('modal_c_cat').value;
    c.value = Number(document.getElementById('modal_c_valor').value) || 0;
    saveLocal();
  });
}
function removeCusto(id){ if(!confirm('Excluir custo?')) return; state.custo = state.custo.filter(x=>x.id!==id); saveLocal(); }
function clearCustoMonth(){ const month = getSelectedMonthKey(); if(!month) return alert('Selecione um m√™s no planejamento para aplicar a filtragem mensal.'); if(!confirm('Remover todos os custos do m√™s ' + month + '?')) return; state.custo = state.custo.filter(c => c.date.slice(0,7) !== month); saveLocal(); }

/* ====== PLANEJAMENTO (mantive) ====== */
function getMonthOptions(){
  const sel = el('#plan_mes'); if(!sel) return;
  sel.innerHTML='';
  const today = new Date();
  for(let i=0;i<12;i++){
    const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
    const key = d.toISOString().slice(0,7);
    const opt = document.createElement('option'); opt.value = key; opt.innerText = key;
    sel.appendChild(opt);
  }
}
function createPlanForMonth(){ const key = getSelectedMonthKey(); if(!key) return alert('Selecione um m√™s'); if(!state.planejamento[key]) { state.planejamento[key] = { periods: { p1:{meta:0,items:[]}, p2:{meta:0,items:[]}, p3:{meta:0,items:[]} } }; } renderPlanForMonth(key); }
function getSelectedMonthKey(){ return el('#plan_mes') ? el('#plan_mes').value || null : null; }
function renderPlanForMonth(key){
  const container = el('#planPeriods'); if(!container) return;
  container.innerHTML='';
  const p = state.planejamento[key].periods;
  const labels = ['Dia 01 - 10','Dia 11 - 20','Dia 21 - 30'];
  ['p1','p2','p3'].forEach((pid,idx)=>{
    const box = document.createElement('div'); box.className='card';
    box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${labels[idx]}</strong>
      <div><input id="meta_${pid}" class="input" type="number" placeholder="Meta faturamento" value="${p[pid].meta || 0}" style="width:180px"/></div></div>
      <div style="margin-top:8px"><button class="btn" onclick="addPlanItem('${key}','${pid}')">+ Conta</button> <button class="btn-ghost" onclick="clearPlanPeriod('${key}','${pid}')">Limpar</button></div>
      <div id="items_${pid}" style="margin-top:8px"></div>`;
    container.appendChild(box);
    renderPlanItems(key, pid);
    setTimeout(()=>{ const elMeta = document.getElementById('meta_'+pid); if(elMeta) elMeta.addEventListener('change', (e)=>{ p[pid].meta = Number(e.target.value)||0; saveLocal(); renderPlanSummary(key); }); }, 100);
  });
  renderPlanSummary(key);
}
function addPlanItem(monthKey, pid){ const desc = prompt('Descri√ß√£o da conta (ex: Cons√≥rcio)'); if(!desc) return; let input = prompt('Valor (R$)','0');
if (!input) return;

input = input.replace(/\./g, '').replace(',', '.'); 
// remove pontos e troca v√≠rgula por ponto

const val = parseFloat(input) || 0; const item = { id: uid('pl'), desc, value: val, state:0 }; state.planejamento[monthKey].periods[pid].items.push(item); saveLocal(); renderPlanItems(monthKey, pid); renderPlanSummary(monthKey); }
function renderPlanItems(monthKey, pid){ const itemsDiv = el('#items_'+pid); if(!itemsDiv) return; itemsDiv.innerHTML = ''; const items = state.planejamento[monthKey].periods[pid].items || []; items.forEach(it=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.style.padding='6px 0'; row.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div class="checkbox-tri" onclick="togglePlanItem('${monthKey}','${pid}','${it.id}')">${it.state===1?'‚úî':(it.state===2?'‚úñ':'')}</div><div>${it.desc} ‚Äî <span class="small">${formatMoney(it.value)}</span></div></div>
      <div><button class="btn-ghost" onclick="editPlanItem('${monthKey}','${pid}','${it.id}')">Editar</button> <button class="btn-ghost" onclick="removePlanItem('${monthKey}','${pid}','${it.id}')">Excluir</button></div>`; itemsDiv.appendChild(row); }); }
function togglePlanItem(monthKey,pid,itemId){ const it = state.planejamento[monthKey].periods[pid].items.find(x=>x.id===itemId); if(!it) return; it.state = (it.state + 1) % 3; saveLocal(); renderPlanItems(monthKey,pid); renderPlanSummary(monthKey); }
function editPlanItem(monthKey,pid,itemId){ const it = state.planejamento[monthKey].periods[pid].items.find(x=>x.id===itemId); if(!it) return; const nd = prompt('Descri√ß√£o', it.desc); if(nd===null) return; const nv = Number(prompt('Valor', it.value)) || 0; it.desc = nd; it.value = nv; saveLocal(); renderPlanItems(monthKey,pid); renderPlanSummary(monthKey); }
function removePlanItem(monthKey,pid,itemId){ if(!confirm('Remover item?')) return; const arr = state.planejamento[monthKey].periods[pid].items; state.planejamento[monthKey].periods[pid].items = arr.filter(x=>x.id!==itemId); saveLocal(); renderPlanItems(monthKey,pid); renderPlanSummary(monthKey); }
function clearPlanPeriod(monthKey,pid){ if(!confirm('Limpar per√≠odo?')) return; state.planejamento[monthKey].periods[pid].items = []; saveLocal(); renderPlanItems(monthKey,pid); renderPlanSummary(monthKey); }
function renderPlanSummary(key){ if(!key){ el('#plan_summary').innerText = 'Nenhum planejamento selecionado'; return; } const p = state.planejamento[key].periods; const totalMeta = (p.p1.meta||0) + (p.p2.meta||0) + (p.p3.meta||0); const totalDue = (p.p1.items||[]).reduce((s,i)=>s+i.value,0) + (p.p2.items||[]).reduce((s,i)=>s+i.value,0) + (p.p3.items||[]).reduce((s,i)=>s+i.value,0); el('#plan_summary').innerText = `Meta (soma 3 per√≠odos): ${formatMoney(totalMeta)} ‚Äî Total Contas: ${formatMoney(totalDue)}`; }

/* ====== CADERNO (notas) ====== */
function createNoteTab(){
  const name = el('#note_tab_name').value.trim(); if(!name) return alert('Nome da aba √© necess√°rio');
  const tab = { id: uid('nt'), name, blocks: [] };
  state.caderno.push(tab); el('#note_tab_name').value=''; saveLocal(); renderNoteTabs();
  setTimeout(()=>{ const tabs = document.querySelectorAll('#noteTabs .note-tab'); tabs.forEach(t=>{ if(t.dataset.id===tab.id){ t.classList.add('active'); } else t.classList.remove('active'); }); renderNoteBlocks(tab.id); }, 50);
}
function renderNoteTabs(){
  const container = el('#noteTabs'); if(!container) return;
  container.innerHTML='';
  if(!state.caderno.length) { container.innerHTML = '<div class="small">Nenhuma aba criada</div>'; return; }
  state.caderno.forEach((t, idx)=>{
    const div = document.createElement('div'); div.className='note-tab'; div.dataset.id = t.id;
    div.innerHTML = `<span style="margin-right:8px">${t.name}</span><button class="btn-ghost" onclick="editNoteTab('${t.id}')">‚úé</button><button class="btn-ghost" onclick="removeNoteTab('${t.id}')">‚úñ</button>`;
    div.onclick = (ev)=>{ if(ev.target.tagName==='BUTTON') return; els('.note-tab').forEach(x=>x.classList.remove('active')); div.classList.add('active'); renderNoteBlocks(t.id); };
    div.setAttribute('draggable','true');
    div.addEventListener('dragstart',(e)=> e.dataTransfer.setData('text/plain', t.id));
    div.addEventListener('dragover',(e)=> e.preventDefault());
    div.addEventListener('drop',(e)=> { e.preventDefault(); const dragged = e.dataTransfer.getData('text/plain'); reorderNoteTabs(dragged, t.id);});
    container.appendChild(div);
  });
}
function editNoteTab(tabId){ const t = state.caderno.find(x=>x.id===tabId); if(!t) return; const newName = prompt('Renomear aba', t.name); if(newName===null) return; t.name = newName.trim() || t.name; saveLocal(); renderNoteTabs(); renderNoteBlocks(t.id); }
function removeNoteTab(tabId){ if(!confirm('Remover aba e todos os blocos nela?')) return; state.caderno = state.caderno.filter(x=>x.id!==tabId); saveLocal(); renderNoteTabs(); el('#noteBlocks').innerHTML=''; }
function reorderNoteTabs(draggedId, targetId){ const idxD = state.caderno.findIndex(x=>x.id===draggedId); const idxT = state.caderno.findIndex(x=>x.id===targetId); if(idxD==-1||idxT==-1) return; const [item] = state.caderno.splice(idxD,1); state.caderno.splice(idxT,0,item); saveLocal(); renderNoteTabs(); }
function addBlock(){ const title = el('#note_block_title').value.trim(); if(!title) return alert('Insira t√≠tulo do bloco'); const activeEl = document.querySelector('.note-tab.active'); if(!activeEl) return alert('Selecione uma aba primeiro'); const tab = state.caderno.find(t=>t.id===activeEl.dataset.id); if(!tab) return; tab.blocks.push({ id: uid('b'), title, items: [] }); el('#note_block_title').value=''; saveLocal(); renderNoteBlocks(tab.id); }
function renderNoteBlocks(tabId){ const tab = state.caderno.find(t=>t.id===tabId); if(!tab){ el('#noteBlocks').innerHTML=''; return; } const container = el('#noteBlocks'); container.innerHTML=''; tab.blocks.forEach(block=>{ const box = document.createElement('div'); box.className='card'; box.style.marginBottom='10px'; box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${block.title}</strong>
      <div><button class="btn-ghost" onclick="addItemPrompt('${tab.id}','${block.id}')">+ Item</button> <button class="btn-ghost" onclick="removeBlock('${tab.id}','${block.id}')">Excluir bloco</button></div></div>
      <div id="items_${block.id}" style="margin-top:8px"></div>`; box.setAttribute('draggable','true'); box.addEventListener('dragstart',(e)=> e.dataTransfer.setData('text/plain', JSON.stringify({tab:tab.id, block:block.id}))); box.addEventListener('dragover',(e)=> e.preventDefault()); box.addEventListener('drop',(e)=> { e.preventDefault(); const data = JSON.parse(e.dataTransfer.getData('text/plain')); reorderBlocks(data.tab, data.block, tab.id, block.id); }); container.appendChild(box); renderItems(tab.id, block.id); }); }
function reorderBlocks(srcTabId, srcBlockId, tgtTabId, tgtBlockId){ const srcTab = state.caderno.find(t=>t.id===srcTabId); const tgtTab = state.caderno.find(t=>t.id===tgtTabId); if(!srcTab||!tgtTab) return; const bi = srcTab.blocks.findIndex(b=>b.id===srcBlockId); const [block] = srcTab.blocks.splice(bi,1); const ti = tgtTab.blocks.findIndex(b=>b.id===tgtBlockId); tgtTab.blocks.splice(ti,0,block); saveLocal(); renderNoteTabs(); renderNoteBlocks(tgtTab.id); }
function addItemPrompt(tabId, blockId){ const text = prompt('Descri√ß√£o do item (aceita emojis)'); if(!text) return; const tab = state.caderno.find(t=>t.id===tabId); const block = tab.blocks.find(b=>b.id===blockId); block.items.push({ id: uid('it'), text, state:0 }); saveLocal(); renderItems(tabId, blockId); }
function renderItems(tabId, blockId){ const tab = state.caderno.find(t=>t.id===tabId); if(!tab) return; const block = tab.blocks.find(b=>b.id===blockId); if(!block) return; const container = el('#items_'+block.id); if(!container) return; container.innerHTML=''; block.items.forEach(it=>{ const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.style.padding='6px 0'; row.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div class="checkbox-tri" onclick="toggleItemState('${tabId}','${blockId}','${it.id}')">${it.state===1?'‚úî':(it.state===2?'‚úñ':'')}</div><div>${it.text}</div></div>
      <div><button class="btn-ghost" onclick="editItem('${tabId}','${blockId}','${it.id}')">Editar</button> <button class="btn-ghost" onclick="removeItem('${tabId}','${blockId}','${it.id}')">Excluir</button></div>`; container.appendChild(row); }); }
function toggleItemState(tabId,blockId,itemId){ const it = state.caderno.find(t=>t.id===tabId).blocks.find(b=>b.id===blockId).items.find(i=>i.id===itemId); if(!it) return; it.state = (it.state + 1) % 3; saveLocal(); renderItems(tabId,blockId); }
function editItem(tabId,blockId,itemId){ const it = state.caderno.find(t=>t.id===tabId).blocks.find(b=>b.id===blockId).items.find(i=>i.id===itemId); const txt = prompt('Editar item', it.text); if(txt===null) return; it.text = txt; saveLocal(); renderItems(tabId,blockId); }
function removeItem(tabId,blockId,itemId){ if(!confirm('Remover item?')) return; const block = state.caderno.find(t=>t.id===tabId).blocks.find(b=>b.id===blockId); block.items = block.items.filter(i=>i.id!==itemId); saveLocal(); renderItems(tabId,blockId); }
function removeBlock(tabId, blockId){ if(!confirm('Remover bloco?')) return; const tab = state.caderno.find(t=>t.id===tabId); tab.blocks = tab.blocks.filter(b=>b.id!==blockId); saveLocal(); renderNoteBlocks(tabId); }

/* ===== MODAL ===== */
let modalCallback = null;
function showModal(title, htmlContent, callback){
  el('#modalTitle').innerText = title; el('#modalBody').innerHTML = htmlContent;
  el('#modalEdit').style.display = 'flex'; modalCallback = callback;
}
function closeModal(){ el('#modalEdit').style.display = 'none'; modalCallback = null; }
function confirmModal(){ if(modalCallback) modalCallback(); closeModal(); }

/* ===== BACKUP / IMPORT / EXPORT ===== */
function exportAll() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'borges_backup_' + new Date().toISOString().slice(0, 10) + '.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importAll() {
  const f = el('#fileImport').files[0];
  if (!f) return alert('Escolha um arquivo JSON');

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result);
      state = parsed;
      if (!state.settings) state.settings = { hideValues: false };
      saveLocal();
      alert('‚úÖ Backup importado com sucesso!');
    } catch (err) {
      alert('‚ùå Arquivo inv√°lido.');
    }
  };
  reader.readAsText(f);
}

/* ===== RESET TOTAL DO PAINEL (com dupla confirma√ß√£o) ===== */
function resetPainel() {
  const confirmar = confirm("‚ö†Ô∏è Tem certeza que deseja apagar TODOS os dados do painel?\nEssa a√ß√£o n√£o pode ser desfeita!");
  if (!confirmar) return;

  const validacao = prompt("Para confirmar, digite a palavra: ZERAR");
  if (validacao !== "ZERAR") {
    alert("‚ùå Cancelado. Nenhum dado foi apagado.");
    return;
  }

  // Limpa completamente o armazenamento local
  localStorage.clear();

  alert("‚úÖ Painel zerado com sucesso!");
  location.reload(); // recarrega o painel limpo
}


/* ===== DRIVE SYNC (client stub) ===== */
async function postToDrive(payload){
  if(!API_URL || API_URL.includes('REPLACE_WITH')) return alert('API_URL n√£o configurada. Atualize o campo API_URL no c√≥digo com a URL do Apps Script.');
  try{
    const res = await fetch(API_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
    const json = await res.json();
    return json;
  } catch(err){ console.error('drive post err',err); alert('Erro ao conectar com Drive: ' + err.message + '\nDICA: abra o arquivo via servidor local (http://localhost) para evitar bloqueios CORS.'); return null; }
}
async function syncAllToDrive(){
  if(!confirm('Sincronizar TODO o painel com Drive (sobrescrever√° as abas no Drive)?')) return;
  const reservasData = [['Nome','Meta','Saldo','Obs','Updated']];
  state.reservas.forEach(r => reservasData.push([r.name, r.meta, r.saldo, r.obs||'', r.updated||'']));
  const transacoesData = [['Date','Reserva','Tipo','Valor','Nota']];
  state.transacoes.forEach(t => transacoesData.push([t.date, t.reserva, t.tipo, t.valor, t.nota||'']));
  const invData = [['Ativo','Categoria','Qtd','Preco','Updated']];
  state.investimentos.forEach(i => invData.push([i.ativo,i.categoria,i.quantidade,i.preco,i.updated||'']));
  const fluxoData = [['Date','Desc','Tipo','Pagamento','Valor']];
  state.fluxo.forEach(f => fluxoData.push([f.date,f.desc,f.type,f.payment,f.value]));
  const custoData = [['Date','Desc','Categoria','Valor']];
  state.custo.forEach(c => custoData.push([c.date,c.desc,c.cat,c.value]));
  await postToDrive({ action:'save', sheet: 'Reservas', data: reservasData, clearBeforeSave:true });
  await postToDrive({ action:'save', sheet: 'Transacoes', data: transacoesData, clearBeforeSave:true });
  await postToDrive({ action:'save', sheet: 'Investimentos', data: invData, clearBeforeSave:true });
  await postToDrive({ action:'save', sheet: 'Fluxo', data: fluxoData, clearBeforeSave:true });
  await postToDrive({ action:'save', sheet: 'Custo', data: custoData, clearBeforeSave:true });
  alert('Sincroniza√ß√£o solicitada. Verifique a planilha no Drive.');
}

/* ===== Charts helpers (Chart.js usage kept) ===== */
let chartFluxMonthly = null;
let chartCustoTop = null;
let chartPlan = null;
let chartInvCompSmall = null;

function monthKeyFromDateString(d) { return d && d.length>=7 ? d.slice(0,7) : (new Date()).toISOString().slice(0,7); }

function computeFluxoMonthly(monthKey) {
  const entriesByDay = {}; const exitsByDay = {};
  for(const f of state.fluxo){
    if(!f.date) continue;
    if(f.date.slice(0,7) !== monthKey) continue;
    const day = Number(f.date.slice(8,10));
    if(f.type === 'entrada') entriesByDay[day] = (entriesByDay[day]||0) + Number(f.value||0);
    else exitsByDay[day] = (exitsByDay[day]||0) + Number(f.value||0);
  }
  const maxDay = Math.max(...Object.keys(entriesByDay).map(Number).concat(Object.keys(exitsByDay).map(Number)).concat([30]));
  const labels = []; const entriesArr = []; const exitsArr = [];
  let totalEntries = 0, totalExits = 0;
  for(let d=1; d<=maxDay; d++){
    labels.push(String(d).padStart(2,'0'));
    const e = entriesByDay[d]||0; const s = exitsByDay[d]||0;
    entriesArr.push(e); exitsArr.push(s);
    totalEntries += e; totalExits += s;
  }
  const net = totalEntries - totalExits;
  return { labels, entriesArr, exitsArr, totalEntries, totalExits, net };
}

function computeCustoByCategory(monthKey){
  const cats = {};
  for(const c of state.custo){
    if(!c.date) continue;
    if(c.date.slice(0,7) !== monthKey) continue;
    cats[c.cat] = (cats[c.cat]||0) + Number(c.value||0);
  }
  const labels = Object.keys(cats); const values = labels.map(l=>cats[l]); const total = values.reduce((a,b)=>a+b,0);
  return { labels, values, total, cats };
}

function computePlanProgress(monthKey){
  if(!monthKey || !state.planejamento[monthKey]) return { meta:0, done:0, pct:0 };
  const p = state.planejamento[monthKey].periods;
  const meta = (p.p1.meta||0) + (p.p2.meta||0) + (p.p3.meta||0);
  const done = (p.p1.items||[]).reduce((s,i)=> s + (i.state===1? i.value : 0), 0)
             + (p.p2.items||[]).reduce((s,i)=> s + (i.state===1? i.value : 0), 0)
             + (p.p3.items||[]).reduce((s,i)=> s + (i.state===1? i.value : 0), 0);
  const pct = meta ? Math.round((done / meta) * 100) : 0;
  return { meta, done, pct };
}

/* ====== Dashboard render + summary computations ====== */
function computeResumoFinanceiro(monthKey){
  // Entradas: transacoes tipo 'entrada' + fluxo type 'entrada'
  const entradasFromTrans = (state.transacoes||[]).filter(t=> (t.tipo==='entrada' || t.tipo==='aporte')).reduce((s,t)=>s+Number(t.valor||0),0);
  const entradasFromFluxo = (state.fluxo||[]).filter(f=> f.type==='entrada').reduce((s,f)=>s+Number(f.value||0),0);
  const totalEntradas = entradasFromTrans + entradasFromFluxo;
  // Sa√≠das
  const saidasFromTrans = (state.transacoes||[]).filter(t=> t.tipo==='saida' || t.tipo==='retirada').reduce((s,t)=>s+Number(t.valor||0),0);
  const saidasFromFluxo = (state.fluxo||[]).filter(f=> f.type==='saida').reduce((s,f)=>s+Number(f.value||0),0);
  const saidasFromCusto = (state.custo||[]).reduce((s,c)=>s+Number(c.value||0),0);
  const totalSaidas = saidasFromTrans + saidasFromFluxo;
// Removido saidasFromCusto para n√£o duplicar custo de vida
  // Reservas total (saldo)
  const reservasTotal = (state.reservas||[]).reduce((s,r)=> s + Number(r.saldo||0), 0);
  // Investimentos total (quantidade * preco)
  const investimentosTotal = (state.investimentos||[]).reduce((s,i)=> s + (Number(i.quantidade||0) * Number(i.preco||0)), 0);
  const resultado = totalEntradas - totalSaidas;
  return { totalEntradas, totalSaidas, resultado, reservasTotal, investimentosTotal };
}

/* ====== Render Dashboard (Chart.js) ====== */
function renderDashboard(){
  const monthKey = getSelectedMonthKey() || new Date().toISOString().slice(0,7);

  // resumo financeiro
  const resumo = computeResumoFinanceiro(monthKey);
  el('#dash_entradas').innerText = formatMoney(resumo.totalEntradas || 0);
  el('#dash_saidas').innerText = formatMoney(resumo.totalSaidas || 0);
  el('#dash_resultado').innerText = formatMoney(resumo.resultado || 0);
  el('#dash_result_status').innerText = resumo.resultado >= 0 ? 'Positivo' : 'Negativo';

  // reservas & investimentos
  el('#dash_reservas_total').innerText = formatMoney(resumo.reservasTotal || 0);
  el('#dash_reservas_count').innerText = (state.reservas||[]).length;
  el('#dash_invest_total').innerText = formatMoney(resumo.investimentosTotal || 0);
  el('#dash_inv_count').innerText = (state.investimentos||[]).length;

  // alerta custo de vida
  const custoRes = computeCustoByCategory(monthKey);
  el('#dash_custo_total').innerText = formatMoney(custoRes.total || 0);
  el('#dash_custo_month_label').innerText = monthKey;
  const alertEl = el('#dash_alert');
  if(custoRes.total > resumo.totalEntradas){
    alertEl.style.display = 'block';
    alertEl.innerText = 'Alerta: seu custo de vida atual ultrapassa as entradas. Revise despesas.';
    alertEl.style.borderLeft = '4px solid var(--danger)';
  } else {
    if(custoRes.total === 0) alertEl.style.display = 'none';
    else { alertEl.style.display = 'block'; alertEl.innerText = 'Seu custo de vida est√° dentro da margem.'; alertEl.style.borderLeft = '4px solid var(--success)'; }
  }

  // Charts: custo (doughnut)
  if(chartCustoTop){ chartCustoTop.destroy(); chartCustoTop = null; }
  try{
    const ctxC = document.getElementById('chartCustoTop').getContext('2d');
    chartCustoTop = new Chart(ctxC, {
      type:'doughnut',
      data:{ labels: custoRes.labels.length ? custoRes.labels : ['Sem dados'], datasets:[{ data: custoRes.values.length ? custoRes.values : [1], backgroundColor:['#60a5fa','#1e88e5','#16a34a','#f59e0b','#ef4444','#7c3aed','#0ea5a4'] }]},
      options:{ maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color:'#e6eef8' } } } }
    });
  }catch(e){/*silent*/}

  // Fluxo mensal chart
  const fluxoRes = computeFluxoMonthly(monthKey);
  el('#dash_fluxo_entries').innerText = formatMoney(fluxoRes.totalEntries || 0);
  el('#dash_fluxo_exits').innerText = formatMoney(fluxoRes.totalExits || 0);
  el('#dash_fluxo_net').innerText = formatMoney(fluxoRes.net || 0);
  el('#dash_fluxo_net').style.color = (fluxoRes.net >= 0) ? 'var(--success)' : 'var(--danger)';
  if(chartFluxMonthly){ chartFluxMonthly.destroy(); chartFluxMonthly = null; }
  try{
    const ctxF = document.getElementById('chartFluxMonthly').getContext('2d');
    chartFluxMonthly = new Chart(ctxF, {
      type:'bar',
      data:{ labels:fluxoRes.labels, datasets:[ { label:'Entradas', data:fluxoRes.entriesArr, backgroundColor:'#16a34a' }, { label:'Sa√≠das', data:fluxoRes.exitsArr, backgroundColor:'#ef4444' } ]},
      options:{ maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#e6eef8' } }, y:{ ticks:{ color:'#e6eef8' } } }, plugins:{ legend:{ labels:{ color:'#e6eef8' } } } }
    });
  }catch(e){/*silent*/}

  // Plan small chart (donut)
  const planRes = computePlanProgress(monthKey);
  el('#dash_plan_meta').innerText = `Meta: ${formatMoney(planRes.meta || 0)}`;
  el('#dash_plan_done').innerText = `Conclu√≠do: ${formatMoney(planRes.done || 0)}`;
  const pct = Math.min(100, Math.max(0, planRes.pct || 0));
  el('#dash_plan_bar').style.width = pct + '%';
  el('#dash_plan_pct').innerText = pct + '%';
  if(chartPlan){ chartPlan.destroy(); chartPlan = null; }
  try{
    const ctxP = document.getElementById('chartPlan').getContext('2d');
    const rem = Math.max(0, (planRes.meta || 0) - (planRes.done || 0));
    chartPlan = new Chart(ctxP, { type:'doughnut', data:{ labels:['Conclu√≠do','Restante'], datasets:[{ data:[planRes.done || 0, rem], backgroundColor:['#60a5fa','#374151'] }] }, options:{ maintainAspectRatio:false, plugins:{ legend:{ display:false } } } });
  }catch(e){/*silent*/}

  // Invest composition small chart
  try{
    const cats = {};
    state.investimentos.forEach(it=>{ const v = (Number(it.quantidade||0) * Number(it.preco||0)); cats[it.categoria] = (cats[it.categoria]||0) + v; });
    const labels = Object.keys(cats); const values = labels.map(l=>cats[l]);
    if(chartInvCompSmall){ chartInvCompSmall.destroy(); chartInvCompSmall = null; }
    const ctxI = document.getElementById('chartInvCompSmall') && document.getElementById('chartInvCompSmall').getContext('2d');
    if(ctxI){
      chartInvCompSmall = new Chart(ctxI, { type:'doughnut', data:{ labels: labels.length?labels:['Sem dados'], datasets:[{ data: values.length?values:[1], backgroundColor:['#60a5fa','#1e88e5','#16a34a','#f59e0b','#ef4444'] }] }, options:{ maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color:'#e6eef8' } } } } });
    }
  }catch(e){/*silent*/}

  // Recents
  const tbody = el('#dash_recent tbody'); if(!tbody) return;
  tbody.innerHTML = '';
  const recent = [].concat(state.transacoes || [], state.fluxo || []).slice(0,10);
  if(!recent.length) tbody.innerHTML = '<tr><td colspan="4" class="small">Sem registros</td></tr>';
  else {
    recent.forEach(r=>{
      const tr = document.createElement('tr');
      const dateStr = r.date ? (r.date.length===10 ? new Date(r.date+'T00:00:00').toLocaleDateString() : new Date(r.date).toLocaleDateString()) : '-';
      tr.innerHTML = `<td>${dateStr}</td><td>${r.tipo || r.type || 'mov'}</td><td>${r.reserva || r.desc || r.ativo || ''}</td><td>${formatMoney(r.valor || r.value || 0)}</td>`;
      tbody.appendChild(tr);
    });
  }
  el('#dash_updated').innerText = new Date().toLocaleString();
}

/* ===== Expor bloco de notas (para colar no GPT) ===== */
function compileExportText(){
  const resumo = computeResumoFinanceiro(getSelectedMonthKey()||new Date().toISOString().slice(0,7));
  const topCats = computeCustoByCategory(getSelectedMonthKey()).cats || {};
  const topCatsList = Object.keys(topCats).map(k=> `${k}: ${formatMoney(topCats[k])}`).join(' ‚Ä¢ ');
  const investSummary = (state.investimentos||[]).slice(0,8).map(i => `${i.ativo} (${i.categoria}) ‚Äî ${formatMoney(Number(i.quantidade||0)*Number(i.preco||0))}`).join('\n');
  const text = [
    `RESUMO FINANCEIRO ‚Äî ${new Date().toLocaleDateString()}`,
    `ENTRADAS: ${formatMoney(resumo.totalEntradas)}`,
    `SA√çDAS: ${formatMoney(resumo.totalSaidas)}`,
    `RESULTADO: ${formatMoney(resumo.resultado)}`,
    `RESERVAS (total saldo): ${formatMoney(resumo.reservasTotal)}`,
    `INVESTIMENTOS (total): ${formatMoney(resumo.investimentosTotal)}`,
    `CUSTO DE VIDA (m√™s): ${formatMoney(computeCustoByCategory(getSelectedMonthKey()).total || 0)}`,
    `PRINCIPAIS CATEGORIAS: ${topCatsList || '‚Äî'}`,
    `INVESTIMENTOS (top 8):\n${investSummary || '‚Äî'}`,
    `\nTRANSA√á√ïES RECENTES:\n${(state.transacoes||[]).slice(0,10).map(t=>`${t.date || t.date}: ${t.reserva || ''} ${t.tipo || ''} ${formatMoney(t.valor||0)}`).join('\n')}`
  ].join('\n');
  return text;
}
function exportToClipboardAndModal(){
  const txt = compileExportText();
  // copy
  navigator.clipboard.writeText(txt).then(()=>{
    showModal('Exportar (Bloco de Notas) ‚Äî Texto copiado', `<textarea class="input" style="height:260px">${txt}</textarea>`, null);
    alert('Resumo copiado para a √°rea de transfer√™ncia. Cole no ChatGPT para an√°lise.');
  }).catch(()=>{ showModal('Exportar (Bloco de Notas)', `<textarea class="input" style="height:260px">${txt}</textarea>`, null); alert('N√£o foi poss√≠vel copiar automaticamente. Abra o modal e copie manualmente.'); });
}

/* ===== Render all structural tables/cards ===== */
function renderAll(){
  reorderReservationsByDefault();
  renderReservations();
  renderInvestments();
  renderFluxo();
  renderCusto();
  renderNoteTabs();
  getMonthOptions();
  const key = getSelectedMonthKey() || new Date().toISOString().slice(0,7);
  if(state.planejamento[key]) renderPlanForMonth(key);
  renderDashboard(); // garante dashboard atualizado
  enableTouchForOnclicks(); // manter suporte touch atualizado
}

/* ===== INIT ===== */
(function init(){
  el('#apiUrlDisplay').innerText = API_URL || '(n√£o configurada)';
  loadLocal();
  if(!state.reservas || !state.reservas.length) createDefaultReservas();
  getMonthOptions();
  renderAll();

  // attach buttons
  el('#btnSeed').addEventListener('click', ()=>{ if(confirm('Criar reservas padr√£o?')) createDefaultReservas(); });
  el('#btnSyncAll').addEventListener('click', ()=>{ syncAllToDrive(); });
  el('#btnHideValues').addEventListener('click', ()=>{ state.settings.hideValues = !state.settings.hideValues; el('#btnHideValues').innerText = state.settings.hideValues ? 'Mostrar Valores' : 'Ocultar Valores'; saveLocal(); });
  el('#btnExportNotes').addEventListener('click', ()=>{ exportToClipboardAndModal(); });

  // observe DOM mutations (to attach touch handlers to dynamic elements)
  const mo = new MutationObserver(muts => { muts.forEach(m => { if(m.addedNodes && m.addedNodes.length){ m.addedNodes.forEach(node => { if(node.nodeType===1){ if(node.matches && node.matches('[onclick]')) attachTouch(node); node.querySelectorAll && node.querySelectorAll('[onclick]').forEach(elm=>attachTouch(elm)); } }); } }); });
  mo.observe(document.body, { childList:true, subtree:true });

})();

/* ===== MOBILE TOUCH SUPPORT ===== */
function attachTouch(el){
  if(!el) return;
  try{ if(el.__touchAttached) return;
    el.addEventListener('touchstart', function onTouch(e){ e.preventDefault(); el.click(); }, {passive:false});
    el.__touchAttached = true;
  }catch(err){}
}
function enableTouchForOnclicks(){
  document.querySelectorAll('[onclick]').forEach(el => attachTouch(el));
  document.querySelectorAll('.btn, .btn-ghost, button').forEach(b=>{ if(!b.__touchAttached){ b.addEventListener('touchstart', function(e){ e.preventDefault(); b.click(); }, {passive:false}); b.__touchAttached = true; }});
}

/* ===== Expose debug helpers ===== */
window._borges_state = state;
window.saveLocal = saveLocal;

</script>

</body>
</html>

<!-- ===================== DEBUG HELPERS ===================== -->
<script>
window._borges_state = state;
window.saveLocal = saveLocal;
</script>

<!-- === Google API === -->
<script src="https://apis.google.com/js/api.js"></script>

<!-- ===================== DRIVE SYNC ===================== -->
<script>
if (!state.assets) state.assets = [];
if (!state.settings) state.settings = { hideValues:false };
if (!state.settings.hidden) state.settings.hidden = {};

function toggleHideArea(area){
  state.settings.hidden[area] = !state.settings.hidden[area];
  saveLocal();
}

function toggleHideTab(tabId){
  state.settings.hidden['tab_'+tabId] = !state.settings.hidden['tab_'+tabId];
  updateTabVisibility();
  saveLocal();
}

function updateTabVisibility(){
  document.querySelectorAll('.page').forEach(p=>{
    const id = p.id;
    if(state.settings.hidden['tab_'+id]) p.style.display = 'none';
  });
  if (typeof renderAll === "function") renderAll();
}

/* ====== Ativos & Passivos ====== */
/* (mantive toda sua l√≥gica ‚Äî nada alterado) */

/* ====== GOOGLE DRIVE ====== */
const DRIVE_CLIENT_ID = '929006917338-i9ucbhout981fjje6e6n7njs8kdpk9h7.apps.googleusercontent.com';
const DRIVE_FILE_NAME = 'borges_panel_sync.json';
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';
const AUTO_CREATE_BACKUP_BEFORE_UPDATE = true;
const BACKUP_PREFIX = 'borges_panel_backup_';

let gapiInited = false;
let authInstance = null;

function initGAPI(){
  return new Promise((resolve,reject)=>{
    if(gapiInited) return resolve();
    gapi.load('client:auth2', async ()=>{
      try{
        await gapi.client.init({ clientId: DRIVE_CLIENT_ID, scope: DRIVE_SCOPE });
        authInstance = gapi.auth2.getAuthInstance();
        gapiInited = true;
        resolve();
      }catch(e){ reject(e); }
    });
  });
}

async function isSignedIn(){
  try{ await initGAPI(); return authInstance.isSignedIn.get(); }
  catch(e){ return false; }
}

async function signInDrive(){
  try{
    await initGAPI();
    await authInstance.signIn();
    showDriveStatus('Conectado');
    await downloadFromDriveIfExists();
  }catch(e){
    alert('Erro ao conectar ao Google Drive');
  }
}

function signOutDrive(){
  if(authInstance) authInstance.signOut();
  showDriveStatus('Desconectado');
}

function showDriveStatus(t){
  const el = document.getElementById('driveStatus');
  if(el) el.innerText = t;
}

async function findDriveFileByName(name){
  await initGAPI();
  const q = `name='${name.replace(/'/g,"\\'")}' and trashed=false`;
  const r = await gapi.client.drive.files.list({
    q, fields:'files(id,name,modifiedTime)'
  });
  return r.result.files?.[0] || null;
}

async function downloadDriveFile(id){
  await initGAPI();
  const r = await gapi.client.drive.files.get({ fileId:id, alt:'media' });
  try { return JSON.parse(r.body); } catch{ return r.result; }
}

async function createDriveFile(name, content){
  await initGAPI();
  const boundary = '-------31415926535';
  const body =
`--${boundary}
Content-Type: application/json

{"name":"${name}","mimeType":"application/json"}
--${boundary}
Content-Type: application/json

${JSON.stringify(content)}
--${boundary}--`;

  const r = await gapi.client.request({
    path:'/upload/drive/v3/files',
    method:'POST',
    params:{ uploadType:'multipart' },
    headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
    body
  });

  return r.result;
}

async function updateDriveFile(id, content){
  await initGAPI();
  const boundary = '-------31415926535';
  const body =
`--${boundary}
Content-Type: application/json

{"name":"${DRIVE_FILE_NAME}"}
--${boundary}
Content-Type: application/json

${JSON.stringify(content)}
--${boundary}--`;

  const r = await gapi.client.request({
    path:`/upload/drive/v3/files/${id}`,
    method:'PATCH',
    params:{ uploadType:'multipart' },
    headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
    body
  });

  return r.result;
}

async function downloadFromDriveIfExists(){
  if(!await isSignedIn()) return;
  showDriveStatus('Sincronizando...');
  const file = await findDriveFileByName(DRIVE_FILE_NAME);
  if(!file) return;

  state = Object.assign({}, state, await downloadDriveFile(file.id));
  saveLocal();
  showDriveStatus('Dados carregados');
}

async function uploadStateToDrive(){
  if(!await isSignedIn()) return;
  const payload = Object.assign({}, state);

  const file = await findDriveFileByName(DRIVE_FILE_NAME);
  if(!file){
    await createDriveFile(DRIVE_FILE_NAME, payload);
    showDriveStatus('Criado');
  } else {
    if(AUTO_CREATE_BACKUP_BEFORE_UPDATE){
      await createDriveFile(BACKUP_PREFIX + new Date().toISOString().replace(/[:.]/g,'-') + '.json', payload);
    }
    await updateDriveFile(file.id, payload);
    showDriveStatus('Atualizado');
  }
}

(function autoHook(){
  const original = saveLocal;
  window.saveLocal = function(){
    original();
    setTimeout(()=>uploadStateToDrive(),600);
  };
})();

function attachDriveControls(a,b,c,d){
  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById(a).onclick = signInDrive;
    document.getElementById(b).onclick = signOutDrive;
    document.getElementById(c).onclick = uploadStateToDrive;
    document.getElementById(d).innerText = 'Desconectado';
  });
}

window.driveSync = {
  initGAPI, signInDrive, signOutDrive,
  uploadStateToDrive, downloadFromDriveIfExists,
  attachDriveControls
};
</script>

<!-- ===================== ENHANCEMENTS (OCULTAR E NOVA ABA) ===================== -->
<script src="enhancements.js"></script>

</body>
</html>
