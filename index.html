<!-- ===================== DEBUG HELPERS ===================== -->
<script>
window._borges_state = state;
window.saveLocal = saveLocal;
</script>

<!-- === Google API === -->
<script src="https://apis.google.com/js/api.js"></script>

<!-- ===================== DRIVE SYNC ===================== -->
<script>
if (!state.assets) state.assets = [];
if (!state.settings) state.settings = { hideValues:false };
if (!state.settings.hidden) state.settings.hidden = {};

function toggleHideArea(area){
  state.settings.hidden[area] = !state.settings.hidden[area];
  saveLocal();
}

function toggleHideTab(tabId){
  state.settings.hidden['tab_'+tabId] = !state.settings.hidden['tab_'+tabId];
  updateTabVisibility();
  saveLocal();
}

function updateTabVisibility(){
  document.querySelectorAll('.page').forEach(p=>{
    const id = p.id;
    if(state.settings.hidden['tab_'+id]) p.style.display = 'none';
  });
  if (typeof renderAll === "function") renderAll();
}

/* ====== Ativos & Passivos ====== */
/* (mantive toda sua lógica — nada alterado) */

/* ====== GOOGLE DRIVE ====== */
const DRIVE_CLIENT_ID = '929006917338-i9ucbhout981fjje6e6n7njs8kdpk9h7.apps.googleusercontent.com';
const DRIVE_FILE_NAME = 'borges_panel_sync.json';
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';
const AUTO_CREATE_BACKUP_BEFORE_UPDATE = true;
const BACKUP_PREFIX = 'borges_panel_backup_';

let gapiInited = false;
let authInstance = null;

function initGAPI(){
  return new Promise((resolve,reject)=>{
    if(gapiInited) return resolve();
    gapi.load('client:auth2', async ()=>{
      try{
        await gapi.client.init({ clientId: DRIVE_CLIENT_ID, scope: DRIVE_SCOPE });
        authInstance = gapi.auth2.getAuthInstance();
        gapiInited = true;
        resolve();
      }catch(e){ reject(e); }
    });
  });
}

async function isSignedIn(){
  try{ await initGAPI(); return authInstance.isSignedIn.get(); }
  catch(e){ return false; }
}

async function signInDrive(){
  try{
    await initGAPI();
    await authInstance.signIn();
    showDriveStatus('Conectado');
    await downloadFromDriveIfExists();
  }catch(e){
    alert('Erro ao conectar ao Google Drive');
  }
}

function signOutDrive(){
  if(authInstance) authInstance.signOut();
  showDriveStatus('Desconectado');
}

function showDriveStatus(t){
  const el = document.getElementById('driveStatus');
  if(el) el.innerText = t;
}

async function findDriveFileByName(name){
  await initGAPI();
  const q = `name='${name.replace(/'/g,"\\'")}' and trashed=false`;
  const r = await gapi.client.drive.files.list({
    q, fields:'files(id,name,modifiedTime)'
  });
  return r.result.files?.[0] || null;
}

async function downloadDriveFile(id){
  await initGAPI();
  const r = await gapi.client.drive.files.get({ fileId:id, alt:'media' });
  try { return JSON.parse(r.body); } catch{ return r.result; }
}

async function createDriveFile(name, content){
  await initGAPI();
  const boundary = '-------31415926535';
  const body =
`--${boundary}
Content-Type: application/json

{"name":"${name}","mimeType":"application/json"}
--${boundary}
Content-Type: application/json

${JSON.stringify(content)}
--${boundary}--`;

  const r = await gapi.client.request({
    path:'/upload/drive/v3/files',
    method:'POST',
    params:{ uploadType:'multipart' },
    headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
    body
  });

  return r.result;
}

async function updateDriveFile(id, content){
  await initGAPI();
  const boundary = '-------31415926535';
  const body =
`--${boundary}
Content-Type: application/json

{"name":"${DRIVE_FILE_NAME}"}
--${boundary}
Content-Type: application/json

${JSON.stringify(content)}
--${boundary}--`;

  const r = await gapi.client.request({
    path:`/upload/drive/v3/files/${id}`,
    method:'PATCH',
    params:{ uploadType:'multipart' },
    headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
    body
  });

  return r.result;
}

async function downloadFromDriveIfExists(){
  if(!await isSignedIn()) return;
  showDriveStatus('Sincronizando...');
  const file = await findDriveFileByName(DRIVE_FILE_NAME);
  if(!file) return;

  state = Object.assign({}, state, await downloadDriveFile(file.id));
  saveLocal();
  showDriveStatus('Dados carregados');
}

async function uploadStateToDrive(){
  if(!await isSignedIn()) return;
  const payload = Object.assign({}, state);

  const file = await findDriveFileByName(DRIVE_FILE_NAME);
  if(!file){
    await createDriveFile(DRIVE_FILE_NAME, payload);
    showDriveStatus('Criado');
  } else {
    if(AUTO_CREATE_BACKUP_BEFORE_UPDATE){
      await createDriveFile(BACKUP_PREFIX + new Date().toISOString().replace(/[:.]/g,'-') + '.json', payload);
    }
    await updateDriveFile(file.id, payload);
    showDriveStatus('Atualizado');
  }
}

(function autoHook(){
  const original = saveLocal;
  window.saveLocal = function(){
    original();
    setTimeout(()=>uploadStateToDrive(),600);
  };
})();

function attachDriveControls(a,b,c,d){
  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById(a).onclick = signInDrive;
    document.getElementById(b).onclick = signOutDrive;
    document.getElementById(c).onclick = uploadStateToDrive;
    document.getElementById(d).innerText = 'Desconectado';
  });
}

window.driveSync = {
  initGAPI, signInDrive, signOutDrive,
  uploadStateToDrive, downloadFromDriveIfExists,
  attachDriveControls
};
</script>

<!-- ===================== ENHANCEMENTS (OCULTAR E NOVA ABA) ===================== -->
<script src="enhancements.js"></script>

</body>
</html>
