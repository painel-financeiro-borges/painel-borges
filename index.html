<!doctype html>
<html lang="pt-BR">
<head>

<!-- ========================================================= -->
<!-- üß© BLOCO 01 ‚Äî HEAD / META / CSS / ESTILO GLOBAL           -->
<!-- ========================================================= -->

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel Borges Participa√ß√µes e Holding ‚Ä¢ Reservas ‚Ä¢ Investimentos</title>

<style>
/* ======================= GLOBAL THEME ======================= */
:root{
  --bg:#041022;
  --panel:#061021;
  --card:#071427;
  --muted:#9aa4b2;
  --accent:#1e88e5;
  --accent-2:#60a5fa;
  --success:#16a34a;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.03);
  --radius:12px;
  --shadow: 0 8px 24px rgba(2,6,23,0.55);
  --font: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --btn-ghost-border: rgba(255,255,255,0.10);
  --btn-ghost-bg: rgba(255,255,255,0.02);
  --btn-text: #e6eef8;
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:var(--font);
  background:linear-gradient(180deg,#041022 0%, #071827 100%);
  color:var(--btn-text);
}

/* ======================= LAYOUT / COMPONENTS ======================= */

header{
  display:flex;
  gap:12px;
  align-items:center;
  padding:12px 18px;
  background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
  border-bottom:1px solid rgba(255,255,255,0.02);
  position:sticky;
  top:0;
  z-index:30;
}

.brand{font-weight:900;color:var(--accent);font-size:18px}
.subtitle{color:var(--muted);font-size:13px;margin-left:6px}

.container{max-width:1200px;margin:14px auto;padding:0 12px}

.topbar{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.tab{
  background:transparent;
  border:1px solid rgba(255,255,255,0.04);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  color:var(--btn-text);
}
.tab.active{
  background:linear-gradient(90deg, rgba(30,136,229,0.12), rgba(96,165,250,0.04));
  border-color:rgba(30,136,229,0.2);
  font-weight:700;
}

.card{
  background:var(--panel);
  padding:14px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-top:12px;
  border:1px solid rgba(255,255,255,0.03);
}

.row{display:flex;gap:12px;align-items:center}
.spacer{flex:1}
.small{font-size:13px;color:var(--muted)}

.grid{display:grid;gap:12px}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-2{grid-template-columns:repeat(2,1fr)}

.table{width:100%;border-collapse:collapse}
.table th,.table td{
  padding:8px;
  border-bottom:1px solid rgba(255,255,255,0.02);
  text-align:left;
  font-size:14px;
}

.input, textarea, select{
  background:transparent;
  border:1px solid rgba(255,255,255,0.04);
  padding:8px;
  border-radius:8px;
  color:var(--btn-text);
  width:100%;
}

.btn{
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  color: white;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  box-shadow: 0 6px 18px rgba(30,136,229,0.12);
}
.btn:hover{filter:brightness(1.03)}

.btn-ghost{
  background: var(--btn-ghost-bg);
  border:1px solid var(--btn-ghost-border);
  color: var(--btn-text);
  padding:7px 10px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.btn-pro{
  background: transparent;
  border:1px solid rgba(255,255,255,0.06);
  padding:8px 12px;
  border-radius:8px;
  color:var(--btn-text);
  cursor:pointer;
  font-weight:700;
}

.btn-export{
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  padding:8px 12px;
  border-radius:8px;
  color: var(--btn-text);
  cursor:pointer;
  font-weight:700;
}

.progress{
  height:12px;
  background:rgba(255,255,255,0.03);
  border-radius:8px;
  overflow:hidden;
}
.bar{
  height:100%;
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  width:0%;
}

.alert-banner{
  background:rgba(255,255,255,0.03);
  padding:8px;
  border-radius:8px;
  border-left:4px solid rgba(255,255,255,0.06);
  margin-top:10px;
  color:var(--muted);
}

.res-card{
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  padding:12px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.03);
  cursor:grab;
}

/* mobile */
@media(max-width:900px){
  .cols-3{grid-template-columns:1fr}
  .cols-2{grid-template-columns:1fr}
  header{flex-direction:column;align-items:flex-start}
}
canvas{width:100%;height:150px;border-radius:8px;background:transparent}

</style>
</head>

<body>

<!-- ========================================================= -->
<!-- üß© BLOCO 02 ‚Äî HEADER / TOPO DO PAINEL                     -->
<!-- ========================================================= -->

<header>
  <div>
    <div class="brand">Painel Borges Participa√ß√µes</div>
    <div class="subtitle">Holding ‚Ä¢ Reservas ‚Ä¢ Investimentos</div>
  </div>
  <div class="spacer"></div>
  <div class="small">Offline + Drive sync (API configurada)</div>
</header>

<!-- ========================================================= -->
<!-- üß© BLOCO 03 ‚Äî MENU / TABS / NAVEGA√á√ÉO                    -->
<!-- ========================================================= -->

<div class="container">
  <div class="card topbar">

    <div class="tab active" data-tab="dashboard">Dashboard</div>
    <div class="tab" data-tab="custo">Custo de Vida</div>
    <div class="tab" data-tab="planejamento">Planejamento</div>
    <div class="tab" data-tab="fluxo">Fluxo Di√°rio</div>
    <div class="tab" data-tab="reservas">Reservas</div>
    <div class="tab" data-tab="investimentos">Investimentos</div>
    <div class="tab" data-tab="caderno">Bloco de Notas</div>
    <div class="tab" data-tab="backup">Backup</div>

    <div class="spacer"></div>

    <button id="btnSeed" class="btn-ghost">Criar Padr√µes</button>
    <button id="btnSyncAll" class="btn">Sincronizar Drive</button>
    <button id="btnHideValues" class="btn-pro">Ocultar Valores</button>
    <button id="btnExportNotes" class="btn-export">Exportar Notas</button>

  </div>

<!-- ========================================================= -->
<!-- üß© BLOCO 04 ‚Äî DASHBOARD (APENAS HTML)                    -->
<!-- ========================================================= -->

  <div id="dashboard" class="page card" style="margin-top:12px">
    <h2>Dashboard</h2>
    <div id="dash_alert" class="alert-banner" style="display:none"></div>

    <!-- TOP STATS -->
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Entradas</div>
        <div id="dash_entradas" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Lan√ßamentos: <span id="count_entradas">0</span></div>
      </div>

      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Sa√≠das</div>
        <div id="dash_saidas" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Lan√ßamentos: <span id="count_saidas">0</span></div>
      </div>

      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Resultado</div>
        <div id="dash_resultado" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Status: <span id="dash_result_status">‚Äî</span></div>
      </div>
    </div>

    <!-- RESERVAS ‚Äî TOTAL -->
    <div class="card" style="flex:1;min-width:220px;margin-top:12px">
      <div style="font-weight:600;margin-bottom:6px">Reservas ‚Äî total</div>
      <div id="dash_reservas_total" style="font-size:20px;font-weight:700">R$ 0,00</div>
      <div class="small">Quantidade de reservas: <span id="dash_reservas_count">0</span></div>

      <div style="margin-top:10px;font-weight:600">Progresso das reservas</div>
      <div class="progress" style="height:10px;margin-top:6px;background:#eee;border-radius:8px;overflow:hidden">
        <div id="reservas_progress_bar" class="bar" style="width:0%;background:#00c853;transition:width 0.4s ease"></div>
      </div>
      <div id="reservas_progress_text" class="small">0%</div>
    </div>

    <!-- CUSTO -->
    <div class="card" id="dash_custo_card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small">Custo de Vida (m√™s)</div>
          <div id="dash_custo_total" style="font-weight:800;font-size:22px">R$ 0,00</div>
          <div class="small" id="dash_custo_month_label"></div>
        </div>
        <div style="width:320px"><canvas id="chartCustoTop" height="160"></canvas></div>
      </div>
    </div>

    <!-- FLUXO -->
    <div class="card" id="dash_fluxo_card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small">Fluxo de Caixa ‚Äî M√™s</div>
          <div style="display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <div class="kv"><div class="small">Entradas</div><div id="dash_fluxo_entries" style="font-weight:800">R$ 0,00</div></div>
            <div class="kv"><div class="small">Sa√≠das</div><div id="dash_fluxo_exits" style="font-weight:800">R$ 0,00</div></div>
            <div class="kv"><div class="small">Consolida√ß√£o</div><div id="dash_fluxo_net" style="font-weight:800">R$ 0,00</div></div>
          </div>
        </div>
        <div style="flex:1;max-width:680px">
          <canvas id="chartFluxMonthly" height="180"></canvas>
        </div>
      </div>
    </div>

    <!-- PLANEJAMENTO -->
    <div class="card" id="dash_plan_card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small">Planejamento Mensal ‚Äî Progresso</div>
          <div id="dash_plan_meta" style="font-weight:800;font-size:18px">Meta: R$ 0,00</div>
          <div id="dash_plan_done" class="small">Conclu√≠do: R$ 0,00</div>

          <div style="margin-top:8px" class="progress">
            <div id="dash_plan_bar" class="bar" style="width:0%"></div>
          </div>
          <div style="margin-top:6px" class="small">Progresso: <span id="dash_plan_pct">0%</span></div>
        </div>

        <div style="width:240px"><canvas id="chartPlan" height="160"></canvas></div>
      </div>
    </div>

    <!-- INVESTIMENTOS -->
    <div style="display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px">
      <div class="card">
        <div class="small">Investimentos ‚Äî total</div>
        <div id="dash_invest_total" style="font-weight:800;font-size:20px">R$ 0,00</div>
        <div class="small">Quantidade de ativos: <span id="dash_inv_count">0</span></div>
        <div style="margin-top:8px"><canvas id="chartInvCompSmall" height="140"></canvas></div>
      </div>
    </div>

    <!-- RECENTES -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">√öltimas transa√ß√µes / lan√ßamentos</h3>
          <div class="small">Transa√ß√µes recentes</div>
        </div>
        <div class="small">Atualizado: <span id="dash_updated">-</span></div>
      </div>

      <div style="margin-top:8px;overflow:auto">
        <table class="table" id="dash_recent">
          <thead><tr><th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Valor</th></tr></thead>
          <tbody><tr><td colspan="4" class="small">Sem registros</td></tr></tbody>
        </table>
      </div>
    </div>

  </div> <!-- /dashboard -->

<!-- ========================================================= -->
<!-- üß© BLOCO 05 ‚Äî CUSTO DE VIDA (HTML PURO)                   -->
<!-- ========================================================= -->

  <div id="custo" class="page" style="display:none">
    <div class="card">
      <h2>Custo de Vida ‚Äî lan√ßamentos mensais</h2>
      <div class="small">Adicione seus custos mensais.</div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="cv_date" class="input" type="date"/>
        <input id="cv_desc" class="input" placeholder="Descri√ß√£o"/>
        <select id="cv_cat" class="input">
          <option>Moradia</option><option>Alimenta√ß√£o</option>
          <option>Transporte</option><option>Educa√ß√£o</option>
          <option>Lazer</option><option>Outros</option>
        </select>
        <input id="cv_valor" class="input" type="number" placeholder="Valor (R$)"/>
        <button class="btn">Adicionar</button>
        <button class="btn-ghost">Limpar m√™s</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <div style="flex:1">
          <table class="table" id="custoTable">
            <thead><tr>
              <th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th>
            </tr></thead>
            <tbody><tr><td colspan="5" class="small">Sem lan√ßamentos</td></tr></tbody>
          </table>
        </div>

        <div style="width:320px">
          <div class="small">Distribui√ß√£o por categoria</div>
          <canvas id="chartCusto" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

<!-- ========================================================= -->
<!-- üß© BLOCO 06 ‚Äî PLANEJAMENTO                               -->
<!-- ========================================================= -->

  <div id="planejamento" class="page" style="display:none">
    <div class="card">
      <h2>Planejamento Mensal ‚Äî 3 per√≠odos</h2>
      <div class="small">Metas por per√≠odo e contas.</div>

      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <select id="plan_mes" class="input"></select>
        <button class="btn">Criar/Carregar m√™s</button>
      </div>

      <div id="planPeriods" style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px"></div>

      <div style="margin-top:12px">
        <div class="small">Resumo</div>
        <div id="plan_summary" style="font-weight:700">Nenhum planejamento carregado</div>
      </div>
    </div>
  </div>

<!-- ====================== BLOCO 07 ‚Äî FLUXO DI√ÅRIO ========================= -->

<div id="fluxo" class="page" style="display:none">
  <div class="card">
    <h2>Fluxo Di√°rio</h2>
    <div class="small">Registre entradas e sa√≠das por dia.</div>

    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">

      <input id="fx_date" class="input" type="date"/>

      <input id="fx_desc" class="input" placeholder="Descri√ß√£o"/>

      <select id="fx_tipo" class="input">
        <option value="entrada">Entrada</option>
        <option value="saida">Sa√≠da</option>
      </select>

      <select id="fx_payment" class="input">
        <option value="">(pagamento)</option>
        <option value="pix">PIX</option>
        <option value="credito">Cr√©dito</option>
        <option value="debito">D√©bito</option>
        <option value="dinheiro">Dinheiro</option>
      </select>

      <input id="fx_valor" type="number" class="input" placeholder="Valor"/>

      <button class="btn" onclick="addFluxo()">Adicionar</button>

    </div>

    <table class="table" id="fluxoTable" style="margin-top:12px">
      <thead>
        <tr>
          <th>Data</th><th>Descri√ß√£o</th><th>Tipo</th><th>Pagamento</th><th>Valor</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="6" class="small">Sem registros</td></tr></tbody>
    </table>
  </div>
</div>

<!-- ========================================================= -->
<!-- üß© BLOCO 08 ‚Äî RESERVAS                                   -->
<!-- ========================================================= -->

  <div id="reservas" class="page" style="display:none">
    <div class="card">
      <h2>Reservas</h2>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <input id="r_name" class="input" placeholder="Nova reserva"/>
        <input id="r_meta" class="input" type="number" placeholder="Meta (R$)"/>
        <input id="r_init" class="input" type="number" placeholder="Aporte inicial"/>
        <button class="btn">Adicionar</button>
      </div>

      <div id="resCards" style="margin-top:12px"></div>

    </div>
  </div>

<!-- ========================================================= -->
<!-- üß© BLOCO 09 ‚Äî INVESTIMENTOS                              -->
<!-- ========================================================= -->

  <div id="investimentos" class="page" style="display:none">
    <div class="card">
      <h2>Investimentos</h2>

      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="inv_ativo" class="input" placeholder="Ativo"/>
        <input id="inv_categoria" class="input" placeholder="Categoria"/>
        <input id="inv_qtd" class="input" type="number" placeholder="Qtd"/>
        <input id="inv_preco" class="input" type="number" placeholder="Pre√ßo"/>
        <button class="btn">Adicionar</button>
      </div>

      <table class="table" id="invTable" style="margin-top:12px">
        <thead>
          <tr><th>Ativo</th><th>Categoria</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th><th>A√ß√µes</th></tr>
        </thead>
        <tbody><tr><td colspan="6" class="small">Nenhum investimento</td></tr></tbody>
      </table>

    </div>
  </div>

<!-- ========================================================= -->
<!-- üß© BLOCO 10 ‚Äî CADERNO (BLOCO DE NOTAS)                   -->
<!-- ========================================================= -->

  <div id="caderno" class="page" style="display:none">
    <div class="card">
      <h2>Bloco de Notas</h2>

      <div id="noteTabs" style="margin-top:12px"></div>
      <div id="noteBlocks" style="margin-top:12px"></div>
    </div>
  </div>

<!-- ========================================================= -->
<!-- üß© BLOCO 11 ‚Äî BACKUP / IMPORTAR / EXPORTAR               -->
<!-- ========================================================= -->

  <div id="backup" class="page" style="display:none">
    <div class="card">
      <h2>Backup</h2>

      <button class="btn" style="margin-top:8px">Exportar dados</button>
      <button class="btn-ghost" style="margin-top:8px">Importar dados</button>
      <button class="btn-ghost" style="margin-top:8px">Resetar tudo</button>

    </div>
  </div>

</div> <!-- /container -->

<!-- O restante (JS) s√≥ entra a partir da PARTE 02 -->

</body>
</html>

  <!-- ============== DASHBOARD (C ‚Äî totalmente mapeado por blocos) ============== -->
<div id="dashboard" class="page card" style="margin-top:12px">

  <h2>Dashboard</h2>

  <!-- üîî Banner de alerta -->
  <div id="dash_alert" class="alert-banner" style="display:none"></div>


  <!-- ======================== BLOCO 01 ‚Äî Estat√≠sticas Gerais ======================== -->
  <div class="dashboard-section" id="dash_section_stats">

    <h3 class="section-title">Resumo Geral</h3>

    <div class="dash-grid">

      <!-- ENTRADAS -->
      <div class="card dash-card">
        <div class="small">Entradas</div>
        <div id="dash_entradas" class="dash-value">R$ 0,00</div>
        <div class="small">Lan√ßamentos: <span id="count_entradas">0</span></div>
      </div>

      <!-- SA√çDAS -->
      <div class="card dash-card">
        <div class="small">Sa√≠das</div>
        <div id="dash_saidas" class="dash-value">R$ 0,00</div>
        <div class="small">Lan√ßamentos: <span id="count_saidas">0</span></div>
      </div>

      <!-- RESULTADO -->
      <div class="card dash-card">
        <div class="small">Resultado</div>
        <div id="dash_resultado" class="dash-value">R$ 0,00</div>
        <div class="small">Status: <span id="dash_result_status">‚Äî</span></div>
      </div>

      <!-- RESERVAS TOTAL -->
      <div class="card dash-card">
        <div class="small">Reservas ‚Äî Total</div>
        <div id="dash_reservas_total" class="dash-value">R$ 0,00</div>
        <div class="small">Quantidade: <span id="dash_reservas_count">0</span></div>
      </div>

      <!-- INVESTIMENTOS TOTAL -->
      <div class="card dash-card">
        <div class="small">Investimentos ‚Äî Total</div>
        <div id="dash_invest_total" class="dash-value">R$ 0,00</div>
        <div class="small">Quantidade: <span id="dash_inv_count">0</span></div>
      </div>

      <!-- CUSTO DE VIDA -->
      <div class="card dash-card">
        <div class="small">Custo de Vida (ref. m√™s)</div>
        <div id="dash_custo_total" class="dash-value">R$ 0,00</div>
        <div class="small">M√™s: <span id="dash_custo_month_label">‚Äî</span></div>
      </div>

    </div>
  </div>


  <!-- ======================== BLOCO 02 ‚Äî Progresso das Reservas ======================== -->
  <div class="dashboard-section" id="dash_section_reservas" style="margin-top:22px">

    <h3 class="section-title">Progresso Geral das Reservas</h3>

    <div class="card" style="flex:1;min-width:260px">

      <div class="small" style="font-weight:600;margin-bottom:6px">
        Progresso total
      </div>

      <div class="progress" style="height:12px;background:#eee;border-radius:10px;overflow:hidden;margin-top:6px">
        <div id="reservas_progress_bar"
             style="width:0%;height:100%;background:#00c853;transition:width 0.4s ease"></div>
      </div>

      <div id="reservas_progress_text"
           class="small"
           style="margin-top:6px;font-weight:700">
        0%
      </div>

    </div>

  </div>

</div>

/* ========================================================= */
/* üß© BLOCO 20 ‚Äî PROGRESSO DAS RESERVAS                      */
/* ========================================================= */

function renderReservasProgress(){
  const reservas = state.reservas || [];
  const bar = el('#reservas_progress_bar');
  const text = el('#reservas_progress_text');

  if (!reservas.length){
    if (bar) bar.style.width = '0%';
    if (text) text.innerText = '0%';
    return;
  }

  const totalSaldo = reservas.reduce((s,r)=> s + Number(r.saldo||0), 0);
  const totalMeta  = reservas.reduce((s,r)=> s + Number(r.meta||0), 0);
  const pct = totalMeta > 0 ? Math.min(100, Math.round((totalSaldo / totalMeta) * 100)) : 0;

  if (bar){
    bar.style.width = pct + '%';
    bar.style.background = pct>=100 ? '#00c853' : pct>=50 ? '#ffd600' : '#d50000';
  }

  if (text) text.innerText = pct + '%';
}
/* ========================================================= */
/* üß© BLOCO 21 ‚Äî INVESTIMENTOS                               */
/* ========================================================= */

function addInvestment(){
  const name = el('#inv_ativo').value.trim();
  const cat = el('#inv_categoria').value;
  const qtd = Number(el('#inv_qtd').value) || 0;
  const preco = Number(el('#inv_preco').value) || 0;

  if(!name){
    alert('Nome do ativo √© obrigat√≥rio');
    return;
  }

  const inv = {
    id: uid('i'),
    ativo: name,
    categoria: cat,
    quantidade: qtd,
    preco: preco,
    updated: nowISO()
  };

  state.investimentos.push(inv);

  el('#inv_ativo').value='';
  el('#inv_qtd').value='';
  el('#inv_preco').value='';

  saveLocal();
}

function renderInvestments(){
  const tbody = el('#invTable tbody');
  if(!tbody) return;

  tbody.innerHTML='';

  if(!state.investimentos.length){
    tbody.innerHTML = '<tr><td colspan="6" class="small">Nenhum investimento</td></tr>';
    return;
  }

  state.investimentos.forEach(it=>{
    const total = Number(it.quantidade||0) * Number(it.preco||0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.ativo}</td>
      <td>${it.categoria}</td>
      <td>${it.quantidade}</td>
      <td>${formatMoney(it.preco)}</td>
      <td>${formatMoney(total)}</td>
      <td>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn-ghost" onclick="openEditInvestment('${it.id}')">Editar</button>
          <button class="btn-ghost" onclick="removeInvestment('${it.id}')">Remover</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function openEditInvestment(id){
  const it = state.investimentos.find(x=>x.id === id);
  if(!it) return;

  showModal('Editar Investimento', `
    <label>Ativo</label>
    <input id="modal_i_name" class="input" value="${it.ativo}"/>

    <label>Categoria</label>
    <input id="modal_i_cat" class="input" value="${it.categoria}"/>

    <label>Quantidade</label>
    <input id="modal_i_qtd" type="number" class="input" value="${it.quantidade}"/>

    <label>Pre√ßo Unit√°rio</label>
    <input id="modal_i_preco" type="number" class="input" value="${it.preco}"/>
  `, function(){
    it.ativo = el('#modal_i_name').value;
    it.categoria = el('#modal_i_cat').value;
    it.quantidade = Number(el('#modal_i_qtd').value) || 0;
    it.preco = Number(el('#modal_i_preco').value) || 0;
    it.updated = nowISO();
    saveLocal();
  });
}

function removeInvestment(id){
  if(!confirm('Remover investimento?')) return;
  state.investimentos = state.investimentos.filter(x=>x.id !== id);
  saveLocal();
}
// =========================================================
// üß© BLOCO 12 ‚Äî HELPERS / FUN√á√ïES GERAIS
// =========================================================

function el(s){ return document.querySelector(s); }
function els(s){ return document.querySelectorAll(s); }
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).substr(2,9); }
function nowISO(){ return new Date().toISOString(); }
function formatMoney(v){ return Number(v||0).toLocaleString('pt-BR',{ style:'currency',currency:'BRL' }); }
// =========================================================
// üß© BLOCO 13 ‚Äî STATE GLOBAL + LOCALSTORAGE
// =========================================================

let state = JSON.parse(localStorage.getItem('borges_state_v3') || '{}');

if(!state.reservas) state.reservas = [];
if(!state.transacoes) state.transacoes = [];
if(!state.investimentos) state.investimentos = [];
if(!state.fluxo) state.fluxo = [];
if(!state.custo) state.custo = [];
if(!state.planejamento) state.planejamento = {};
if(!state.caderno) state.caderno = [];
if(!state.settings) state.settings = { hideValues:false };

function saveLocal(){
  localStorage.setItem('borges_state_v3', JSON.stringify(state));
}
// =========================================================
// üß© BLOCO 14 ‚Äî PROGRESSO DAS RESERVAS
// =========================================================

function renderReservasProgress(){
  const reservas = state.reservas || [];
  const bar = el('#reservas_progress_bar');
  const text = el('#reservas_progress_text');

  if(!reservas.length){
    if(bar) bar.style.width = '0%';
    if(text) text.innerText = '0%';
    return;
  }

  const totalSaldo = reservas.reduce((s,r)=> s + Number(r.saldo||0), 0);
  const totalMeta  = reservas.reduce((s,r)=> s + Number(r.meta||0), 0);
  const pct = totalMeta > 0 ? Math.min(100, Math.round((totalSaldo / totalMeta) * 100)) : 0;

  if(bar){
    bar.style.width = pct + '%';
    bar.style.background = 
        pct >= 100 ? '#00c853' :
        pct >=  50 ? '#ffd600' :
                     '#d50000';
  }

  if(text) text.innerText = pct + '%';
}
// =========================================================
// üß© BLOCO 15 ‚Äî INVESTIMENTOS
// =========================================================

function addInvestment(){
  const name = el('#inv_ativo').value.trim();
  const cat  = el('#inv_categoria').value;
  const qtd  = Number(el('#inv_qtd').value) || 0;
  const preco= Number(el('#inv_preco').value) || 0;

  if(!name) return alert('Nome do ativo √© obrigat√≥rio');

  const inv = {
    id: uid('i'),
    ativo:name,
    categoria:cat,
    quantidade:qtd,
    preco:preco,
    updated:nowISO()
  };

  state.investimentos.push(inv);

  el('#inv_ativo').value='';
  el('#inv_qtd').value='';
  el('#inv_preco').value='';

  saveLocal();
}

function renderInvestments(){
  const tbody = el('#invTable tbody');
  if(!tbody) return;

  tbody.innerHTML='';

  if(!state.investimentos.length){
    tbody.innerHTML='<tr><td colspan="6" class="small">Nenhum investimento</td></tr>';
    return;
  }

  state.investimentos.forEach(it=>{
    const total = Number(it.quantidade||0) * Number(it.preco||0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.ativo}</td>
      <td>${it.categoria}</td>
      <td>${it.quantidade}</td>
      <td>${formatMoney(it.preco)}</td>
      <td>${formatMoney(total)}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn-ghost" onclick="openEditInvestment('${it.id}')">Editar</button>
          <button class="btn-ghost" onclick="removeInvestment('${it.id}')">Remover</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function openEditInvestment(id){
  const it = state.investimentos.find(x=>x.id===id);
  if(!it) return;

  showModal('Editar Investimento', `
    <label>Ativo</label><input id="modal_i_name" class="input" value="${it.ativo}">
    <label>Categoria</label><input id="modal_i_cat" class="input" value="${it.categoria}">
    <label>Quantidade</label><input id="modal_i_qtd" type="number" class="input" value="${it.quantidade}">
    <label>Pre√ßo Unit√°rio</label><input id="modal_i_preco" type="number" class="input" value="${it.preco}">
  `, function(){
    it.ativo = el('#modal_i_name').value;
    it.categoria = el('#modal_i_cat').value;
    it.quantidade = Number(el('#modal_i_qtd').value)||0;
    it.preco = Number(el('#modal_i_preco').value)||0;
    it.updated = nowISO();
    saveLocal();
  });
}

function removeInvestment(id){
  if(!confirm('Remover investimento?')) return;
  state.investimentos = state.investimentos.filter(x=>x.id!==id);
  saveLocal();
}
// =========================================================
// üß© BLOCO 16 ‚Äî FLUXO DI√ÅRIO
// =========================================================

function addFluxo(){
  const date = el('#fx_date').value || new Date().toISOString().slice(0,10);
  const desc = el('#fx_desc').value || '(sem descri√ß√£o)';
  const type = el('#fx_tipo').value;
  const payment = el('#fx_payment')?.value || '';
  const val  = Number(el('#fx_valor').value) || 0;

  if(val <= 0) return alert('Valor deve ser maior que zero');

  const entry = {
    id: uid('f'), date, desc, type, payment, value:val
  };

  state.fluxo.unshift(entry);

  el('#fx_desc').value='';
  el('#fx_valor').value='';
  el('#fx_date').value='';

  saveLocal();
}

function renderFluxo(){
  const tbody = el('#fluxoTable tbody');
  if(!tbody) return;

  tbody.innerHTML='';

  if(!state.fluxo.length){
    tbody.innerHTML='<tr><td colspan="6" class="small">Sem lan√ßamentos</td></tr>';
    return;
  }

  state.fluxo.slice(0,200).forEach(f=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(f.date+'T00:00:00').toLocaleDateString()}</td>
      <td>${f.desc}</td>
      <td>${f.type}</td>
      <td>${f.payment}</td>
      <td>${formatMoney(f.value)}</td>
      <td>
        <div style="display:flex;gap:8px">
          <button class="btn-ghost" onclick="editFlux('${f.id}')">Editar</button>
          <button class="btn-ghost" onclick="removeFlux('${f.id}')">Excluir</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
}

function editFlux(id){
  const f = state.fluxo.find(x=>x.id===id);
  if(!f) return;

  showModal('Editar Fluxo', `
    <label>Data</label><input id="modal_fx_date" class="input" type="date" value="${f.date}">
    <label>Descri√ß√£o</label><input id="modal_fx_desc" class="input" value="${f.desc}">
    <label>Tipo</label><select id="modal_fx_type" class="input">
      <option value="entrada">Entrada</option>
      <option value="saida">Sa√≠da</option>
    </select>
    <label>Pagamento</label><input id="modal_fx_payment" class="input" value="${f.payment}">
    <label>Valor</label><input id="modal_fx_valor" class="input" type="number" value="${f.value}">
  `, function(){
    f.date = el('#modal_fx_date').value;
    f.desc = el('#modal_fx_desc').value;
    f.type = el('#modal_fx_type').value;
    f.payment = el('#modal_fx_payment').value;
    f.value = Number(el('#modal_fx_valor').value)||0;
    saveLocal();
  });
}

function removeFlux(id){
  if(!confirm('Excluir lan√ßamento?')) return;
  state.fluxo = state.fluxo.filter(f => f.id !== id);
  saveLocal();
}
/* ============================================================
   üß© BLOCO C01 ‚Äî Progresso Geral das Reservas
   ============================================================ */
function renderReservasProgress() {

  const totalMetas = reservas.reduce((acc, r) => acc + (r.meta || 0), 0);
  const totalAtuais = reservas.reduce((acc, r) => acc + (r.valor || 0), 0);

  const pct = totalMetas > 0 ? (totalAtuais / totalMetas) * 100 : 0;

  const bar = document.getElementById("reservas_progress_bar");
  const text = document.getElementById("reservas_progress_text");

  if (bar) bar.style.width = pct.toFixed(0) + "%";
  if (text) text.textContent = pct.toFixed(0) + "%";
}


/* ============================================================
   üß© BLOCO C02 ‚Äî Gr√°fico: Reservas (Comparativo barra)
   ============================================================ */
function renderReservasChart() {

  try {

    const ctx = document.getElementById("chartReservas");

    if (!ctx) return;

    const labels = reservas.map(r => r.nome);
    const metas = reservas.map(r => r.meta || 0);
    const valores = reservas.map(r => r.valor || 0);

    if (window.chartReservasInstance)
      window.chartReservasInstance.destroy();

    window.chartReservasInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Meta",
            data: metas,
            backgroundColor: "rgba(30,136,229,0.50)"
          },
          {
            label: "Atual",
            data: valores,
            backgroundColor: "rgba(0,200,83,0.70)"
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: "#e6eef8" }
          }
        },
        scales: {
          x: {
            ticks: { color: "#e6eef8" }
          },
          y: {
            ticks: { color: "#e6eef8" }
          }
        }
      }
    });

  } catch (e) { /* silent */ }
}


/* ============================================================
   üß© BLOCO C03 ‚Äî Gr√°fico Pizza Reservas
   ============================================================ */
function renderReservasPie() {

  try {

    const ctx = document.getElementById("chartReservasPie");
    if (!ctx) return;

    const labels = reservas.map(r => r.nome);
    const valores = reservas.map(r => r.valor || 0);

    if (window.chartReservasPieInstance)
      window.chartReservasPieInstance.destroy();

    window.chartReservasPieInstance = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [
          {
            label: "Distribui√ß√£o",
            data: valores
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "right",
            labels: { color: "#e6eef8" }
          }
        }
      }
    });

  } catch (e) { /* silent */ }
}

/* ============================================================
   üß© BLOCO C10 ‚Äî Dashboard: Charts, Resumo Fluxo, Plan, Invest
   ============================================================ */

/* ===== Fluxo mensal chart + resumo fluxos ===== */
(function renderFluxAndPlanAndInvestCharts(monthKey){
  // fluxo mensal chart
  const fluxoRes = computeFluxoMonthly(monthKey);
  el('#dash_fluxo_entries').innerText = formatMoney(fluxoRes.totalEntries || 0);
  el('#dash_fluxo_exits').innerText   = formatMoney(fluxoRes.totalExits || 0);
  el('#dash_fluxo_net').innerText     = formatMoney(fluxoRes.net || 0);
  el('#dash_fluxo_net').style.color = (fluxoRes.net >= 0) ? 'var(--success)' : 'var(--danger)';

  if(chartFluxMonthly){ chartFluxMonthly.destroy(); chartFluxMonthly = null; }
  try{
    const ctxF = document.getElementById('chartFluxMonthly').getContext('2d');
    chartFluxMonthly = new Chart(ctxF, {
      type:'bar',
      data:{
        labels: fluxoRes.labels,
        datasets:[
          { label:'Entradas', data:fluxoRes.entriesArr, backgroundColor:'#16a34a' },
          { label:'Sa√≠das',   data:fluxoRes.exitsArr,   backgroundColor:'#ef4444' }
        ]
      },
      options:{
        maintainAspectRatio:false,
        scales:{
          x:{ ticks:{ color:'#e6eef8' } },
          y:{ ticks:{ color:'#e6eef8' } }
        },
        plugins:{ legend:{ labels:{ color:'#e6eef8' } } }
      }
    });
  }catch(e){ /* silent */ }

  // Plan small chart (donut) + progress bar
  const planRes = computePlanProgress(monthKey);
  el('#dash_plan_meta').innerText = `Meta: ${formatMoney(planRes.meta || 0)}`;
  el('#dash_plan_done').innerText = `Conclu√≠do: ${formatMoney(planRes.done || 0)}`;
  const pct = Math.min(100, Math.max(0, planRes.pct || 0));
  const planBarEl = el('#dash_plan_bar');
  if(planBarEl) planBarEl.style.width = pct + '%';
  el('#dash_plan_pct').innerText = pct + '%';

  if(chartPlan){ chartPlan.destroy(); chartPlan = null; }
  try{
    const ctxP = document.getElementById('chartPlan').getContext('2d');
    const rem = Math.max(0, (planRes.meta || 0) - (planRes.done || 0));
    chartPlan = new Chart(ctxP, {
      type:'doughnut',
      data:{
        labels:['Conclu√≠do','Restante'],
        datasets:[{ data:[planRes.done || 0, rem], backgroundColor:['#60a5fa','#374151'] }]
      },
      options:{ maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
    });
  }catch(e){ /* silent */ }

  // Invest composition small chart
  try{
    const cats = {};
    (state.investimentos||[]).forEach(it=>{
      const v = (Number(it.quantidade||0) * Number(it.preco||0));
      cats[it.categoria] = (cats[it.categoria]||0) + v;
    });
    const labels = Object.keys(cats);
    const values = labels.map(l=>cats[l]);

    if(chartInvCompSmall){ chartInvCompSmall.destroy(); chartInvCompSmall = null; }

    const ctxIel = document.getElementById('chartInvCompSmall');
    const ctxI = ctxIel && ctxIel.getContext && ctxIel.getContext('2d');
    if(ctxI){
      chartInvCompSmall = new Chart(ctxI, {
        type:'doughnut',
        data:{
          labels: labels.length ? labels : ['Sem dados'],
          datasets:[{ data: values.length ? values : [1], backgroundColor:['#60a5fa','#1e88e5','#16a34a','#f59e0b','#ef4444'] }]
        },
        options:{ maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color:'#e6eef8' } } } }
      });
    }
  }catch(e){ /* silent */ }

})( getSelectedMonthKey() || new Date().toISOString().slice(0,7) );


/* ============================================================
   üß© BLOCO C11 ‚Äî Dashboard: √öltimas transa√ß√µes / tabela
   ============================================================ */
function renderRecentTransactions(){
  const tbody = el('#dash_recent tbody'); if(!tbody) return;
  tbody.innerHTML = '';
  // mescla transacoes e fluxo, ordena por data decrescente
  const merged = []
    .concat(state.transacoes || [], state.fluxo || [])
    .slice(0) // clone
    .sort((a,b)=>{
      const da = a.date ? new Date(a.date) : new Date(0);
      const db = b.date ? new Date(b.date) : new Date(0);
      return db - da;
    })
    .slice(0, 10);

  if(!merged.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="small">Sem registros</td></tr>';
    return;
  }

  merged.forEach(r=>{
    const tr = document.createElement('tr');
    const dateStr = r.date
      ? (r.date.length===10 ? new Date(r.date+'T00:00:00').toLocaleDateString() : new Date(r.date).toLocaleDateString())
      : '-';
    const tipo = r.tipo || r.type || 'mov';
    const desc  = r.reserva || r.desc || r.ativo || '';
    const val   = formatMoney(r.valor || r.value || 0);
    tr.innerHTML = `<td>${dateStr}</td><td>${tipo}</td><td>${desc}</td><td>${val}</td>`;
    tbody.appendChild(tr);
  });
  el('#dash_updated').innerText = new Date().toLocaleString();
}


/* ============================================================
   üß© BLOCO C12 ‚Äî Export: compila texto resumido (Bloco de Notas)
   ============================================================ */
function compileExportText(){
  const resumo = computeResumoFinanceiro(getSelectedMonthKey()||new Date().toISOString().slice(0,7));
  const topCatsObj = computeCustoByCategory(getSelectedMonthKey()).cats || {};
  const topCatsList = Object.keys(topCatsObj).map(k=> `${k}: ${formatMoney(topCatsObj[k])}`).join(' ‚Ä¢ ');
  const investSummary = (state.investimentos||[]).slice(0,8).map(i => `${i.ativo} (${i.categoria}) ‚Äî ${formatMoney(Number(i.quantidade||0)*Number(i.preco||0))}`).join('\n');
  const recentTx = (state.transacoes||[]).slice(0,10).map(t=>`${t.date || ''}: ${t.reserva || ''} ${t.tipo || ''} ${formatMoney(t.valor||0)}`).join('\n');

  const text = [
    `RESUMO FINANCEIRO ‚Äî ${new Date().toLocaleDateString()}`,
    `ENTRADAS: ${formatMoney(resumo.totalEntradas)}`,
    `SA√çDAS: ${formatMoney(resumo.totalSaidas)}`,
    `RESULTADO: ${formatMoney(resumo.resultado)}`,
    `RESERVAS (total saldo): ${formatMoney(resumo.reservasTotal)}`,
    `INVESTIMENTOS (total): ${formatMoney(resumo.investimentosTotal)}`,
    `CUSTO DE VIDA (m√™s): ${formatMoney(computeCustoByCategory(getSelectedMonthKey()).total || 0)}`,
    `PRINCIPAIS CATEGORIAS: ${topCatsList || '‚Äî'}`,
    `INVESTIMENTOS (top 8):\n${investSummary || '‚Äî'}`,
    `\nTRANSA√á√ïES RECENTES:\n${recentTx || '‚Äî'}`
  ].join('\n');

  return text;
}

function exportToClipboardAndModal(){
  const txt = compileExportText();
  // tenta copiar e abre modal com textarea para colagem manual caso falhe
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(()=>{
      showModal('Exportar (Bloco de Notas) ‚Äî Texto copiado', `<textarea class="input" style="height:260px">${txt}</textarea>`, null);
      alert('Resumo copiado para a √°rea de transfer√™ncia. Cole no ChatGPT para an√°lise.');
    }).catch(()=>{
      showModal('Exportar (Bloco de Notas)', `<textarea class="input" style="height:260px">${txt}</textarea>`, null);
      alert('N√£o foi poss√≠vel copiar automaticamente. Abra o modal e copie manualmente.');
    });
  } else {
    showModal('Exportar (Bloco de Notas)', `<textarea class="input" style="height:260px">${txt}</textarea>`, null);
    alert('API de clipboard n√£o dispon√≠vel ‚Äî copie manualmente no modal.');
  }
}


/* ============================================================
   üß© BLOCO C13 ‚Äî Render All: atualiza todas as views principais
   ============================================================ */
function renderAll(){
  reorderReservationsByDefault();
  renderReservations();
  renderInvestments();
  renderFluxo();
  renderCusto();
  renderNoteTabs();
  getMonthOptions();

  const key = getSelectedMonthKey() || new Date().toISOString().slice(0,7);
  if(state.planejamento && state.planejamento[key]) renderPlanForMonth(key);

  // dashboards / charts / recents
  renderDashboard();         // calcula e cria charts principais
  renderRecentTransactions();
  enableTouchForOnclicks();  // touch handlers
}


/* ============================================================
   üß© BLOCO C14 ‚Äî INIT (executa ao carregar a p√°gina)
   ============================================================ */
(function init(){
  // ui
  if(el('#apiUrlDisplay')) el('#apiUrlDisplay').innerText = API_URL || '(n√£o configurada)';

  // load
  loadLocal();

  // seed reservas padr√£o se estiver vazio
  if(!state.reservas || !state.reservas.length) createDefaultReservas();

  // op√ß√µes de m√™s e primeira renderiza√ß√£o
  getMonthOptions();
  renderAll();

  // attach buttons (listeners)
  const btnSeed = el('#btnSeed');
  if(btnSeed) btnSeed.addEventListener('click', ()=>{ if(confirm('Criar reservas padr√£o?')) createDefaultReservas(); });

  const btnSyncAll = el('#btnSyncAll');
  if(btnSyncAll) btnSyncAll.addEventListener('click', ()=>{ syncAllToDrive(); });

  const btnHideValues = el('#btnHideValues');
  if(btnHideValues) btnHideValues.addEventListener('click', ()=>{
    state.settings.hideValues = !state.settings.hideValues;
    btnHideValues.innerText = state.settings.hideValues ? 'Mostrar Valores' : 'Ocultar Valores';
    saveLocal();
  });

  const btnExportNotes = el('#btnExportNotes');
  if(btnExportNotes) btnExportNotes.addEventListener('click', ()=>{ exportToClipboardAndModal(); });

  // MutationObserver para elementos din√¢micos (anexa touch handlers)
  const mo = new MutationObserver(muts => {
    muts.forEach(m => {
      if(m.addedNodes && m.addedNodes.length){
        m.addedNodes.forEach(node => {
          if(node.nodeType===1){
            if(node.matches && node.matches('[onclick]')) attachTouch(node);
            node.querySelectorAll && node.querySelectorAll('[onclick]').forEach(elm=>attachTouch(elm));
          }
        });
      }
    });
  });
  mo.observe(document.body, { childList:true, subtree:true });

})(); /* init */


/* ============================================================
   üß© BLOCO C15 ‚Äî MOBILE TOUCH SUPPORT
   ============================================================ */
function attachTouch(el){
  if(!el) return;
  try{
    if(el.__touchAttached) return;
    el.addEventListener('touchstart', function onTouch(e){
      // evitar m√∫ltiplos disparos e permitir comportamento nativo quando necess√°rio
      e.preventDefault();
      el.click();
    }, {passive:false});
    el.__touchAttached = true;
  }catch(err){ /* ignore */ }
}
function enableTouchForOnclicks(){
  document.querySelectorAll('[onclick]').forEach(el => attachTouch(el));
  document.querySelectorAll('.btn, .btn-ghost, button').forEach(b=>{
    if(!b.__touchAttached){
      b.addEventListener('touchstart', function(e){ e.preventDefault(); b.click(); }, {passive:false});
      b.__touchAttached = true;
    }
  });
}


/* ============================================================
   üß© BLOCO C16 ‚Äî Debug helpers expostos
   ============================================================ */
window._borges_state = state;
window.saveLocal = saveLocal;


/* ============================================================
   üß© BLOCO C17 ‚Äî Drive Sync / Google API helpers (mantive)
   ============================================================ */
/* NOTE: as functions abaixo s√£o as mesmas que voc√™ tinha ‚Äî mantive
   id do client, nome do arquivo, upload/download e a integra√ß√£o gapi. */

if (!state.assets) state.assets = [];
if (!state.settings) state.settings = { hideValues:false };
if (!state.settings.hidden) state.settings.hidden = {};

function toggleHideArea(area){
  state.settings.hidden[area] = !state.settings.hidden[area];
  saveLocal();
}
function toggleHideTab(tabId){
  state.settings.hidden['tab_'+tabId] = !state.settings.hidden['tab_'+tabId];
  updateTabVisibility();
  saveLocal();
}
function updateTabVisibility(){
  document.querySelectorAll('.page').forEach(p=>{
    const id = p.id;
    if(state.settings.hidden['tab_'+id]) p.style.display = 'none';
  });
  if (typeof renderAll === "function") renderAll();
}

/* ===== GOOGLE DRIVE integration (mantive a l√≥gica id√™ntica) ===== */
const DRIVE_CLIENT_ID = '929006917338-i9ucbhout981fjje6e6n7njs8kdpk9h7.apps.googleusercontent.com';
const DRIVE_FILE_NAME = 'borges_panel_sync.json';
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';
const AUTO_CREATE_BACKUP_BEFORE_UPDATE = true;
const BACKUP_PREFIX = 'borges_panel_backup_';

let gapiInited = false;
let authInstance = null;

function initGAPI(){
  return new Promise((resolve,reject)=>{
    if(gapiInited) return resolve();
    gapi.load('client:auth2', async ()=>{
      try{
        await gapi.client.init({ clientId: DRIVE_CLIENT_ID, scope: DRIVE_SCOPE });
        authInstance = gapi.auth2.getAuthInstance();
        gapiInited = true;
        resolve();
      }catch(e){ reject(e); }
    });
  });
}
async function isSignedIn(){ try{ await initGAPI(); return authInstance.isSignedIn.get(); } catch(e){ return false; } }
async function signInDrive(){ try{ await initGAPI(); await authInstance.signIn(); showDriveStatus('Conectado'); await downloadFromDriveIfExists(); }catch(e){ alert('Erro ao conectar ao Google Drive'); } }
function signOutDrive(){ if(authInstance) authInstance.signOut(); showDriveStatus('Desconectado'); }
function showDriveStatus(t){ const elStatus = document.getElementById('driveStatus'); if(elStatus) elStatus.innerText = t; }

async function findDriveFileByName(name){
  await initGAPI();
  const q = `name='${name.replace(/'/g,"\\'")}' and trashed=false`;
  const r = await gapi.client.drive.files.list({ q, fields:'files(id,name,modifiedTime)' });
  return r.result.files?.[0] || null;
}
async function downloadDriveFile(id){
  await initGAPI();
  const r = await gapi.client.drive.files.get({ fileId:id, alt:'media' });
  try { return JSON.parse(r.body); } catch{ return r.result; }
}
async function createDriveFile(name, content){
  await initGAPI();
  const boundary = '-------31415926535';
  const body =
`--${boundary}
Content-Type: application/json

{"name":"${name}","mimeType":"application/json"}
--${boundary}
Content-Type: application/json

${JSON.stringify(content)}
--${boundary}--`;

  const r = await gapi.client.request({
    path:'/upload/drive/v3/files',
    method:'POST',
    params:{ uploadType:'multipart' },
    headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
    body
  });
  return r.result;
}
async function updateDriveFile(id, content){
  await initGAPI();
  const boundary = '-------31415926535';
  const body =
`--${boundary}
Content-Type: application/json

{"name":"${DRIVE_FILE_NAME}"}
--${boundary}
Content-Type: application/json

${JSON.stringify(content)}
--${boundary}--`;

  const r = await gapi.client.request({
    path:`/upload/drive/v3/files/${id}`,
    method:'PATCH',
    params:{ uploadType:'multipart' },
    headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
    body
  });
  return r.result;
}
async function downloadFromDriveIfExists(){
  if(!await isSignedIn()) return;
  showDriveStatus('Sincronizando...');
  const file = await findDriveFileByName(DRIVE_FILE_NAME);
  if(!file) { showDriveStatus('Arquivo n√£o encontrado'); return; }
  state = Object.assign({}, state, await downloadDriveFile(file.id));
  saveLocal();
  showDriveStatus('Dados carregados');
}
async function uploadStateToDrive(){
  if(!await isSignedIn()) return;
  const payload = Object.assign({}, state);
  const file = await findDriveFileByName(DRIVE_FILE_NAME);
  if(!file){
    await createDriveFile(DRIVE_FILE_NAME, payload);
    showDriveStatus('Criado');
  } else {
    if(AUTO_CREATE_BACKUP_BEFORE_UPDATE){
      await createDriveFile(BACKUP_PREFIX + new Date().toISOString().replace(/[:.]/g,'-') + '.json', payload);
    }
    await updateDriveFile(file.id, payload);
    showDriveStatus('Atualizado');
  }
}

/* hook para auto-upload ap√≥s saveLocal */
(function autoHook(){
  const original = saveLocal;
  window.saveLocal = function(){
    original();
    try{ setTimeout(()=>uploadStateToDrive(),600); }catch(e){}
  };
})();

function attachDriveControls(a,b,c,d){
  document.addEventListener('DOMContentLoaded', ()=>{
    const eA = document.getElementById(a);
    const eB = document.getElementById(b);
    const eC = document.getElementById(c);
    const eD = document.getElementById(d);
    if(eA) eA.onclick = signInDrive;
    if(eB) eB.onclick = signOutDrive;
    if(eC) eC.onclick = uploadStateToDrive;
    if(eD) eD.innerText = 'Desconectado';
  });
}

window.driveSync = {
  initGAPI, signInDrive, signOutDrive,
  uploadStateToDrive, downloadFromDriveIfExists,
  attachDriveControls
};


/* ============================================================
   üß© BLOCO C18 ‚Äî Enhancements (inclus√£o externa)
   ============================================================ */
/* enhancements.js √© carregado no final do HTML ‚Äî mantive a refer√™ncia.
   Ele controla ocultar valores, novas abas, pequenas UX tweaks.
   Se precisar alterar: abra enhancements.js. */

/* ============================================================
   üß© BLOCO C19 ‚Äî FINALIZA√á√ÉO: garantir renderiza√ß√µes finais
   ============================================================ */
renderRecentTransactions(); // garante tabela inicial
// Observador de mudan√ßa de estado central j√° faz re-render quando salvar
