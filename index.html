<!-- PARTE 1/5 - Painel Borges (início: head + estilos + header + início do Dashboard) -->
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel Borges Participações e Holding • Reservas • Investimentos</title>

<style>
/* ================= STYLES (mantive sua paleta de cores) ================= */
:root{
  --bg:#041022;
  --panel:#061021;
  --card:#071427;
  --muted:#9aa4b2;
  --accent:#1e88e5;
  --accent-2:#60a5fa;
  --success:#16a34a;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.03);
  --radius:12px;
  --shadow: 0 8px 24px rgba(2,6,23,0.55);
  --font: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --btn-ghost-border: rgba(255,255,255,0.10);
  --btn-ghost-bg: rgba(255,255,255,0.02);
  --btn-text: #e6eef8;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);background:linear-gradient(180deg,#041022 0%, #071827 100%);color:var(--btn-text)}
header{display:flex;gap:12px;align-items:center;padding:12px 18px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid rgba(255,255,255,0.02);position:sticky;top:0;z-index:30}
.brand{font-weight:900;color:var(--accent);font-size:18px}
.subtitle{color:var(--muted);font-size:13px;margin-left:6px}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tab{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;cursor:pointer;color:var(--btn-text)}
.tab.active{background:linear-gradient(90deg, rgba(30,136,229,0.12), rgba(96,165,250,0.04));border-color:rgba(30,136,229,0.2);font-weight:700}
.card{background:var(--panel);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);margin-top:12px;border:1px solid rgba(255,255,255,0.03)}
.row{display:flex;gap:12px;align-items:center}
.spacer{flex:1}
.small{font-size:13px;color:var(--muted)}
.grid{display:grid;gap:12px}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-2{grid-template-columns:repeat(2,1fr)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left;font-size:14px}
.input, textarea, select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--btn-text);width:100%}
.btn{
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  color: white;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  box-shadow: 0 6px 18px rgba(30,136,229,0.12);
}
.btn:hover{filter:brightness(1.03)}
.btn-ghost{
  background: var(--btn-ghost-bg);
  border:1px solid var(--btn-ghost-border);
  color: var(--btn-text);
  padding:7px 10px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.btn-ghost:hover{ background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.18) }
/* Botão profissional para ocultar valores */
.btn-pro{
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--btn-text);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
/* Export btn refined */
.btn-export{
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--btn-text);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
.progress{height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
.bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
.badge{background:rgba(255,255,255,0.03);padding:6px;border-radius:6px;color:var(--muted);font-size:13px}
.kv{display:inline-block;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.02);margin-right:8px}
.checkbox-tri{width:22px;height:22px;border-radius:5px;border:1px solid rgba(255,255,255,0.08);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:var(--btn-ghost-bg);color:var(--btn-text);font-weight:700}
.modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;pointer-events:auto}
.modal-card{background:#061021;padding:16px;border-radius:12px;width:92%;max-width:720px;border:1px solid rgba(255,255,255,0.03);pointer-events:auto}
.note-tab{display:inline-block;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-right:6px;cursor:pointer;color:var(--btn-text)}
.note-tab.active{background:linear-gradient(90deg, rgba(30,136,229,0.12), rgba(96,165,250,0.04));font-weight:700}
.res-card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:grab}
.res-card.dragging{opacity:0.5;transform:scale(0.98)}
.icon{font-weight:900;margin-right:6px}
.alert-banner{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border-left:4px solid rgba(255,255,255,0.06);margin-top:10px;color:var(--muted)}
@media(max-width:900px){ .cols-3{grid-template-columns:1fr} .cols-2{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start} .topbar{gap:6px} }
canvas{width:100%;height:150px;background:transparent;border-radius:8px}
</style>
</head>
<body>

<header>
  <div>
    <div class="brand">Painel Borges Participações</div>
    <div class="subtitle">Holding • Reservas • Investimentos</div>
  </div>
  <div class="spacer"></div>
  <div class="small">Offline + Drive sync (API configurada)</div>
</header>

<div class="container">
  <div class="card topbar">
    <!-- TABS -->
    <div class="tab active" data-tab="dashboard">Dashboard</div>
    <div class="tab" data-tab="custo">Custo de Vida</div>
    <div class="tab" data-tab="planejamento">Planejamento Mensal</div>
    <div class="tab" data-tab="fluxo">Fluxo Diário</div>
    <div class="tab" data-tab="reservas">Reservas</div>
    <div class="tab" data-tab="investimentos">Investimentos</div>
    <div class="tab" data-tab="caderno">Bloco de Notas</div>
    <div class="tab" data-tab="backup">Backup</div>

    <div class="spacer"></div>

    <button id="btnSeed" class="btn-ghost">Criar Padrões</button>
    <button id="btnSyncAll" class="btn">Sincronizar com Drive</button>
    <button id="btnHideValues" class="btn-pro">Ocultar Valores</button>
    <button id="btnExportNotes" class="btn-export">Exportar (Bloco de Notas)</button>
  </div>

  <!-- ============== DASHBOARD ============== -->
  <div id="dashboard" class="page card" style="margin-top:12px">
    <h2>Dashboard</h2>

    <div id="dash_alert" class="alert-banner" style="display:none"></div>

    <!-- TOP STATS -->
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Entradas</div>
        <div id="dash_entradas" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Lançamentos: <span id="count_entradas">0</span></div>
      </div>
      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Saídas</div>
        <div id="dash_saidas" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Lançamentos: <span id="count_saidas">0</span></div>
      </div>
      <div class="card" style="flex:1;min-width:220px">
        <div class="small">Resultado</div>
        <div id="dash_resultado" style="font-weight:800;font-size:22px">R$ 0,00</div>
        <div class="small">Status: <span id="dash_result_status">—</span></div>
      </div>
    </div>

    <!-- RESERVAS — PROGRESSO GERAL -->
    <div class="card" style="flex:1;min-width:220px;margin-top:12px">
      <div style="font-weight:600;margin-bottom:6px">Reservas — total</div>
      <div id="dash_reservas_total" style="font-size:20px;font-weight:700">R$ 0,00</div>
      <div class="small">Quantidade de reservas: <span id="dash_reservas_count">0</span></div>

      <div style="margin-top:10px;font-weight:600">Progresso das reservas</div>
      <div class="progress" style="height:10px;margin-top:6px;background:#eee;border-radius:8px;overflow:hidden">
        <div id="reservas_progress_bar" class="bar" style="width:0%;background:#00c853;transition:width 0.4s ease"></div>
      </div>
      <div id="reservas_progress_text" class="small">0%</div>
    </div>

    <!-- 1) CUSTO DE VIDA ATUAL -->
    <div class="card" id="dash_custo_card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small">Custo de Vida (mês)</div>
          <div id="dash_custo_total" style="font-weight:800;font-size:22px">R$ 0,00</div>
          <div class="small" id="dash_custo_month_label"></div>
        </div>
        <div style="width:320px">
          <canvas id="chartCustoTop" height="160"></canvas>
        </div>
      </div>
    </div>

    <!-- 2) FLUXO DIÁRIO RESUMIDO -->
    <div class="card" id="dash_fluxo_card" style="margin-top:12px">
      <h3>Fluxo Diário — Resumo do Mês</h3>

      <div class="row" style="margin-top:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:220px">
          <div class="small">Entradas no mês</div>
          <div id="dash_fluxo_entradas" style="font-weight:800;font-size:20px">R$ 0,00</div>
        </div>
        <div style="flex:1;min-width:220px">
          <div class="small">Saídas no mês</div>
          <div id="dash_fluxo_saidas" style="font-weight:800;font-size:20px">R$ 0,00</div>
        </div>
        <div style="flex:1;min-width:220px">
          <div class="small">Resultado</div>
          <div id="dash_fluxo_resultado" style="font-weight:800;font-size:20px">R$ 0,00</div>
        </div>
      </div>

      <div style="margin-top:14px">
        <canvas id="chartFluxMonthly" height="180"></canvas>
      </div>
    </div>

    <!-- 3) INVESTIMENTOS — RESUMO -->
    <div class="card" id="dash_inv_card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small">Investimentos</div>
          <div id="dash_inv_total" style="font-weight:800;font-size:22px">R$ 0,00</div>
          <div class="small">Quantidade de ativos: <span id="dash_inv_count">0</span></div>
        </div>
        <div style="width:300px;max-width:100%">
          <canvas id="chartInvCompSmall" height="160"></canvas>
        </div>
      </div>
    </div>

  </div> <!-- FIM DASHBOARD -->


  <!-- ======================================================================== -->
  <!-- ============================ CUSTO DE VIDA ============================= -->
  <!-- ======================================================================== -->

  <div id="custo" class="page card" style="display:none;margin-top:12px">
    <h2>Custo de Vida</h2>

    <div class="row" style="margin-top:12px;flex-wrap:wrap">
      <input id="cv_date" type="date" class="input" style="max-width:160px"/>
      <input id="cv_desc" placeholder="Descrição" class="input" style="flex:1"/>
      <select id="cv_cat" class="input" style="max-width:180px">
        <option value="Geral">Geral</option>
        <option value="Cartão de Crédito">Cartão de Crédito</option>
        <option value="Casa">Casa</option>
        <option value="Mercado">Mercado</option>
        <option value="Levy">Levy</option>
        <option value="Pet">Pet</option>
      </select>
      <input id="cv_valor" type="number" class="input" placeholder="Valor (R$)" style="max-width:150px"/>
      <button class="btn" onclick="addCusto()">+ Adicionar</button>
    </div>

    <div class="card" style="margin-top:12px">
      <table class="table" id="custoTable">
        <thead>
          <tr>
            <th>Data</th>
            <th>Descrição</th>
            <th>Categoria</th>
            <th>Valor</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button class="btn-ghost" style="margin-top:12px" onclick="clearCustoMonth()">Limpar mês atual</button>
  </div>


  <!-- ======================================================================== -->
  <!-- ======================== PLANEJAMENTO MENSAL =========================== -->
  <!-- ======================================================================== -->

  <div id="planejamento" class="page card" style="display:none;margin-top:12px">
    <h2>Planejamento Mensal</h2>

    <div class="row" style="margin-top:12px;flex-wrap:wrap">
      <select id="plan_mes" class="input" style="max-width:200px"></select>
      <button class="btn" onclick="createPlanForMonth()">Criar / Carregar Mês</button>
    </div>

    <div id="planPeriods" style="margin-top:12px"></div>

    <div class="card" style="margin-top:12px">
      <strong>Resumo</strong>
      <div id="plan_summary" class="small" style="margin-top:6px"></div>
    </div>
  </div>


  <!-- ======================================================================== -->
  <!-- ============================== FLUXO DIÁRIO ============================ -->
  <!-- ======================================================================== -->

  <div id="fluxo" class="page card" style="display:none;margin-top:12px">
    <h2>Fluxo Diário</h2>

    <div class="row" style="margin-top:12px;flex-wrap:wrap">
      <input id="fx_date" type="date" class="input" style="max-width:160px"/>
      <input id="fx_desc" placeholder="Descrição" class="input" style="flex:1"/>
      <select id="fx_type" class="input" style="max-width:140px">
        <option value="entrada">Entrada</option>
        <option value="saida">Saída</option>
      </select>
      <select id="fx_payment" class="input" style="max-width:200px">
        <option value="Pix">Pix</option>
        <option value="Crédito">Crédito</option>
        <option value="Débito">Débito</option>
        <option value="Dinheiro">Dinheiro</option>
      </select>
      <input id="fx_valor" type="number" class="input" placeholder="Valor (R$)" style="max-width:150px"/>
      <button class="btn" onclick="addFluxo()">+ Adicionar</button>
    </div>

    <div class="card" style="margin-top:12px">
      <table class="table" id="fluxoTable">
        <thead>
          <tr>
            <th>Data</th>
            <th>Descrição</th>
            <th>Tipo</th>
            <th>Pagamento</th>
            <th>Valor</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


  <!-- ======================================================================== -->
  <!-- ============================= RESERVAS ================================= -->
  <!-- ======================================================================== -->

  <div id="reservas" class="page card" style="display:none;margin-top:12px">
    <h2>Reservas</h2>

    <div class="row" style="margin-top:12px;flex-wrap:wrap">
      <input id="r_name" placeholder="Nome" class="input"/>
      <input id="r_meta" type="number" class="input" placeholder="Meta (R$)" style="max-width:160px"/>
      <input id="r_init" type="number" class="input" placeholder="Valor Inicial" style="max-width:160px"/>
      <button class="btn" onclick="addReservation()">+ Criar</button>
    </div>

    <div id="resCards" class="grid cols-2" style="margin-top:12px"></div>
  </div>

  <!-- ======================================================================== -->
  <!-- =============================== INVESTIMENTOS ========================== -->
  <!-- ======================================================================== -->

  <div id="investimentos" class="page card" style="display:none;margin-top:12px">
    <h2>Investimentos</h2>

    <div class="row" style="margin-top:12px;flex-wrap:wrap">
      <input id="inv_ativo" placeholder="Ativo" class="input"/>
      <select id="inv_categoria" class="input" style="max-width:200px">
        <option value="Ações">Ações</option>
        <option value="FIIs">FIIs</option>
        <option value="Renda Fixa">Renda Fixa</option>
        <option value="Cripto">Cripto</option>
        <option value="Outros">Outros</option>
      </select>
      <input id="inv_qtd" type="number" class="input" placeholder="Qtd" style="max-width:100px"/>
      <input id="inv_preco" type="number" class="input" placeholder="Preço (R$)" style="max-width:150px"/>
      <button class="btn" onclick="addInvestment()">+ Adicionar</button>
    </div>

    <div class="card" style="margin-top:12px">
      <table class="table" id="invTable">
        <thead>
          <tr>
            <th>Ativo</th>
            <th>Categoria</th>
            <th>Qtd</th>
            <th>Preço</th>
            <th>Total</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


  <!-- ======================================================================== -->
  <!-- ================================ CADERNO =============================== -->
  <!-- ======================================================================== -->

  <div id="caderno" class="page card" style="display:none;margin-top:12px">
    <h2>Caderno de Anotações</h2>

    <!-- Criar nova aba -->
    <div class="row" style="margin-top:12px;flex-wrap:wrap">
      <input id="note_tab_name" placeholder="Nome da aba" class="input"/>
      <button class="btn" onclick="createNoteTab()">+ Criar Aba</button>
    </div>

    <div id="noteTabs" class="row" style="gap:8px;margin-top:12px;flex-wrap:wrap"></div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="flex-wrap:wrap">
        <input id="note_block_title" placeholder="Título do bloco" class="input" style="flex:1"/>
        <button class="btn" onclick="addBlock()">+ Bloco</button>
      </div>

      <div id="noteBlocks" style="margin-top:12px"></div>
    </div>
  </div>


  <!-- ======================================================================== -->
  <!-- ================================ CONFIG ================================ -->
  <!-- ======================================================================== -->

  <div id="config" class="page card" style="display:none;margin-top:12px">
    <h2>Configurações</h2>

    <div style="margin-top:12px">
      <button class="btn-ghost" id="btnHideValues">Ocultar Valores</button>
    </div>

    <div style="margin-top:12px">
      <strong>Backup Local</strong><br/>
      <button class="btn" onclick="exportAll()">Exportar (JSON)</button>
      <input type="file" id="fileImport" style="margin-top:6px"/>
      <button class="btn" style="margin-top:6px" onclick="importAll()">Importar JSON</button>
    </div>

    <div style="margin-top:20px">
      <strong>Reset Total</strong><br/>
      <button class="btn-ghost" style="margin-top:6px;background:#922" onclick="resetPainel()">Zerar tudo</button>
    </div>
  </div>


  <!-- ======================================================================== -->
  <!-- ================================ MODAL ================================= -->
  <!-- ======================================================================== -->

  <div id="modalEdit" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <div id="modalBody" style="margin-top:12px"></div>
      <div class="row" style="margin-top:18px;justify-content:flex-end">
        <button class="btn-ghost" onclick="closeModal()">Cancelar</button>
        <button class="btn" onclick="confirmModal()">Salvar</button>
      </div>
    </div>
  </div>

</div> <!-- FIM WRAPPER -->



<!-- ======================================================================== -->
<!-- ========================= SCRIPTS PRINCIPAIS =========================== -->
<!-- ======================================================================== -->

<script>
/* ======= STATE GLOBAL ======= */
let state = {
  reservas: [],
  transacoes: [],
  investimentos: [],
  fluxo: [],
  custo: [],
  planejamento: {},
  caderno: [],
  settings: { hideValues:false },
  assets: []
};

/* ===== Utils ===== */
function uid(p){ return p + '_' + Math.random().toString(36).substr(2,9); }
function el(q){ return document.querySelector(q); }
function els(q){ return document.querySelectorAll(q); }
function nowISO(){ return new Date().toISOString(); }
function formatMoney(v){
  v = Number(v||0);
  return v.toLocaleString('pt-BR',{ style:'currency', currency:'BRL' });
}

/* ===== LOCAL STORAGE ===== */
function saveLocal(){
  try{ localStorage.setItem('borges_panel', JSON.stringify(state)); }
  catch(e){ console.error('Erro ao salvar local',e); }
}
function loadLocal(){
  try{
    const s = localStorage.getItem('borges_panel');
    if(s) state = JSON.parse(s);
  }catch(e){ console.error('Erro ao carregar local',e); }
}

/* ===== Navegação ===== */
els('.nav-item').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    els('.nav-item').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    const page = el('#'+btn.dataset.page);
    els('.page').forEach(p=> p.style.display='none');
    if(page) page.style.display='block';
    renderAll();
  });
});

/* ===== Defaults & Helpers for Reservations ===== */
function createDefaultReservas(){
  const defaults = [
    {name:'Reserva de Segurança',meta:24000},
    {name:'Veículos',meta:3000},
    {name:'Roupas / Lazer / Levy',meta:1000},
    {name:'Gatona',meta:600},
    {name:'Reserva Levy 18 anos',meta:1000},
    {name:'Oportunidades',meta:5000},
    {name:'Terreno/Lexus Eventos',meta:50000},
    {name:'Apartamento',meta:20000},
    {name:'Dividas',meta:0}
  ];
  defaults.forEach((d,i)=>{
    if(!state.reservas.find(r=>r.name===d.name)){
      state.reservas.push({ id: uid('r'), name: d.name, meta: d.meta || 0, saldo: 0, order: i, obs:'', updated: nowISO() });
    }
  });
  reorderReservationsByDefault();
  saveLocal();
}
function reorderReservationsByDefault(){
  const priority = [
    'Reserva de Segurança','Veículos','Roupas / Lazer / Levy','Gatona',
    'Reserva Levy 18 anos','Oportunidades','Terreno/Lexus Eventos',
    'Apartamento','Dividas'
  ];
  state.reservas.forEach(r=>{
    if(r.order===undefined || r.order===null)
      r.order = priority.indexOf(r.name) !== -1 ? priority.indexOf(r.name) : 999;
  });
  state.reservas.sort((a,b)=> (a.order||999) - (b.order||999) );
}

/* ======= RESERVAS CRUD ======= */
function addReservation(){
  const name = el('#r_name').value.trim();
  const meta = Number(el('#r_meta').value) || 0;
  const init = Number(el('#r_init').value) || 0;
  if(!name){ alert('Nome da reserva é obrigatório'); return; }
  const id = uid('r');
  const maxOrder = state.reservas.reduce((m,x)=>Math.max(m,x.order||0),0);
  const r = { id, name, meta, saldo: init, order: maxOrder+1, obs:'', updated: nowISO() };
  state.reservas.push(r);
  if(init>0){
    state.transacoes.unshift({
      id: uid('t'),
      date: nowISO(),
      reserva: name,
      tipo:'aporte',
      valor:init,
      nota:'Inicial'
    });
  }
  el('#r_name').value='';
  el('#r_meta').value='';
  el('#r_init').value='';
  saveLocal();
  renderReservations();
}

function renderReservations(){
  const container = el('#resCards'); if(!container) return;
  container.innerHTML='';
  state.reservas.sort((a,b)=> (a.order||0) - (b.order||0));

  if(!state.reservas.length){
    container.innerHTML = '<div class="small">Nenhuma reserva</div>';
    renderReservasProgress();
    return;
  }

  state.reservas.forEach(r=>{
    const pct = r.meta ? Math.round((r.saldo / r.meta) * 100) : 0;
    const card = document.createElement('div');
    card.className = 'res-card';
    card.setAttribute('draggable','true');
    card.dataset.id = r.id;

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${r.name}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn-ghost" onclick="promptAporte(event,'${r.id}')">+ Aportar</button>
          <button class="btn-ghost" onclick="promptRetirar(event,'${r.id}')">- Retirar</button>
          <button class="btn-ghost" onclick="openEditReservation('${r.id}')">✎ Editar</button>
          <button class="btn-ghost" onclick="removeReserva('${r.id}')">✖ Excluir</button>
        </div>
      </div>

      <div style="margin-top:8px" class="small">Meta: ${formatMoney(r.meta)}</div>
      <div style="margin-top:6px;font-weight:800">${formatMoney(r.saldo)}</div>

      <div style="margin-top:8px">
        <div class="progress">
          <div class="bar"
            style="width:${Math.min(100,pct)}%;
                   transition:width 0.5s;
                   background:${pct>=100 ? '#00c853'
                     : pct>=50 ? '#ffd600'
                     : '#d50000'};">
          </div>
        </div>
        <div class="small">${pct}%</div>
      </div>
    `;

    card.addEventListener('dragstart', ev=>{
      card.classList.add('dragging');
      ev.dataTransfer.setData('text/plain', r.id);
    });
    card.addEventListener('dragend', ()=> card.classList.remove('dragging'));
    card.addEventListener('dragover', ev=> ev.preventDefault());
    card.addEventListener('drop', ev=>{
      ev.preventDefault();
      const draggedId = ev.dataTransfer.getData('text/plain');
      handleReservaDrop(draggedId, r.id);
    });

    container.appendChild(card);
  });

  renderReservasProgress();
}

function handleReservaDrop(draggedId, targetId){
  const dragged = state.reservas.find(r=>r.id===draggedId);
  const target = state.reservas.find(r=>r.id===targetId);
  if(!dragged || !target) return;
  dragged.order = (target.order || 0) - 0.5;
  state.reservas.sort((a,b)=> (a.order||0) - (b.order||0));
  state.reservas.forEach((r,i)=> r.order = i);
  saveLocal();
  renderReservations();
}

function promptAporte(ev, id){
  ev.stopPropagation();
  const v = Number(prompt('Valor do aporte R$','0')) || 0;
  if(v<=0) return;
  aporteReserva(id, v, 'Aporte manual');
}
function promptRetirar(ev, id){
  ev.stopPropagation();
  const v = Number(prompt('Valor da retirada R$','0')) || 0;
  if(v<=0) return;
  retirarReserva(id, v, 'Retirada manual');
}

function aporteReserva(id, valor, nota){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  r.saldo = Number(r.saldo||0) + Number(valor||0);
  r.updated = nowISO();
  state.transacoes.unshift({
    id: uid('t'),
    date: nowISO(),
    reserva: r.name,
    tipo:'aporte',
    valor,
    nota: nota||''
  });
  saveLocal();
  renderReservations();
}

function retirarReserva(id, valor, nota){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  r.saldo = Number(r.saldo||0) - Number(valor||0);
  r.updated = nowISO();
  state.transacoes.unshift({
    id: uid('t'),
    date: nowISO(),
    reserva: r.name,
    tipo:'retirada',
    valor,
    nota: nota||''
  });
  saveLocal();
  renderReservations();
}

function removeReserva(id){
  if(!confirm('Excluir reserva e histórico?')) return;
  const r = state.reservas.find(x=>x.id===id);
  state.reservas = state.reservas.filter(x=>x.id!==id);
  state.transacoes = state.transacoes.filter(t=> t.reserva !== (r? r.name : ''));
  saveLocal();
  renderReservations();
}

function openEditReservation(id){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  showModal('Editar Reserva', `
    <label>Nome</label>
    <input id="modal_r_name" class="input" value="${r.name}"/>

    <label>Meta (R$)</label>
    <input id="modal_r_meta" type="number" class="input" value="${r.meta}"/>

    <label>Saldo Atual (R$)</label>
    <input id="modal_r_saldo" type="number" class="input" value="${r.saldo}"/>

    <label>Observações</label>
    <textarea id="modal_r_obs" class="input">${r.obs||''}</textarea>
  `, function(){
    r.name  = document.getElementById('modal_r_name').value.trim();
    r.meta  = Number(document.getElementById('modal_r_meta').value)  || 0;
    r.saldo = Number(document.getElementById('modal_r_saldo').value) || 0;
    r.obs   = document.getElementById('modal_r_obs').value || '';
    r.updated = nowISO();
    saveLocal();
    renderReservations();
  });
}

function renderReservasProgress(){
  const reservas = state.reservas || [];
  const bar = el('#reservas_progress_bar');
  const text = el('#reservas_progress_text');

  if (!reservas.length){
    if(bar) bar.style.width = '0%';
    if(text) text.innerText = '0%';
    return;
  }

  const totalSaldo = reservas.reduce((s,r)=> s + Number(r.saldo||0), 0);
  const totalMeta  = reservas.reduce((s,r)=> s + Number(r.meta ||0), 0);

  const pct = totalMeta>0 ? Math.min(100, Math.round((totalSaldo/totalMeta)*100)) : 0;

  if(bar){
    bar.style.width = pct+'%';
    bar.style.background = pct>=100 ? '#00c853'
                     : pct>=50 ? '#ffd600'
                     : '#d50000';
  }
  if(text) text.innerText = pct+'%';
}

/* ================================ INVESTIMENTOS ================================ */

function addInvestment(){
  const name = el('#inv_ativo').value.trim();
  const cat  = el('#inv_categoria').value;
  const qtd  = Number(el('#inv_qtd').value)   || 0;
  const preco= Number(el('#inv_preco').value) || 0;

  if(!name){ alert('Nome do ativo é obrigatório'); return; }

  const inv = {
    id: uid('i'),
    ativo: name,
    categoria: cat,
    quantidade: qtd,
    preco: preco,
    updated: nowISO()
  };

  state.investimentos.push(inv);
  el('#inv_ativo').value='';
  el('#inv_qtd').value='';
  el('#inv_preco').value='';
  saveLocal();
  renderInvestments();
}

function renderInvestments(){
  const tbody = el('#invTable tbody'); if(!tbody) return;
  tbody.innerHTML='';

  if(!state.investimentos.length){
    tbody.innerHTML='<tr><td colspan="6" class="small">Nenhum investimento</td></tr>';
    return;
  }

  state.investimentos.forEach(it=>{
    const total = (Number(it.quantidade||0) * Number(it.preco||0));
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.ativo}</td>
      <td>${it.categoria}</td>
      <td>${it.quantidade}</td>
      <td>${formatMoney(it.preco)}</td>
      <td>${formatMoney(total)}</td>
      <td>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn-ghost" onclick="openEditInvestment('${it.id}')">Editar</button>
          <button class="btn-ghost" onclick="removeInvestment('${it.id}')">Remover</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function openEditInvestment(id){
  const it = state.investimentos.find(x=>x.id===id);
  if(!it) return;

  showModal('Editar Investimento', `
    <label>Ativo</label>
    <input id="modal_i_name" class="input" value="${it.ativo}"/>

    <label>Categoria</label>
    <input id="modal_i_cat" class="input" value="${it.categoria}"/>

    <label>Quantidade</label>
    <input id="modal_i_qtd" type="number" class="input" value="${it.quantidade}"/>

    <label>Preço Unitário</label>
    <input id="modal_i_preco" type="number" class="input" value="${it.preco}"/>
  `, function(){
    it.ativo = document.getElementById('modal_i_name').value;
    it.categoria = document.getElementById('modal_i_cat').value;
    it.quantidade = Number(document.getElementById('modal_i_qtd').value)||0;
    it.preco = Number(document.getElementById('modal_i_preco').value)||0;
    it.updated = nowISO();
    saveLocal();
    renderInvestments();
  });
}

function removeInvestment(id){
  if(!confirm('Remover investimento?')) return;
  state.investimentos = state.investimentos.filter(x=>x.id!==id);
  saveLocal();
  renderInvestments();
}



/* ================================ FLUXO DIÁRIO ================================ */

function addFluxo(){
  const date = el('#fx_date').value || new Date().toISOString().slice(0,10);
  const desc = el('#fx_desc').value || '(sem descrição)';
  const type = el('#fx_type').value;
  const pay  = el('#fx_payment').value;
  const val  = Number(el('#fx_valor').value) || 0;

  if(val<=0) return alert('Valor deve ser maior que zero');

  state.fluxo.unshift({
    id: uid('f'),
    date, desc, type, payment: pay, value: val
  });

  el('#fx_desc').value='';
  el('#fx_valor').value='';
  el('#fx_date').value='';
  saveLocal();
  renderFluxo();
}

function renderFluxo(){
  const tbody = el('#fluxoTable tbody'); if(!tbody) return;
  tbody.innerHTML='';

  if(!state.fluxo.length){
    tbody.innerHTML='<tr><td colspan="6" class="small">Sem lançamentos</td></tr>';
    return;
  }

  state.fluxo.slice(0,200).forEach(f=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(f.date+'T00:00:00').toLocaleDateString()}</td>
      <td>${f.desc}</td>
      <td>${f.type}</td>
      <td>${f.payment}</td>
      <td>${formatMoney(f.value)}</td>
      <td>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-ghost" onclick="editFlux('${f.id}')">Editar</button>
          <button class="btn-ghost" onclick="removeFlux('${f.id}')">Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editFlux(id){
  const f = state.fluxo.find(x=>x.id===id);
  if(!f) return;

  showModal('Editar Fluxo',`
    <label>Data</label>
    <input id="modal_fx_date" class="input" type="date" value="${f.date}"/>

    <label>Descrição</label>
    <input id="modal_fx_desc" class="input" value="${f.desc}"/>

    <label>Tipo</label>
    <select id="modal_fx_type" class="input">
      <option value="entrada">Entrada</option>
      <option value="saida">Saída</option>
    </select>

    <label>Pagamento</label>
    <input id="modal_fx_payment" class="input" value="${f.payment}"/>

    <label>Valor</label>
    <input id="modal_fx_valor" class="input" type="number" value="${f.value}"/>
  `, function(){
    f.date = document.getElementById('modal_fx_date').value || f.date;
    f.desc = document.getElementById('modal_fx_desc').value;
    f.type = document.getElementById('modal_fx_type').value;
    f.payment = document.getElementById('modal_fx_payment').value;
    f.value = Number(document.getElementById('modal_fx_valor').value)||0;
    saveLocal();
    renderFluxo();
  });
}

function removeFlux(id){
  if(!confirm('Excluir lançamento?')) return;
  state.fluxo = state.fluxo.filter(f=>f.id!==id);
  saveLocal();
  renderFluxo();
}



/* ================================ CUSTO DE VIDA ================================ */

function addCusto(){
  const date = el('#cv_date').value || new Date().toISOString().slice(0,10);
  const desc = el('#cv_desc').value || '(sem descrição)';
  const cat  = el('#cv_cat').value;
  const val  = Number(el('#cv_valor').value)||0;

  if(val<=0) return alert('Valor deve ser maior que zero');

  state.custo.unshift({
    id: uid('c'),
    date, desc, cat, value: val
  });

  state.transacoes.unshift({
    id: uid('t'),
    date: nowISO(),
    reserva: 'Custo de Vida',
    tipo: 'saida',
    valor: val,
    nota: desc
  });

  el('#cv_desc').value='';
  el('#cv_valor').value='';
  el('#cv_date').value='';
  saveLocal();
  renderCusto();
}

function renderCusto(){
  const tbody = el('#custoTable tbody'); if(!tbody) return;
  tbody.innerHTML='';

  if(!state.custo.length){
    tbody.innerHTML='<tr><td colspan="5" class="small">Sem lançamentos</td></tr>';
    return;
  }

  const month = getSelectedMonthKey();
  const rows = state.custo.filter(c=>{
    if(!month) return true; return c.date.slice(0,7)===month;
  });

  rows.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(c.date+'T00:00:00').toLocaleDateString()}</td>
      <td>${c.desc}</td>
      <td>${c.cat}</td>
      <td>${formatMoney(c.value)}</td>
      <td>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-ghost" onclick="editCusto('${c.id}')">Editar</button>
          <button class="btn-ghost" onclick="removeCusto('${c.id}')">Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editCusto(id){
  const c = state.custo.find(x=>x.id===id); if(!c) return;

  showModal('Editar Custo',`
    <label>Data</label><input id="modal_c_date" type="date" class="input" value="${c.date}"/>
    <label>Descrição</label><input id="modal_c_desc" class="input" value="${c.desc}"/>
    <label>Categoria</label><input id="modal_c_cat" class="input" value="${c.cat}"/>
    <label>Valor</label><input id="modal_c_valor" type="number" class="input" value="${c.value}"/>
  `, function(){
    c.date = document.getElementById('modal_c_date').value || c.date;
    c.desc = document.getElementById('modal_c_desc').value;
    c.cat  = document.getElementById('modal_c_cat').value;
    c.value= Number(document.getElementById('modal_c_valor').value)||0;
    saveLocal();
    renderCusto();
  });
}

function removeCusto(id){
  if(!confirm('Excluir custo?')) return;
  state.custo = state.custo.filter(x=>x.id!==id);
  saveLocal();
  renderCusto();
}

function clearCustoMonth(){
  const month = getSelectedMonthKey();
  if(!month) return alert('Selecione um mês');
  if(!confirm('Remover todos os custos do mês '+month+'?')) return;
  state.custo = state.custo.filter(c=>c.date.slice(0,7)!==month);
  saveLocal();
  renderCusto();
}



/* ================================ PLANEJAMENTO ================================ */

function getMonthOptions(){
  const sel = el('#plan_mes'); if(!sel) return;
  sel.innerHTML='';
  const today = new Date();
  for(let i=0;i<12;i++){
    const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
    const key = d.toISOString().slice(0,7);
    const opt = document.createElement('option');
    opt.value = key;
    opt.innerText = key;
    sel.appendChild(opt);
  }
}

function getSelectedMonthKey(){
  return el('#plan_mes') ? el('#plan_mes').value : null;
}

function createPlanForMonth(){
  const key = getSelectedMonthKey();
  if(!key) return alert('Selecione um mês');

  if(!state.planejamento[key]){
    state.planejamento[key] = {
      periods:{
        p1:{meta:0,items:[]},
        p2:{meta:0,items:[]},
        p3:{meta:0,items:[]}
      }
    };
  }
  renderPlanForMonth(key);
}

function renderPlanForMonth(key){
  const container = el('#planPeriods'); if(!container) return;
  container.innerHTML='';

  const p = state.planejamento[key].periods;
  const labels = ['Dia 01 - 10','Dia 11 - 20','Dia 21 - 30'];

  ['p1','p2','p3'].forEach((pid,idx)=>{
    const box = document.createElement('div');
    box.className='card';
    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${labels[idx]}</strong>
        <div>
          <input id="meta_${pid}" class="input" type="number"
            placeholder="Meta faturamento"
            value="${p[pid].meta || 0}" style="width:200px"/>
        </div>
      </div>

      <div style="margin-top:8px">
        <button class="btn" onclick="addPlanItem('${key}','${pid}')">+ Conta</button>
        <button class="btn-ghost" onclick="clearPlanPeriod('${key}','${pid}')">Limpar</button>
      </div>

      <div id="items_${pid}" style="margin-top:8px"></div>
    `;

    container.appendChild(box);

    renderPlanItems(key,pid);

    setTimeout(()=>{
      const elMeta = document.getElementById('meta_'+pid);
      if(elMeta){
        elMeta.addEventListener('change', e=>{
          p[pid].meta = Number(e.target.value)||0;
          saveLocal();
          renderPlanSummary(key);
        });
      }
    },100);
  });

  renderPlanSummary(key);
}


function addPlanItem(monthKey,pid){
  const desc = prompt('Descrição da conta'); if(!desc) return;
  let input = prompt('Valor (R$)','0');
  if(!input) return;

  input = input.replace(/\./g,'').replace(',','.');
  const val = parseFloat(input)||0;

  const item = { id: uid('pl'), desc, value: val, state:0 };

  state.planejamento[monthKey].periods[pid].items.push(item);
  saveLocal();
  renderPlanItems(monthKey,pid);
  renderPlanSummary(monthKey);
}

function renderPlanItems(monthKey,pid){
  const div = el('#items_'+pid); if(!div) return;
  div.innerHTML='';

  const items = state.planejamento[monthKey].periods[pid].items || [];

  items.forEach(it=>{
    const row = document.createElement('div');
    row.style.display='flex';
    row.style.justifyContent='space-between';
    row.style.padding='6px 0';

    row.innerHTML = `
      <div style="display:flex;gap:8px;align-items:center">
        <div class="checkbox-tri"
             onclick="togglePlanItem('${monthKey}','${pid}','${it.id}')">
          ${it.state===1?'✔':(it.state===2?'✖':'')}
        </div>
        <div>${it.desc} — <span class="small">${formatMoney(it.value)}</span></div>
      </div>
      <div>
        <button class="btn-ghost" onclick="editPlanItem('${monthKey}','${pid}','${it.id}')">Editar</button>
        <button class="btn-ghost" onclick="removePlanItem('${monthKey}','${pid}','${it.id}')">Excluir</button>
      </div>
    `;

    div.appendChild(row);
  });
}

function togglePlanItem(monthKey,pid,itemId){
  const it = state.planejamento[monthKey].periods[pid].items.find(i=>i.id===itemId);
  if(!it) return;
  it.state = (it.state+1)%3;
  saveLocal();
  renderPlanItems(monthKey,pid);
  renderPlanSummary(monthKey);
}

function editPlanItem(monthKey,pid,itemId){
  const it = state.planejamento[monthKey].periods[pid].items.find(i=>i.id===itemId);
  if(!it) return;

  const desc = prompt('Descrição', it.desc);
  if(desc===null) return;
  const val = Number(prompt('Valor', it.value))||0;

  it.desc = desc;
  it.value = val;

  saveLocal();
  renderPlanItems(monthKey,pid);
  renderPlanSummary(monthKey);
}

function removePlanItem(monthKey,pid,itemId){
  if(!confirm('Remover item?')) return;
  let arr = state.planejamento[monthKey].periods[pid].items;
  arr = arr.filter(i=>i.id!==itemId);
  state.planejamento[monthKey].periods[pid].items = arr;
  saveLocal();
  renderPlanItems(monthKey,pid);
  renderPlanSummary(monthKey);
}

function clearPlanPeriod(monthKey,pid){
  if(!confirm('Limpar período?')) return;
  state.planejamento[monthKey].periods[pid].items = [];
  saveLocal();
  renderPlanItems(monthKey,pid);
  renderPlanSummary(monthKey);
}

function renderPlanSummary(key){
  if(!key){
    el('#plan_summary').innerText='Nenhum planejamento selecionado';
    return;
  }

  const p = state.planejamento[key].periods;

  const meta = (p.p1.meta||0)+(p.p2.meta||0)+(p.p3.meta||0);
  const total = (p.p1.items||[]).reduce((s,i)=>s+i.value,0)
              +(p.p2.items||[]).reduce((s,i)=>s+i.value,0)
              +(p.p3.items||[]).reduce((s,i)=>s+i.value,0);

  el('#plan_summary').innerText = `Meta (3 períodos): ${formatMoney(meta)} — Contas: ${formatMoney(total)}`;
}



/* ================================ CADERNO ================================ */

function createNoteTab(){
  const name = el('#note_tab_name').value.trim();
  if(!name) return alert('Nome obrigatório');

  const tab = { id: uid('nt'), name, blocks: [] };
  state.caderno.push(tab);

  el('#note_tab_name').value='';
  saveLocal();
  renderNoteTabs();

  setTimeout(()=>{
    const tabs = document.querySelectorAll('#noteTabs .note-tab');
    tabs.forEach(t=>{
      if(t.dataset.id===tab.id) t.classList.add('active');
      else t.classList.remove('active');
    });
    renderNoteBlocks(tab.id);
  },50);
}

function renderNoteTabs(){
  const container = el('#noteTabs'); if(!container) return;
  container.innerHTML='';

  if(!state.caderno.length){
    container.innerHTML='<div class="small">Nenhuma aba criada</div>';
    return;
  }

  state.caderno.forEach(t=>{
    const div = document.createElement('div');
    div.className='note-tab';
    div.dataset.id=t.id;

    div.innerHTML = `
      <span>${t.name}</span>
      <button class="btn-ghost" onclick="editNoteTab('${t.id}')">✎</button>
      <button class="btn-ghost" onclick="removeNoteTab('${t.id}')">✖</button>
    `;

    div.onclick = ev=>{
      if(ev.target.tagName==='BUTTON') return;
      els('.note-tab').forEach(x=>x.classList.remove('active'));
      div.classList.add('active');
      renderNoteBlocks(t.id);
    };

    div.setAttribute('draggable','true');
    div.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', t.id));
    div.addEventListener('dragover', e=> e.preventDefault());
    div.addEventListener('drop', e=>{
      e.preventDefault();
      const draggedId = e.dataTransfer.getData('text/plain');
      reorderNoteTabs(draggedId, t.id);
    });

    container.appendChild(div);
  });
}

function editNoteTab(tabId){
  const t = state.caderno.find(x=>x.id===tabId); if(!t) return;
  const newName = prompt('Renomear aba', t.name);
  if(newName===null) return;
  t.name = newName.trim()||t.name;
  saveLocal();
  renderNoteTabs();
  renderNoteBlocks(t.id);
}

function removeNoteTab(tabId){
  if(!confirm('Remover aba e blocos?')) return;
  state.caderno = state.caderno.filter(x=>x.id!==tabId);
  saveLocal();
  renderNoteTabs();
  el('#noteBlocks').innerHTML='';
}

function reorderNoteTabs(draggedId,targetId){
  const i1 = state.caderno.findIndex(x=>x.id===draggedId);
  const i2 = state.caderno.findIndex(x=>x.id===targetId);
  if(i1===-1 || i2===-1) return;

  const [item] = state.caderno.splice(i1,1);
  state.caderno.splice(i2,0,item);
  saveLocal();
  renderNoteTabs();
}

function addBlock(){
  const title = el('#note_block_title').value.trim();
  if(!title) return alert('Título obrigatório');

  const activeEl = document.querySelector('.note-tab.active');
  if(!activeEl) return alert('Selecione uma aba');

  const tab = state.caderno.find(t=>t.id===activeEl.dataset.id);
  tab.blocks.push({ id: uid('b'), title, items: [] });

  el('#note_block_title').value='';
  saveLocal();
  renderNoteBlocks(tab.id);
}

function renderNoteBlocks(tabId){
  const tab = state.caderno.find(t=>t.id===tabId);
  if(!tab){ el('#noteBlocks').innerHTML=''; return; }

  const container = el('#noteBlocks');
  container.innerHTML='';

  tab.blocks.forEach(block=>{
    const box = document.createElement('div');
    box.className='card';
    box.style.marginBottom='10px';

    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${block.title}</strong>
        <div>
          <button class="btn-ghost" onclick="addItemPrompt('${tab.id}','${block.id}')">+ Item</button>
          <button class="btn-ghost" onclick="removeBlock('${tab.id}','${block.id}')">Excluir bloco</button>
        </div>
      </div>
      <div id="items_${block.id}" style="margin-top:8px"></div>
    `;

    box.setAttribute('draggable','true');
    box.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({tab:tab.id,block:block.id}));
    });
    box.addEventListener('dragover', e=>e.preventDefault());
    box.addEventListener('drop', e=>{
      e.preventDefault();
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      reorderBlocks(data.tab, data.block, tab.id, block.id);
    });

    container.appendChild(box);
    renderItems(tab.id, block.id);
  });
}

function reorderBlocks(srcTabId,srcBlockId,tgtTabId,tgtBlockId){
  const srcTab = state.caderno.find(t=>t.id===srcTabId);
  const tgtTab = state.caderno.find(t=>t.id===tgtTabId);
  if(!srcTab || !tgtTab) return;

  const bi = srcTab.blocks.findIndex(b=>b.id===srcBlockId);
  const [block] = srcTab.blocks.splice(bi,1);

  const ti = tgtTab.blocks.findIndex(b=>b.id===tgtBlockId);
  tgtTab.blocks.splice(ti,0,block);

  saveLocal();
  renderNoteTabs();
  renderNoteBlocks(tgtTab.id);
}

function addItemPrompt(tabId,blockId){
  const text = prompt('Descrição do item');
  if(!text) return;

  const tab = state.caderno.find(t=>t.id===tabId);
  const block = tab.blocks.find(b=>b.id===blockId);
  block.items.push({ id: uid('it'), text, state:0 });

  saveLocal();
  renderItems(tabId,blockId);
}

function renderItems(tabId,blockId){
  const tab = state.caderno.find(t=>t.id===tabId); if(!tab) return;
  const block = tab.blocks.find(b=>b.id===blockId); if(!block) return;

  const container = el('#items_'+block.id); if(!container) return;
  container.innerHTML='';

  block.items.forEach(it=>{
    const row = document.createElement('div');
    row.style.display='flex';
    row.style.padding='6px 0';
    row.style.justifyContent='space-between';

    row.innerHTML = `
      <div style="display:flex;gap:8px;align-items:center">
        <div class="checkbox-tri"
             onclick="toggleItemState('${tabId}','${blockId}','${it.id}')">
          ${it.state===1?'✔':(it.state===2?'✖':'')}
        </div>
        <div>${it.text}</div>
      </div>
      <div>
        <button class="btn-ghost" onclick="editItem('${tabId}','${blockId}','${it.id}')">Editar</button>
        <button class="btn-ghost" onclick="removeItem('${tabId}','${blockId}','${it.id}')">Excluir</button>
      </div>
    `;

    container.appendChild(row);
  });
}

function toggleItemState(tabId,blockId,itemId){
  const it = state.caderno.find(t=>t.id===tabId)
                .blocks.find(b=>b.id===blockId)
                .items.find(i=>i.id===itemId);

  it.state = (it.state+1)%3;
  saveLocal();
  renderItems(tabId,blockId);
}

function editItem(tabId,blockId,itemId){
  const it = state.caderno.find(t=>t.id===tabId)
                .blocks.find(b=>b.id===blockId)
                .items.find(i=>i.id===itemId);

  const txt = prompt('Editar item', it.text);
  if(txt===null) return;
  it.text = txt;

  saveLocal();
  renderItems(tabId,blockId);
}

function removeItem(tabId,blockId,itemId){
  if(!confirm('Remover item?')) return;
  const block = state.caderno.find(t=>t.id===tabId).blocks.find(b=>b.id===blockId);
  block.items = block.items.filter(i=>i.id!==itemId);
  saveLocal();
  renderItems(tabId,blockId);
}

function removeBlock(tabId,blockId){
  if(!confirm('Remover bloco?')) return;
  const tab = state.caderno.find(t=>t.id===tabId);
  tab.blocks = tab.blocks.filter(b=>b.id!==blockId);
  saveLocal();
  renderNoteBlocks(tabId);
}



/* ================================ MODAL ================================ */

let modalCallback = null;

function showModal(title,html,cb){
  el('#modalTitle').innerText = title;
  el('#modalBody').innerHTML   = html;
  el('#modalEdit').style.display='flex';
  modalCallback = cb;
}

function closeModal(){
  el('#modalEdit').style.display='none';
  modalCallback = null;
}

function confirmModal(){
  if(modalCallback) modalCallback();
  closeModal();
}



/* ===================== EXPORT / IMPORT ===================== */

function exportAll(){
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');

  a.href=url;
  a.download = 'borges_backup_'+new Date().toISOString().slice(0,10)+'.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importAll(){
  const f = el('#fileImport').files[0];
  if(!f) return alert('Escolha um arquivo JSON');

  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const parsed = JSON.parse(e.target.result);
      state = parsed;
      if(!state.settings) state.settings = { hideValues:false };
      saveLocal();
      alert('Backup importado com sucesso!');
      location.reload();
    }catch(err){
      alert('Arquivo inválido.');
    }
  };
  reader.readAsText(f);
}



/* ===================== RESET TOTAL ===================== */

function resetPainel(){
  const c = confirm("Tem certeza que deseja apagar TODOS os dados?");
  if(!c) return;

  const v = prompt('Digite: ZERAR');
  if(v!=="ZERAR"){
    alert('Cancelado.');
    return;
  }

  localStorage.clear();
  alert('Painel zerado com sucesso!');
  location.reload();
}



/* ===================== RESUMOS E DASHBOARD ===================== */

function computeResumoFinanceiro(monthKey){
  const entradasTrans = (state.transacoes||[])
    .filter(t=>t.tipo==='entrada' || t.tipo==='aporte')
    .reduce((s,t)=>s+Number(t.valor||0),0);

  const entradasFluxo = (state.fluxo||[])
    .filter(f=>f.type==='entrada')
    .reduce((s,f)=>s+Number(f.value||0),0);

  const totalEntradas = entradasTrans + entradasFluxo;

  const saidasTrans = (state.transacoes||[])
    .filter(t=>t.tipo==='saida' || t.tipo==='retirada')
    .reduce((s,t)=>s+Number(t.valor||0),0);

  const saidasFluxo = (state.fluxo||[])
    .filter(f=>f.type==='saida')
    .reduce((s,f)=>s+Number(f.value||0),0);

  const totalSaidas = saidasTrans + saidasFluxo;

  const reservasTotal = (state.reservas||[])
    .reduce((s,r)=>s+Number(r.saldo||0),0);

  const investimentosTotal = (state.investimentos||[])
    .reduce((s,i)=>s+(Number(i.quantidade||0)*Number(i.preco||0)),0);

  return {
    totalEntradas,
    totalSaidas,
    resultado: totalEntradas-totalSaidas,
    reservasTotal,
    investimentosTotal
  };
}


function computeCustoByCategory(monthKey){
  const cats={};
  for(const c of state.custo){
    if(!c.date) continue;
    if(c.date.slice(0,7)!==monthKey) continue;
    cats[c.cat]=(cats[c.cat]||0)+Number(c.value||0);
  }
  const labels = Object.keys(cats);
  const values = labels.map(l=>cats[l]);
  const total  = values.reduce((a,b)=>a+b,0);
  return { labels, values, total, cats };
}


function computeFluxoMonthly(monthKey){
  const entriesByDay={}, exitsByDay={};

  for(const f of state.fluxo){
    if(!f.date) continue;
    if(f.date.slice(0,7)!==monthKey) continue;

    const d = Number(f.date.slice(8,10));

    if(f.type==='entrada')
      entriesByDay[d]=(entriesByDay[d]||0)+Number(f.value||0);
    else
      exitsByDay[d]=(exitsByDay[d]||0)+Number(f.value||0);
  }

  const allDays = Object.keys(entriesByDay).map(Number)
                 .concat(Object.keys(exitsByDay).map(Number))
                 .concat([30]);

  const maxDay = Math.max(...allDays);

  const labels=[], entriesArr=[], exitsArr=[];
  let tE=0, tS=0;

  for(let d=1;d<=maxDay;d++){
    labels.push(String(d).padStart(2,'0'));
    const e = entriesByDay[d]||0;
    const s = exitsByDay[d]||0;
    entriesArr.push(e);
    exitsArr.push(s);
    tE+=e; tS+=s;
  }

  return {
    labels,
    entriesArr,
    exitsArr,
    totalEntries: tE,
    totalExits: tS,
    net: tE-tS
  };
}


function computePlanProgress(monthKey){
  if(!monthKey || !state.planejamento[monthKey]){
    return { meta:0,done:0,pct:0 };
  }

  const p = state.planejamento[monthKey].periods;

  const meta = (p.p1.meta||0)+(p.p2.meta||0)+(p.p3.meta||0);

  const done =
      (p.p1.items||[]).reduce((s,i)=>s+(i.state===1?i.value:0),0)
     +(p.p2.items||[]).reduce((s,i)=>s+(i.state===1?i.value:0),0)
     +(p.p3.items||[]).reduce((s,i)=>s+(i.state===1?i.value:0),0);

  const pct = meta? Math.round((done/meta)*100):0;

  return { meta, done, pct };
}



/* ===================== RENDER DASHBOARD ===================== */

function renderDashboard(){
  const monthKey = getSelectedMonthKey() || new Date().toISOString().slice(0,7);

  const resumo = computeResumoFinanceiro(monthKey);
  el('#dash_entradas').innerText = formatMoney(resumo.totalEntradas);
  el('#dash_saidas').innerText   = formatMoney(resumo.totalSaidas);
  el('#dash_resultado').innerText= formatMoney(resumo.resultado);
  el('#dash_result_status').innerText = resumo.resultado>=0?'Positivo':'Negativo';

  el('#dash_reservas_total').innerText = formatMoney(resumo.reservasTotal);
  el('#dash_reservas_count').innerText = (state.reservas||[]).length;

  el('#dash_invest_total').innerText  = formatMoney(resumo.investimentosTotal);
  el('#dash_inv_count').innerText = (state.investimentos||[]).length;

  const custoRes = computeCustoByCategory(monthKey);
  el('#dash_custo_total').innerText = formatMoney(custoRes.total);
  el('#dash_custo_month_label').innerText = monthKey;

  const alertEl = el('#dash_alert');
  if(custoRes.total > resumo.totalEntradas){
    alertEl.style.display='block';
    alertEl.innerText='Alerta: custo de vida ultrapassa as entradas!';
    alertEl.style.borderLeft='4px solid var(--danger)';
  }else{
    if(custoRes.total===0) alertEl.style.display='none';
    else{
      alertEl.style.display='block';
      alertEl.innerText='Custo de vida dentro da margem.';
      alertEl.style.borderLeft='4px solid var(--success)';
    }
  }

  // Gráfico Custo (doughnut)
  try{
    if(window.chartCustoTop) chartCustoTop.destroy();
    const ctxC = document.getElementById('chartCustoTop').getContext('2d');
    window.chartCustoTop = new Chart(ctxC,{
      type:'doughnut',
      data:{
        labels: custoRes.labels.length? custoRes.labels:['Sem dados'],
        datasets:[{
          data: custoRes.values.length? custoRes.values:[1],
          backgroundColor:['#60a5fa','#1e88e5','#16a34a','#f59e0b','#ef4444','#7c3aed']
        }]
      },
      options:{ maintainAspectRatio:false }
    });
  }catch(e){}

  const fluxoRes = computeFluxoMonthly(monthKey);
  el('#dash_fluxo_entries').innerText = formatMoney(fluxoRes.totalEntries);
  el('#dash_fluxo_exits').innerText   = formatMoney(fluxoRes.totalExits);
  el('#dash_fluxo_net').innerText     = formatMoney(fluxoRes.net);

  try{
    if(window.chartFluxMonthly) chartFluxMonthly.destroy();
    const ctxF = document.getElementById('chartFluxMonthly').getContext('2d');
    window.chartFluxMonthly = new Chart(ctxF,{
      type:'bar',
      data:{
        labels: fluxoRes.labels,
        datasets:[
          { label:'Entradas', data:fluxoRes.entriesArr, backgroundColor:'#16a34a' },
          { label:'Saídas',   data:fluxoRes.exitsArr,   backgroundColor:'#ef4444' }
        ]
      },
      options:{ maintainAspectRatio:false }
    });
  }catch(e){}


  const planRes = computePlanProgress(monthKey);
  el('#dash_plan_meta').innerText = `Meta: ${formatMoney(planRes.meta)}`;
  el('#dash_plan_done').innerText = `Concluído: ${formatMoney(planRes.done)}`;

  const pct = Math.min(100,Math.max(0,planRes.pct||0));
  el('#dash_plan_bar').style.width = pct+'%';
  el('#dash_plan_pct').innerText = pct+'%';

  try{
    if(window.chartPlan) chartPlan.destroy();
    const ctxP = document.getElementById('chartPlan').getContext('2d');
    const restante = Math.max(0,(planRes.meta||0)-(planRes.done||0));

    window.chartPlan = new Chart(ctxP,{
      type:'doughnut',
      data:{
        labels:['Concluído','Restante'],
        datasets:[{
          data:[planRes.done||0, restante],
          backgroundColor:['#60a5fa','#374151']
        }]
      },
      options:{ maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
  }catch(e){}

  // Gráfico Investimentos mini
  try{
    const cats={};
    state.investimentos.forEach(it=>{
      const v = Number(it.quantidade||0)*Number(it.preco||0);
      cats[it.categoria] = (cats[it.categoria]||0)+v;
    });
    const labels = Object.keys(cats);
    const values = labels.map(l=>cats[l]);

    if(window.chartInvCompSmall) chartInvCompSmall.destroy();
    const ctxI = document.getElementById('chartInvCompSmall').getContext('2d');
    window.chartInvCompSmall = new Chart(ctxI,{
      type:'doughnut',
      data:{
        labels: labels.length?labels:['Sem dados'],
        datasets:[{
          data: values.length?values:[1],
          backgroundColor:['#60a5fa','#1e88e5','#16a34a','#f59e0b','#ef4444']
        }]
      },
      options:{ maintainAspectRatio:false }
    });
  }catch(e){}

  const tbody = el('#dash_recent tbody'); if(!tbody) return;
  tbody.innerHTML='';

  const recent = [].concat(state.transacoes||[], state.fluxo||[])
                   .sort((a,b)=> (b.date > a.date ? 1 : -1))
                   .slice(0,10);

  if(!recent.length){
    tbody.innerHTML='<tr><td colspan="4">Sem registros</td></tr>';
  }else{
    recent.forEach(r=>{
      const d = r.date ? new Date(r.date).toLocaleDateString() : '-';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d}</td>
        <td>${r.tipo || r.type}</td>
        <td>${r.reserva || r.desc || r.ativo || ''}</td>
        <td>${formatMoney(r.valor || r.value || 0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  el('#dash_updated').innerText = new Date().toLocaleString();
}



/* ===================== RENDER ALL ===================== */

function renderAll(){
  reorderReservationsByDefault();
  renderReservations();
  renderInvestments();
  renderFluxo();
  renderCusto();
  renderNoteTabs();
  getMonthOptions();
  const key = getSelectedMonthKey() || new Date().toISOString().slice(0,7);
  if(state.planejamento[key]) renderPlanForMonth(key);
  renderDashboard();
  enableTouchForOnclicks();
}



/* ===================== TOUCH SUPPORT ===================== */

function attachTouch(el){
  if(!el || el.__touchAttached) return;

  el.addEventListener('touchstart',function(e){
    e.preventDefault();
    el.click();
  },{passive:false});

  el.__touchAttached=true;
}

function enableTouchForOnclicks(){
  document.querySelectorAll('[onclick]').forEach(el=>attachTouch(el));
  document.querySelectorAll('.btn, .btn-ghost, button')
    .forEach(b=>{
      if(!b.__touchAttached){
        b.addEventListener('touchstart',function(e){
          e.preventDefault();
          b.click();
        },{passive:false});
        b.__touchAttached=true;
      }
    });
}



/* ===================== INIT ===================== */

(function init(){
  loadLocal();
  if(!state.reservas.length) createDefaultReservas();

  getMonthOptions();
  renderAll();

  el('#btnHideValues').innerText = state.settings.hideValues ? 'Mostrar Valores' : 'Ocultar Valores';

  el('#btnHideValues').addEventListener('click',()=>{
    state.settings.hideValues = !state.settings.hideValues;
    el('#btnHideValues').innerText = state.settings.hideValues ? 'Mostrar Valores' : 'Ocultar Valores';
    saveLocal();
  });
})();

</script>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- enhancements.js EMBUTIDO -->
<script>
</script>

</body>
</html>


