<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel Borges Participações e  Holding • Reservas • Investimentos</title>
<style>
/* ================= STYLES (mantive sua paleta de cores) ================= */
:root{
  --bg:#041022;
  --panel:#061021;
  --card:#071427;
  --muted:#9aa4b2;
  --accent:#1e88e5;
  --accent-2:#60a5fa;
  --success:#16a34a;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.03);
  --radius:12px;
  --shadow: 0 8px 24px rgba(2,6,23,0.55);
  --font: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --btn-ghost-border: rgba(255,255,255,0.10);
  --btn-ghost-bg: rgba(255,255,255,0.02);
  --btn-text: #e6eef8;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);background:linear-gradient(180deg,#041022 0%, #071827 100%);color:var(--btn-text)}
header{display:flex;gap:12px;align-items:center;padding:12px 18px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid rgba(255,255,255,0.02);position:sticky;top:0;z-index:30}
.brand{font-weight:900;color:var(--accent);font-size:18px}
.subtitle{color:var(--muted);font-size:13px;margin-left:6px}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tab{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;cursor:pointer;color:var(--btn-text)}
.tab.active{background:linear-gradient(90deg, rgba(30,136,229,0.12), rgba(96,165,250,0.04));border-color:rgba(30,136,229,0.2);font-weight:700}
.card{background:var(--panel);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);margin-top:12px;border:1px solid rgba(255,255,255,0.03)}
.row{display:flex;gap:12px;align-items:center}
.spacer{flex:1}
.small{font-size:13px;color:var(--muted)}
.grid{display:grid;gap:12px}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-2{grid-template-columns:repeat(2,1fr)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:left;font-size:14px}
.input, textarea, select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--btn-text);width:100%}
.btn{
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  color: white;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  box-shadow: 0 6px 18px rgba(30,136,229,0.12);
}
.btn:hover{filter:brightness(1.03)}
.btn-ghost{
  background: var(--btn-ghost-bg);
  border:1px solid var(--btn-ghost-border);
  color: var(--btn-text);
  padding:7px 10px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.btn-ghost:hover{ background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.18) }
/* Botão profissional para ocultar valores */
.btn-pro{
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--btn-text);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
/* Export btn refined */
.btn-export{
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--btn-text);
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
.progress{height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
.bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
.badge{background:rgba(255,255,255,0.03);padding:6px;border-radius:6px;color:var(--muted);font-size:13px}
.kv{display:inline-block;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.02);margin-right:8px}
.checkbox-tri{width:22px;height:22px;border-radius:5px;border:1px solid rgba(255,255,255,0.08);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:var(--btn-ghost-bg);color:var(--btn-text);font-weight:700}
.modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;pointer-events:auto}
.modal-card{background:#061021;padding:16px;border-radius:12px;width:92%;max-width:720px;border:1px solid rgba(255,255,255,0.03);pointer-events:auto}
.note-tab{display:inline-block;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-right:6px;cursor:pointer;color:var(--btn-text)}
.note-tab.active{background:linear-gradient(90deg, rgba(30,136,229,0.12), rgba(96,165,250,0.04));font-weight:700}
.res-card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:grab}
.res-card.dragging{opacity:0.5;transform:scale(0.98)}
.icon{font-weight:900;margin-right:6px}
.alert-banner{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border-left:4px solid rgba(255,255,255,0.06);margin-top:10px;color:var(--muted)}
@media(max-width:900px){ .cols-3{grid-template-columns:1fr} .cols-2{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start} .topbar{gap:6px} }
canvas{width:100%;height:150px;background:transparent;border-radius:8px}
</style>
</head>
<body>
/* ===== Persistence ===== */
const STATE_KEY = 'borges_panel_3_v1';
function saveLocal(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); renderAll(); }
function loadLocal(){
  try{
    const raw = localStorage.getItem(STATE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      // merge with default keys
      state = Object.assign(state, parsed);
      if(!state.settings) state.settings = { hideValues:false };
    }
  }catch(e){ console.error('Erro parse local', e); }
}

/* ===== Format depending on hide values ===== */
function formatMoney(v){
  if(state && state.settings && state.settings.hideValues) return 'R$ ••••';
  return moneyBRFormatted(v);
}

/* ===== UI: tabs wiring (safe) ===== */
els('.tab').forEach(t=>t.addEventListener('click', (e)=>{
  els('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  els('.page').forEach(p=>p.style.display='none');
  const id = t.dataset.tab;
  const page = document.getElementById(id);
  if(page) page.style.display='block';
  renderAll();
}));

/* ===== Defaults & Helpers for Reservations ===== */
function createDefaultReservas(){
  const defaults = [
    {name:'Reserva de Segurança',meta:24000},
    {name:'Veículos',meta:3000},
    {name:'Roupas / Lazer / Levy',meta:1000},
    {name:'Gatona',meta:600},
    {name:'Reserva Levy 18 anos',meta:1000},
    {name:'Oportunidades',meta:5000},
    {name:'Terreno/Lexus Eventos',meta:50000},
    {name:'Apartamento',meta:20000},
    {name:'Dividas',meta:0}
  ];
  defaults.forEach((d,i)=>{
    if(!state.reservas.find(r=>r.name===d.name)){
      state.reservas.push({ id: uid('r'), name: d.name, meta: d.meta || 0, saldo: 0, order: i, obs:'', updated: nowISO() });
    }
  });
  reorderReservationsByDefault();
  saveLocal();
}
function reorderReservationsByDefault(){
  const priority = ['Reserva de Segurança','Veículos','Roupas / Lazer / Levy','Gatona','Reserva Levy 18 anos','Oportunidades','Terreno/Lexus Eventos','Apartamento','Dividas'];
  state.reservas.forEach(r=>{ if(r.order===undefined || r.order===null) r.order = priority.indexOf(r.name) !== -1 ? priority.indexOf(r.name) : 999; });
  state.reservas.sort((a,b)=> (a.order||999) - (b.order||999) );
}

/* ======= RESERVAS CRUD (mantive suas funções) ======= */
function addReservation(){
  const name = el('#r_name').value.trim();
  const meta = Number(el('#r_meta').value) || 0;
  const init = Number(el('#r_init').value) || 0;
  if(!name){ alert('Nome da reserva é obrigatório'); return; }
  const id = uid('r');
  const maxOrder = state.reservas.reduce((m,x)=>Math.max(m,x.order||0),0);
  const r = { id, name, meta, saldo: init, order: maxOrder+1, obs:'', updated: nowISO() };
  state.reservas.push(r);
  if(init>0){
    state.transacoes.unshift({ id: uid('t'), date: nowISO(), reserva: name, tipo:'aporte', valor:init, nota:'Inicial' });
  }
  el('#r_name').value=''; el('#r_meta').value=''; el('#r_init').value='';
  saveLocal();
  renderReservations(); // Atualiza imediatamente a tela e o progresso
}

function renderReservations(){
  const container = el('#resCards'); if(!container) return;
  container.innerHTML='';
  state.reservas.sort((a,b)=> (a.order||0) - (b.order||0));

  if(!state.reservas.length){
    container.innerHTML = '<div class="small">Nenhuma reserva</div>';
    renderReservasProgress(); // Zera a barra se não houver reservas
    return;
  }

  state.reservas.forEach(r=>{
    const pct = r.meta ? Math.round((r.saldo / r.meta) * 100) : 0;
    const card = document.createElement('div');
    card.className = 'res-card';
    card.setAttribute('draggable','true');
    card.dataset.id = r.id;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${r.name}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn-ghost" onclick="promptAporte(event,'${r.id}')">+ Aportar</button>
          <button class="btn-ghost" onclick="promptRetirar(event,'${r.id}')">- Retirar</button>
          <button class="btn-ghost" onclick="openEditReservation('${r.id}')">✎ Editar</button>
          <button class="btn-ghost" onclick="removeReserva('${r.id}')">✖ Excluir</button>
        </div>
      </div>
      <div style="margin-top:8px" class="small">Meta: ${formatMoney(r.meta)}</div>
      <div style="margin-top:6px;font-weight:800">${formatMoney(r.saldo)}</div>
      <div style="margin-top:8px">
        <div class="progress"><div class="bar" style="width:${Math.min(100,pct)}%;transition:width 0.5s;background:${pct>=100 ? '#00c853' : pct>=50 ? '#ffd600' : '#d50000'};"></div></div>
        <div class="small">${pct}%</div>
      </div>
    `;
    card.addEventListener('dragstart', (ev)=>{ card.classList.add('dragging'); ev.dataTransfer.setData('text/plain', r.id); });
    card.addEventListener('dragend', ()=>{ card.classList.remove('dragging'); });
    card.addEventListener('dragover', (ev)=>{ ev.preventDefault(); });
    card.addEventListener('drop', (ev)=>{ ev.preventDefault(); const draggedId = ev.dataTransfer.getData('text/plain'); handleReservaDrop(draggedId, r.id); });
    container.appendChild(card);
  });

  renderReservasProgress(); // Atualiza a barra geral de progresso
}

function handleReservaDrop(draggedId, targetId){
  const dragged = state.reservas.find(r=>r.id===draggedId);
  const target = state.reservas.find(r=>r.id===targetId);
  if(!dragged || !target) return;
  dragged.order = (target.order || 0) - 0.5;
  state.reservas.sort((a,b)=> (a.order||0) - (b.order||0));
  state.reservas.forEach((r,i)=> r.order = i);
  saveLocal();
  renderReservations();
}

function promptAporte(ev, id){
  ev.stopPropagation();
  const v = Number(prompt('Valor do aporte R$','0')) || 0;
  if(v<=0) return;
  aporteReserva(id, v, 'Aporte manual');
}

function promptRetirar(ev, id){
  ev.stopPropagation();
  const v = Number(prompt('Valor da retirada R$','0')) || 0;
  if(v<=0) return;
  retirarReserva(id, v, 'Retirada manual');
}

function aporteReserva(id, valor, nota){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  r.saldo = Number(r.saldo||0) + Number(valor||0);
  r.updated = nowISO();
  state.transacoes.unshift({ id: uid('t'), date: nowISO(), reserva: r.name, tipo:'aporte', valor: Number(valor), nota: nota||'' });
  saveLocal();
  renderReservations();
}

function retirarReserva(id, valor, nota){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  r.saldo = Number(r.saldo||0) - Number(valor||0);
  r.updated = nowISO();
  state.transacoes.unshift({ id: uid('t'), date: nowISO(), reserva: r.name, tipo:'retirada', valor: Number(valor), nota: nota||'' });
  saveLocal();
  renderReservations();
}

function removeReserva(id){
  if(!confirm('Excluir reserva e histórico?')) return;
  const r = state.reservas.find(x=>x.id===id);
  state.reservas = state.reservas.filter(x=>x.id!==id);
  state.transacoes = state.transacoes.filter(t=>t.reserva !== (r? r.name : ''));
  saveLocal();
  renderReservations();
}

function openEditReservation(id){
  const r = state.reservas.find(x=>x.id===id); if(!r) return;
  showModal('Editar Reserva', `
    <label>Nome</label><input id="modal_r_name" class="input" value="${r.name}"/>
    <label>Meta (R$)</label><input id="modal_r_meta" type="number" class="input" value="${r.meta}"/>
    <label>Saldo Atual (R$)</label><input id="modal_r_saldo" type="number" class="input" value="${r.saldo}"/>
    <label>Observações</label><textarea id="modal_r_obs" class="input">${r.obs||''}</textarea>
  `, function(){
    r.name = document.getElementById('modal_r_name').value.trim();
    r.meta = Number(document.getElementById('modal_r_meta').value) || 0;
    r.saldo = Number(document.getElementById('modal_r_saldo').value) || 0;
    r.obs = document.getElementById('modal_r_obs').value || '';
    r.updated = nowISO();
    saveLocal();
    renderReservations();
  });
}
/* ========================= FLUXO MENSAL CHART ========================= */
  // Fluxo mensal chart
  const fluxoRes = computeFluxoMonthly(monthKey);
  el('#dash_fluxo_entries').innerText = formatMoney(fluxoRes.totalEntries || 0);
  el('#dash_fluxo_exits').innerText = formatMoney(fluxoRes.totalExits || 0);
  el('#dash_fluxo_net').innerText = formatMoney(fluxoRes.net || 0);
  el('#dash_fluxo_net').style.color = (fluxoRes.net >= 0) ? 'var(--success)' : 'var(--danger)';
  if(chartFluxMonthly){ chartFluxMonthly.destroy(); chartFluxMonthly = null; }
  try{
    const ctxF = document.getElementById('chartFluxMonthly').getContext('2d');
    chartFluxMonthly = new Chart(ctxF, {
      type:'bar',
      data:{ labels:fluxoRes.labels, datasets:[ { label:'Entradas', data:fluxoRes.entriesArr, backgroundColor:'#16a34a' }, { label:'Saídas', data:fluxoRes.exitsArr, backgroundColor:'#ef4444' } ]},
      options:{ maintainAspectRatio:false, scales:{ x:{ ticks:{ color:'#e6eef8' } }, y:{ ticks:{ color:'#e6eef8' } } }, plugins:{ legend:{ labels:{ color:'#e6eef8' } } } }
    });
  }catch(e){/*silent*/}

/* ========================= PLANEJAMENTO (DONUT) ========================= */
  // Plan small chart (donut)
  const planRes = computePlanProgress(monthKey);
  el('#dash_plan_meta').innerText = `Meta: ${formatMoney(planRes.meta || 0)}`;
  el('#dash_plan_done').innerText = `Concluído: ${formatMoney(planRes.done || 0)}`;
  const pct = Math.min(100, Math.max(0, planRes.pct || 0));
  el('#dash_plan_bar').style.width = pct + '%';
  el('#dash_plan_pct').innerText = pct + '%';
  if(chartPlan){ chartPlan.destroy(); chartPlan = null; }
  try{
    const ctxP = document.getElementById('chartPlan').getContext('2d');
    const rem = Math.max(0, (planRes.meta || 0) - (planRes.done || 0));
    chartPlan = new Chart(ctxP, { type:'doughnut', data:{ labels:['Concluído','Restante'], datasets:[{ data:[planRes.done || 0, rem], backgroundColor:['#60a5fa','#374151'] }] }, options:{ maintainAspectRatio:false, plugins:{ legend:{ display:false } } } });
  }catch(e){/*silent*/}

/* ========================= INVESTIMENTOS (COMPOSIÇÃO) ========================= */
  // Invest composition small chart
  try{
    const cats = {};
    state.investimentos.forEach(it=>{ const v = (Number(it.quantidade||0) * Number(it.preco||0)); cats[it.categoria] = (cats[it.categoria]||0) + v; });
    const labels = Object.keys(cats); const values = labels.map(l=>cats[l]);
    if(chartInvCompSmall){ chartInvCompSmall.destroy(); chartInvCompSmall = null; }
    const ctxI = document.getElementById('chartInvCompSmall') && document.getElementById('chartInvCompSmall').getContext('2d');
    if(ctxI){
      chartInvCompSmall = new Chart(ctxI, { type:'doughnut', data:{ labels: labels.length?labels:['Sem dados'], datasets:[{ data: values.length?values:[1], backgroundColor:['#60a5fa','#1e88e5','#16a34a','#f59e0b','#ef4444'] }] }, options:{ maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color:'#e6eef8' } } } } });
    }
  }catch(e){/*silent*/}

/* ========================= RECENTES (TABELA) ========================= */
  // Recents
  const tbody = el('#dash_recent tbody'); if(!tbody) return;
  tbody.innerHTML = '';
  const recent = [].concat(state.transacoes || [], state.fluxo || []).slice(0,10);
  if(!recent.length) tbody.innerHTML = '<tr><td colspan="4" class="small">Sem registros</td></tr>';
  else {
    recent.forEach(r=>{
      const tr = document.createElement('tr');
      const dateStr = r.date ? (r.date.length===10 ? new Date(r.date+'T00:00:00').toLocaleDateString() : new Date(r.date).toLocaleDateString()) : '-';
      tr.innerHTML = `<td>${dateStr}</td><td>${r.tipo || r.type || 'mov'}</td><td>${r.reserva || r.desc || r.ativo || ''}</td><td>${formatMoney(r.valor || r.value || 0)}</td>`;
      tbody.appendChild(tr);
    });
  }
  el('#dash_updated').innerText = new Date().toLocaleString();

/* ========================= EXPORT BLOCK/TEXT ========================= */
function compileExportText(){
  const resumo = computeResumoFinanceiro(getSelectedMonthKey()||new Date().toISOString().slice(0,7));
  const topCats = computeCustoByCategory(getSelectedMonthKey()).cats || {};
  const topCatsList = Object.keys(topCats).map(k=> `${k}: ${formatMoney(topCats[k])}`).join(' • ');
  const investSummary = (state.investimentos||[]).slice(0,8).map(i => `${i.ativo} (${i.categoria}) — ${formatMoney(Number(i.quantidade||0)*Number(i.preco||0))}`).join('\n');
  const text = [
    `RESUMO FINANCEIRO — ${new Date().toLocaleDateString()}`,
    `ENTRADAS: ${formatMoney(resumo.totalEntradas)}`,
    `SAÍDAS: ${formatMoney(resumo.totalSaidas)}`,
    `RESULTADO: ${formatMoney(resumo.resultado)}`,
    `RESERVAS (total saldo): ${formatMoney(resumo.reservasTotal)}`,
    `INVESTIMENTOS (total): ${formatMoney(resumo.investimentosTotal)}`,
    `CUSTO DE VIDA (mês): ${formatMoney(computeCustoByCategory(getSelectedMonthKey()).total || 0)}`,
    `PRINCIPAIS CATEGORIAS: ${topCatsList || '—'}`,
    `INVESTIMENTOS (top 8):\n${investSummary || '—'}`,
    `\nTRANSAÇÕES RECENTES:\n${(state.transacoes||[]).slice(0,10).map(t=>`${t.date || t.date}: ${t.reserva || ''} ${t.tipo || ''} ${formatMoney(t.valor||0)}`).join('\n')}`
  ].join('\n');
  return text;
}
function exportToClipboardAndModal(){
  const txt = compileExportText();
  navigator.clipboard.writeText(txt).then(()=>{
    showModal('Exportar (Bloco de Notas) — Texto copiado', `<textarea class="input" style="height:260px">${txt}</textarea>`, null);
    alert('Resumo copiado para a área de transferência. Cole no ChatGPT para análise.');
  }).catch(()=>{ showModal('Exportar (Bloco de Notas)', `<textarea class="input" style="height:260px">${txt}</textarea>`, null); alert('Não foi possível copiar automaticamente. Abra o modal e copie manualmente.'); });
}

/* ========================= RENDER GERAL ========================= */
function renderAll(){
  reorderReservationsByDefault();
  renderReservations();
  renderInvestments();
  renderFluxo();
  renderCusto();
  renderNoteTabs();
  getMonthOptions();
  const key = getSelectedMonthKey() || new Date().toISOString().slice(0,7);
  if(state.planejamento[key]) renderPlanForMonth(key);
  renderDashboard();
  enableTouchForOnclicks();
}

/* ========================= INIT ========================= */
(function init(){
  el('#apiUrlDisplay').innerText = API_URL || '(não configurada)';
  loadLocal();
  if(!state.reservas || !state.reservas.length) createDefaultReservas();
  getMonthOptions();
  renderAll();

  el('#btnSeed').addEventListener('click', ()=>{ if(confirm('Criar reservas padrão?')) createDefaultReservas(); });
  el('#btnSyncAll').addEventListener('click', ()=>{ syncAllToDrive(); });
  el('#btnHideValues').addEventListener('click', ()=>{ state.settings.hideValues = !state.settings.hideValues; el('#btnHideValues').innerText = state.settings.hideValues ? 'Mostrar Valores' : 'Ocultar Valores'; saveLocal(); });
  el('#btnExportNotes').addEventListener('click', ()=>{ exportToClipboardAndModal(); });

  const mo = new MutationObserver(muts => { muts.forEach(m => { if(m.addedNodes && m.addedNodes.length){ m.addedNodes.forEach(node => { if(node.nodeType===1){ if(node.matches && node.matches('[onclick]')) attachTouch(node); node.querySelectorAll && node.querySelectorAll('[onclick]').forEach(elm=>attachTouch(elm)); } }); } }); });
  mo.observe(document.body, { childList:true, subtree:true });
})();

/* ========================= TOUCH SUPPORT ========================= */
function attachTouch(el){
  if(!el) return;
  try{ if(el.__touchAttached) return;
    el.addEventListener('touchstart', function onTouch(e){ e.preventDefault(); el.click(); }, {passive:false});
    el.__touchAttached = true;
  }catch(err){}
}
function enableTouchForOnclicks(){
  document.querySelectorAll('[onclick]').forEach(el => attachTouch(el));
  document.querySelectorAll('.btn, .btn-ghost, button').forEach(b=>{ if(!b.__touchAttached){ b.addEventListener('touchstart', function(e){ e.preventDefault(); b.click(); }, {passive:false}); b.__touchAttached = true; }});
}

/* ========================= DEBUG ========================= */
window._borges_state = state;
window.saveLocal = saveLocal;

</script>

</body>
</html>

<!-- ===================== DEBUG HELPERS ===================== -->
<script>
window._borges_state = state;
window.saveLocal = saveLocal;
</script>

<!-- === Google API === -->
<script src="https://apis.google.com/js/api.js"></script>

<!-- ===================== DRIVE SYNC ===================== -->
<script>
if (!state.assets) state.assets = [];
if (!state.settings) state.settings = { hideValues:false };
if (!state.settings.hidden) state.settings.hidden = {};

function toggleHideArea(area){
  state.settings.hidden[area] = !state.settings.hidden[area];
  saveLocal();
}

function toggleHideTab(tabId){
  state.settings.hidden['tab_'+tabId] = !state.settings.hidden['tab_'+tabId];
  updateTabVisibility();
  saveLocal();
}

function updateTabVisibility(){
  document.querySelectorAll('.page').forEach(p=>{
    const id = p.id;
    if(state.settings.hidden['tab_'+id]) p.style.display = 'none';
  });
  if (typeof renderAll === "function") renderAll();
}

/* ====== Ativos & Passivos ====== */

/* ====== GOOGLE DRIVE ====== */
const DRIVE_CLIENT_ID = '929006917338-i9ucbhout981fjje6e6n7njs8kdpk9h7.apps.googleusercontent.com';
const DRIVE_FILE_NAME = 'borges_panel_sync.json';
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';
const AUTO_CREATE_BACKUP_BEFORE_UPDATE = true;
const BACKUP_PREFIX = 'borges_panel_backup_';

let gapiInited = false;
let authInstance = null;

function initGAPI(){
  return new Promise((resolve,reject)=>{
    if(gapiInited) return resolve();
    gapi.load('client:auth2', async ()=>{
      try{
        await gapi.client.init({ clientId: DRIVE_CLIENT_ID, scope: DRIVE_SCOPE });
        authInstance = gapi.auth2.getAuthInstance();
        gapiInited = true;
        resolve();
      }catch(e){ reject(e); }
    });
  });
}

async function isSignedIn(){
  try{ await initGAPI(); return authInstance.isSignedIn.get(); }
  catch(e){ return false; }
}

async function signInDrive(){
  try{
    await initGAPI();
    await authInstance.signIn();
    showDriveStatus('Conectado');
    await downloadFromDriveIfExists();
  }catch(e){
    alert('Erro ao conectar ao Google Drive');
  }
}

function signOutDrive(){
  if(authInstance) authInstance.signOut();
  showDriveStatus('Desconectado');
}

function showDriveStatus(t){
  const el = document.getElementById('driveStatus');
  if(el) el.innerText = t;
}

async function findDriveFileByName(name){
  await initGAPI();
  const q = `name='${name.replace(/'/g,"\\'")}' and trashed=false`;
  const r = await gapi.client.drive.files.list({
    q, fields:'files(id,name,modifiedTime)'
  });
  return r.result.files?.[0] || null;
}

async function downloadDriveFile(id){
  await initGAPI();
  const r = await gapi.client.drive.files.get({ fileId:id, alt:'media' });
  try { return JSON.parse(r.body); } catch{ return r.result; }
}

async function createDriveFile(name, content){
  await initGAPI();
  const boundary = '-------31415926535';
  const body =
`--${boundary}
Content-Type: application/json

{"name":"${name}","mimeType":"application/json"}
--${boundary}
Content-Type: application/json

${JSON.stringify(content)}
--${boundary}--`;

  const r = await gapi.client.request({
    path:'/upload/drive/v3/files',
    method:'POST',
    params:{ uploadType:'multipart' },
    headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
    body
  });

  return r.result;
}

async function updateDriveFile(id, content){
  await initGAPI();
  const boundary = '-------31415926535';
  const body =
`--${boundary}
Content-Type: application/json

{"name":"${DRIVE_FILE_NAME}"}
--${boundary}
Content-Type: application/json

${JSON.stringify(content)}
--${boundary}--`;

  const r = await gapi.client.request({
    path:`/upload/drive/v3/files/${id}`,
    method:'PATCH',
    params:{ uploadType:'multipart' },
    headers:{ 'Content-Type':`multipart/related; boundary=${boundary}` },
    body
  });

  return r.result;
}

async function downloadFromDriveIfExists(){
  if(!await isSignedIn()) return;
  showDriveStatus('Sincronizando...');
  const file = await findDriveFileByName(DRIVE_FILE_NAME);
  if(!file) return;

  state = Object.assign({}, state, await downloadDriveFile(file.id));
  saveLocal();
  showDriveStatus('Dados carregados');
}

async function uploadStateToDrive(){
  if(!await isSignedIn()) return;
  const payload = Object.assign({}, state);

  const file = await findDriveFileByName(DRIVE_FILE_NAME);
  if(!file){
    await createDriveFile(DRIVE_FILE_NAME, payload);
    showDriveStatus('Criado');
  } else {
    if(AUTO_CREATE_BACKUP_BEFORE_UPDATE){
      await createDriveFile(BACKUP_PREFIX + new Date().toISOString().replace(/[:.]/g,'-') + '.json', payload);
    }
    await updateDriveFile(file.id, payload);
    showDriveStatus('Atualizado');
  }
}

(function autoHook(){
  const original = saveLocal;
  window.saveLocal = function(){
    original();
    setTimeout(()=>uploadStateToDrive(),600);
  };
})();

function attachDriveControls(a,b,c,d){
  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById(a).onclick = signInDrive;
    document.getElementById(b).onclick = signOutDrive;
    document.getElementById(c).onclick = uploadStateToDrive;
    document.getElementById(d).innerText = 'Desconectado';
  });
}

window.driveSync = {
  initGAPI, signInDrive, signOutDrive,
  uploadStateToDrive, downloadFromDriveIfExists,
  attachDriveControls
};
</script>

<!-- ===================== ENHANCEMENTS (OCULTAR E NOVA ABA) ===================== -->
<script src="enhancements.js"></script>

</body>
</html>


  
