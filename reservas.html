<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motor Inteligente de Reservas</title>

<style>
/* ==========================
   ESTILO GERAL â€” MOBILE FIRST
========================== */

body {
  font-family: Arial, sans-serif;
  background: #0f1220;
  color: #eaeaf0;
  margin: 0;
  padding: 16px;
}

h1, h2, h3 {
  margin: 8px 0;
}

.card {
  background: #1b1f3b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  background: #4f7cff;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

button.danger {
  background: #ff4f4f;
}

button.secondary {
  background: #2a2f55;
}

textarea, input, select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 6px;
  border: none;
  background: #2a2f55;
  color: #fff;
}

small {
  color: #aaa;
}

.log {
  background: #0b0e1a;
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
  margin-top: 10px;
  white-space: pre-wrap;
}

/* RESERVAS */
.reserve {
  display: flex;
  justify-content: space-between;
  margin: 6px 0;
  font-size: 14px;
}
</style>
</head>

<body>

<h1>ðŸ§  Motor Inteligente de Reservas</h1>

<!-- ==========================
     IMPORTAÃ‡ÃƒO DO JSON
========================== -->

<div class="card">
  <h2>ðŸ“‚ Importar Sistema</h2>

  <input type="file" id="fileInput" accept=".json">
  <button onclick="loadFromFile()">Carregar arquivo JSON</button>

  <h3>Ou cole o JSON</h3>
  <textarea id="jsonInput" rows="8"></textarea>
  <button class="secondary" onclick="loadFromTextarea()">Validar & Integrar</button>
</div>

<!-- ==========================
     STATUS DO SISTEMA
========================== -->

<div class="card">
  <h2>ðŸ“Š Status</h2>
  <div id="status">Nenhum sistema carregado</div>
</div>

<!-- ==========================
     RESERVAS
========================== -->

<div class="card">
  <h2>ðŸ’° Reservas</h2>
  <div id="reservesList"></div>
</div>

<!-- ==========================
     SAQUE INTELIGENTE
========================== -->

<div class="card">
  <h2>ðŸ”˜ Solicitar Saque</h2>

  <label>Reserva</label>
  <select id="withdrawReserve"></select>

  <label>Valor</label>
  <input type="number" id="withdrawValue">

  <label>Motivo</label>
  <select id="withdrawReason">
    <option value="emergencia">EmergÃªncia</option>
    <option value="renda">Renda</option>
    <option value="saude">SaÃºde</option>
    <option value="lazer">Lazer</option>
    <option value="outro">Outro</option>
  </select>

  <button onclick="requestWithdraw()">Solicitar</button>

  <div class="log" id="log"></div>
</div>

<script>
/* ==========================
   ESTADO GLOBAL
========================== */

let SYSTEM = null;

/* ==========================
   FUNÃ‡Ã•ES DE CARGA
========================== */

function loadFromFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return alert("Selecione um arquivo.");

  const reader = new FileReader();
  reader.onload = e => parseSystem(e.target.result);
  reader.readAsText(file);
}

function loadFromTextarea() {
  const text = document.getElementById('jsonInput').value;
  parseSystem(text);
}

function parseSystem(jsonText) {
  try {
    const data = JSON.parse(jsonText);
    validateSystem(data);
    SYSTEM = data;
    renderSystem();
    log("âœ… Sistema carregado com sucesso.");
  } catch (e) {
    alert("Erro no JSON: " + e.message);
  }
}

/* ==========================
   VALIDAÃ‡ÃƒO
========================== */

function validateSystem(data) {
  if (!data.reserves || !Array.isArray(data.reserves)) {
    throw new Error("Estrutura invÃ¡lida: reserves");
  }

  data.reserves.forEach(r => {
    if (r.balance < 0) throw new Error("Saldo negativo em " + r.name);
    if (r.floor > r.balance) {
      console.warn("Piso maior que saldo em " + r.name);
    }
  });
}

/* ==========================
   RENDERIZAÃ‡ÃƒO
========================== */

function renderSystem() {
  document.getElementById('status').innerText =
    `Modo: ${SYSTEM.meta?.mode || 'normal'} | Ãšltima atualizaÃ§Ã£o: ${SYSTEM.meta?.lastUpdate || '-'}`;

  const list = document.getElementById('reservesList');
  list.innerHTML = '';

  const select = document.getElementById('withdrawReserve');
  select.innerHTML = '';

  SYSTEM.reserves.forEach(r => {
    const div = document.createElement('div');
    div.className = 'reserve';
    div.innerHTML = `<span>${r.name}</span><strong>R$ ${r.balance.toFixed(2)}</strong>`;
    list.appendChild(div);

    const opt = document.createElement('option');
    opt.value = r.id;
    opt.textContent = r.name;
    select.appendChild(opt);
  });
}

/* ==========================
   MOTOR DE SAQUE
========================== */

function requestWithdraw() {
  const reserveId = document.getElementById('withdrawReserve').value;
  const value = parseFloat(document.getElementById('withdrawValue').value);
  const reason = document.getElementById('withdrawReason').value;

  if (!value || value <= 0) return log("âŒ Valor invÃ¡lido.");

  const reserve = SYSTEM.reserves.find(r => r.id === reserveId);
  if (!reserve) return;

  // Regra: saldo suficiente
  if (reserve.balance - value < 0) {
    return log("âŒ Saldo insuficiente.");
  }

  // Regra: piso mÃ­nimo
  if (reserve.floor !== undefined && reserve.balance - value < reserve.floor) {
    return log(`âŒ Saque bloqueado: quebra o piso mÃ­nimo de ${reserve.name}.`);
  }

  // Regra: lazer em modo defensivo
  if (SYSTEM.meta?.mode === "defensivo" && reason === "lazer") {
    return log("âŒ Modo defensivo ativo. Lazer bloqueado.");
  }

  // Regra: bloqueios especÃ­ficos
  if (reserve.blockedFor?.includes(reason)) {
    return log(`âŒ Motivo "${reason}" nÃ£o permitido nessa reserva.`);
  }

  // EXECUTA
  reserve.balance -= value;
  SYSTEM.meta.lastUpdate = new Date().toISOString().slice(0,10);

  renderSystem();
  log(`âœ… Saque aprovado. Novo saldo: R$ ${reserve.balance.toFixed(2)}`);
}

/* ==========================
   LOG
========================== */

function log(msg) {
  document.getElementById('log').innerText = msg;
}
</script>

</body>
</html>
